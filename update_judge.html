<!DOCTYPE html>
<html lang="dv" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zaad Royal V25 (Ultra Edition)</title>
    <style>
        /* =========================================
           1. PREMIUM ASSETS & FONTS
           ========================================= */
        /* Ensure 'fonts' folder exists with these files */
        @font-face { font-family: 'Faruma'; src: url('fonts/af_faruma.ttf'); display: swap; }
        @font-face { font-family: 'Madina'; src: url('fonts/MADDINA.ttf'); display: swap; }
        
        :root {
            /* ROYAL PALETTE */
            --gold-primary: #FFD700;
            --gold-shine: #FFF8DC;
            --gold-shadow: #B8860B;
            --royal-blue: #001a33;
            --deep-black: #050505;
            --glass-bg: rgba(10, 25, 45, 0.85);
            --glass-border: 1px solid rgba(255, 215, 0, 0.3);
            --neon-accent: #00ff88;
            --danger: #ff3333;
            
            /* SIZES */
            --radius-lg: 20px;
            --radius-md: 12px;
        }

        * { box-sizing: border-box; outline: none; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; height: 100vh; overflow: hidden;
            background: radial-gradient(circle at 50% 30%, #002b4d 0%, #000 90%);
            font-family: 'Faruma', sans-serif;
            color: #fff;
            transition: background 1s ease;
        }

        /* =========================================
           2. ULTRA UI COMPONENTS
           ========================================= */
        /* Views System */
        .view { display: none; width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 10; opacity: 0; transition: opacity 0.5s; }
        .view.active { display: flex; opacity: 1; z-index: 20; }
        
        /* Flex Utils */
        .flex-center { display: flex; justify-content: center; align-items: center; }
        .flex-col { display: flex; flex-direction: column; }
        .flex-row { display: flex; flex-direction: row; }
        
        /* Glass Card */
        .royal-card {
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 2px solid var(--gold-shadow);
            border-top: 2px solid var(--gold-primary);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5), inset 0 0 20px rgba(255,215,0,0.05);
            border-radius: var(--radius-lg);
            padding: 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        /* Inputs */
        .input-group { margin-bottom: 20px; text-align: right; }
        .input-label { font-size: 14px; color: var(--gold-primary); margin-bottom: 8px; display: block; }
        
        input, select, textarea {
            width: 100%; padding: 15px;
            background: rgba(0,0,0,0.4);
            border: 1px solid #333;
            border-bottom: 2px solid var(--gold-shadow);
            color: #fff; font-family: inherit; font-size: 16px;
            border-radius: var(--radius-md);
            transition: 0.3s;
        }
        input:focus { border-color: var(--gold-primary); background: rgba(0,0,0,0.6); }

        /* Buttons */
        .btn {
            width: 100%; padding: 15px; font-weight: bold; font-size: 16px;
            border: none; border-radius: var(--radius-md); cursor: pointer;
            text-transform: uppercase; letter-spacing: 1px;
            transition: all 0.2s; position: relative; overflow: hidden;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,0,0,0.4); }
        .btn:active { transform: scale(0.98); }
        
        .btn-gold { 
            background: linear-gradient(135deg, var(--gold-shadow), var(--gold-primary)); 
            color: #000; 
        }
        .btn-glass { 
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #fff; 
        }
        .btn-danger { background: linear-gradient(135deg, #800, #f00); color: #fff; }
        .btn-success { background: linear-gradient(135deg, #050, #0f0); color: #fff; text-shadow: 0 1px 2px #000; }

        /* =========================================
           3. DASHBOARD LAYOUTS
           ========================================= */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 280px 1fr 320px;
            gap: 20px; padding: 20px;
            width: 100%; height: 100%;
        }

        .panel {
            background: rgba(10, 20, 35, 0.8);
            border: 1px solid #333;
            border-radius: var(--radius-lg);
            display: flex; flex-direction: column;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .panel-header {
            padding: 15px; background: rgba(0,0,0,0.3);
            border-bottom: 1px solid var(--gold-shadow);
            color: var(--gold-primary); font-weight: bold;
            display: flex; justify-content: space-between; align-items: center;
        }
        .panel-body { padding: 15px; flex: 1; overflow-y: auto; }

        /* Lists */
        .list-item {
            padding: 12px; margin-bottom: 5px;
            background: rgba(255,255,255,0.03);
            border-radius: 8px; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
            transition: 0.2s; border-left: 3px solid transparent;
        }
        .list-item:hover { background: rgba(255,215,0,0.1); padding-right: 15px; }
        .list-item.active { 
            background: linear-gradient(90deg, rgba(255,215,0,0.2), transparent);
            border-left-color: var(--gold-primary);
            color: var(--gold-primary);
        }

        /* =========================================
           4. JUDGE & SCREEN SPECIFIC
           ========================================= */
        .q-display {
            background: #fff; color: #000;
            padding: 20px; margin-bottom: 15px;
            border-radius: 10px; border-right: 6px solid var(--gold-primary);
            font-family: 'Madina', serif; font-size: 24px; direction: rtl; text-align: right;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            line-height: 2;
        }
        
        .score-input-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .score-box { text-align: center; }
        .score-box input { font-size: 24px; font-weight: bold; text-align: center; color: var(--gold-primary); }

        /* Modal */
        .modal-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.9); z-index: 1000;
            display: none; justify-content: center; align-items: center;
        }
        .modal-box { width: 600px; max-width: 95%; max-height: 90vh; overflow-y: auto; }

    </style>
</head>
<body>

    <div id="view-login" class="view active flex-center">
        <div class="royal-card">
            <div style="margin-bottom: 20px; font-size: 50px;">üëë</div>
            <h1 style="margin: 0; color: var(--gold-primary); text-shadow: 0 0 10px var(--gold-shadow);">ZAAD ROYAL V25</h1>
            <p style="color: #aaa; margin-bottom: 30px; letter-spacing: 2px;">ULTRA EDITION</p>
            
            <div class="input-group">
                <select id="loginRole">
                    <option value="admin">Admin Controller</option>
                    <option value="judge">Judge Panel</option>
                </select>
            </div>
            <div class="input-group">
                <input type="password" id="loginPass" placeholder="Enter Password" style="direction: ltr;">
            </div>
            <button onclick="App.login()" class="btn btn-gold">ACCESS SYSTEM</button>
        </div>
    </div>

    <div id="view-admin" class="view">
        <div class="dashboard-grid">
            
            <div class="panel">
                <div class="panel-header">
                    <span>üë• PARTICIPANTS</span>
                    <button onclick="App.openModal('modal-data')" style="background:none; border:none; color:var(--neon-accent); cursor:pointer;">üìÇ DATA</button>
                </div>
                <div class="panel-body">
                    <input type="text" placeholder="Search Student..." onkeyup="App.filterStudents(this.value)" style="margin-bottom:10px;">
                    <div id="admin-stu-list"></div>
                </div>
            </div>

            <div class="flex-col" style="gap: 20px;">
                <div class="royal-card" style="padding: 20px; display:flex; justify-content:space-between; align-items:center;">
                    <div style="text-align: right;">
                        <h2 style="margin:0; color:var(--gold-primary);">CONTROL ROOM</h2>
                        <small style="color:#aaa;">Broadcast Active</small>
                    </div>
                    <button onclick="location.reload()" class="btn btn-danger" style="width:auto; padding: 5px 15px; font-size: 12px;">LOGOUT</button>
                </div>

                <div class="panel" style="text-align: center; border-color: var(--gold-primary); background: rgba(255,215,0,0.05);">
                    <div class="panel-body">
                        <small style="color: #aaa; text-transform: uppercase; letter-spacing: 2px;">Current Student</small>
                        <h1 id="ctrl-stu-name" style="margin: 10px 0; color: var(--gold-primary); font-size: 32px;">No Selection</h1>
                        <h3 id="ctrl-stu-reg" style="margin: 0; color: #fff;">---</h3>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-header">üì° SCREEN COMMANDS</div>
                    <div class="panel-body">
                        <div class="flex-row" style="gap: 10px; margin-bottom: 15px;">
                            <button onclick="App.openScreen('STUDENT')" class="btn btn-gold">OPEN STUDENT SCREEN</button>
                            <button onclick="App.openScreen('AUDIENCE')" class="btn btn-glass">OPEN AUDIENCE</button>
                        </div>
                        
                        <div style="background: rgba(0,0,0,0.4); padding: 15px; border-radius: 10px; border: 1px solid #444;">
                            <label style="color:#aaa; font-size:12px;">THEME ENGINE</label>
                            <div class="flex-row" style="align-items: center; gap: 10px; margin-top: 5px;">
                                <button onclick="App.changeTheme(-1)" class="btn btn-glass" style="width: 50px;">‚óÄ</button>
                                <div style="flex:1; text-align: center; color: var(--gold-primary); font-weight: bold;" id="theme-label">Royal Gold #1</div>
                                <button onclick="App.changeTheme(1)" class="btn btn-glass" style="width: 50px;">‚ñ∂</button>
                            </div>
                        </div>

                        <div style="margin-top: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <button onclick="App.setMode('PROFILE')" class="btn btn-glass">SHOW PROFILE</button>
                            <button onclick="App.setMode('LOTTERY')" class="btn btn-glass">START LOTTERY</button>
                        </div>

                        <div style="margin-top: 15px; padding: 10px; border: 1px dashed var(--gold-shadow); border-radius: 8px;">
                            <label class="flex-center" style="gap: 10px; cursor: pointer;">
                                <input type="checkbox" id="chk-thilawah" onchange="App.updateSettings()" style="width: 20px; margin:0;">
                                <span style="color: var(--neon-accent); font-weight: bold;">ENABLE THILAWAH MODE (Reading)</span>
                            </label>
                        </div>

                        <button onclick="App.resetStudent()" class="btn btn-danger" style="margin-top: 15px;">üîÑ NEXT STUDENT (RESET)</button>
                    </div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <span>‚ùì QUESTIONS</span>
                    <input type="number" id="pick-limit" value="3" style="width: 60px; padding: 5px; margin:0; text-align:center;">
                </div>
                <div class="panel-body">
                    <div id="admin-q-list" style="display:flex; flex-direction:column; gap:5px;"></div>
                </div>
                <div style="padding: 15px;">
                    <button onclick="App.clearHistory()" class="btn btn-glass" style="font-size: 12px; color: #aaa;">CLEAR HISTORY</button>
                </div>
            </div>
        </div>
    </div>

    <div id="view-judge" class="view">
        <div class="dashboard-grid" style="grid-template-columns: 300px 1fr;">
            <div class="panel">
                <div class="panel-header">
                    <span>STUDENT INFO</span>
                    <button onclick="location.reload()" style="background:none; border:none; color:var(--danger); cursor:pointer;">EXIT</button>
                </div>
                <div class="panel-body" style="text-align: center;">
                    <div style="width: 120px; height: 120px; background: #000; border-radius: 50%; border: 3px solid var(--gold-primary); margin: 20px auto;">
                        <span style="font-size: 50px; line-height: 110px;">üë§</span>
                    </div>
                    <h2 id="j-stu-name" style="color: var(--gold-primary); margin: 10px 0;">Waiting...</h2>
                    <h3 id="j-stu-reg">---</h3>
                </div>
            </div>

            <div class="flex-col" style="gap: 20px;">
                <div class="panel" style="flex: 2;">
                    <div class="panel-header">üìñ ACTIVE QUESTIONS (FULL TEXT)</div>
                    <div class="panel-body" id="j-q-display">
                        <div style="text-align: center; padding-top: 50px; color: #aaa;">
                            Waiting for student to pick questions...
                        </div>
                    </div>
                </div>

                <div class="panel" style="flex: 1;">
                    <div class="panel-header">üìù SCORING</div>
                    <div class="panel-body">
                        <div class="score-input-grid">
                            <div class="score-box">
                                <label>Hifz (40)</label>
                                <input type="number" id="sc-hifz">
                            </div>
                            <div class="score-box">
                                <label>Tajweed (30)</label>
                                <input type="number" id="sc-taj">
                            </div>
                            <div class="score-box">
                                <label>Voice (20)</label>
                                <input type="number" id="sc-voice">
                            </div>
                            <div class="score-box">
                                <label>Makhraj (10)</label>
                                <input type="number" id="sc-mak">
                            </div>
                        </div>
                        <button onclick="alert('Score Saved Successfully!')" class="btn btn-gold" style="margin-top: 20px;">SUBMIT EVALUATION</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-data" class="modal-overlay">
        <div class="royal-card modal-box">
            <h2 style="color: var(--gold-primary); margin-top: 0;">DATA CENTER</h2>
            
            <div style="text-align: left; margin-bottom: 20px;">
                <label class="input-label">1. Import Questions (CSV Paste)</label>
                <textarea id="csv-input" rows="6" placeholder="ID, Surah, Ayah, Hint Text, Full Text..." style="font-family: monospace; font-size: 12px; text-align: left;"></textarea>
                <button onclick="App.importCSV()" class="btn btn-glass" style="margin-top: 10px;">PROCESS DATA</button>
            </div>

            <div style="text-align: left; margin-bottom: 20px;">
                <label class="input-label">2. Quick Add Student</label>
                <div class="flex-row" style="gap: 10px;">
                    <input type="text" id="new-reg" placeholder="Reg No">
                    <input type="text" id="new-name" placeholder="Name">
                </div>
                <button onclick="App.addStudent()" class="btn btn-success" style="margin-top: 10px;">ADD STUDENT</button>
            </div>

            <button onclick="App.closeModal('modal-data')" class="btn btn-danger">CLOSE</button>
        </div>
    </div>

    <script>
        /**
         * ZAAD ROYAL CORE ENGINE
         * Uses BroadcastChannel for instant multi-window sync.
         */
        
        class ZaadSystem {
            constructor() {
                // Initial State
                this.state = {
                    viewMode: 'STANDBY', // STANDBY, PROFILE, LOTTERY, QUESTIONS
                    activeReg: null,
                    selectedQIDs: [],
                    themeID: 1,
                    thilawahMode: false,
                    usedQuestions: JSON.parse(localStorage.getItem('zaad_used') || "[]")
                };

                // Data Store
                this.students = JSON.parse(localStorage.getItem('zaad_students') || "[]");
                this.qBank = JSON.parse(localStorage.getItem('zaad_qbank') || "[]");

                // Comms
                this.channel = new BroadcastChannel('zaad_channel');
                this.channel.onmessage = (ev) => this.handleMessage(ev.data);

                // Init
                this.init();
            }

            init() {
                // Check if already logged in (simple session check)
                // For demo, we start at login
            }

            // --- AUTH ---
            login() {
                const role = document.getElementById('loginRole').value;
                const pass = document.getElementById('loginPass').value;
                
                if((role === 'admin' && pass === 'admin123') || (role === 'judge' && pass === 'judge123')) {
                    this.role = role;
                    this.switchView(role === 'admin' ? 'view-admin' : 'view-judge');
                    if(role === 'admin') this.renderAdminList();
                    if(role === 'judge') this.syncJudgeView();
                } else {
                    alert('Access Denied: Invalid Credentials');
                }
            }

            switchView(id) {
                document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
                document.getElementById(id).classList.add('active');
            }

            // --- DATA HANDLING ---
            addStudent() {
                const reg = document.getElementById('new-reg').value;
                const name = document.getElementById('new-name').value;
                if(reg && name) {
                    this.students.push({reg, name});
                    this.saveData();
                    this.renderAdminList();
                    document.getElementById('new-reg').value = '';
                    document.getElementById('new-name').value = '';
                    alert('Student Added');
                }
            }

            importCSV() {
                const txt = document.getElementById('csv-input').value;
                if(!txt) return;
                const lines = txt.split('\n');
                const newQ = [];
                lines.forEach(l => {
                    const p = l.split(',');
                    if(p.length >= 5) {
                        newQ.push({
                            id: p[0].trim(),
                            surah: p[1].trim(),
                            ayah: p[2].trim(),
                            hint: p[3].trim(),
                            full: p.slice(4).join(',').trim()
                        });
                    }
                });
                this.qBank = newQ;
                this.saveData();
                alert(`Imported ${newQ.length} questions successfully.`);
            }

            saveData() {
                localStorage.setItem('zaad_students', JSON.stringify(this.students));
                localStorage.setItem('zaad_qbank', JSON.stringify(this.qBank));
                localStorage.setItem('zaad_used', JSON.stringify(this.state.usedQuestions));
            }

            // --- ADMIN CONTROLS ---
            renderAdminList(filter = "") {
                const container = document.getElementById('admin-stu-list');
                container.innerHTML = this.students
                    .filter(s => s.name.toLowerCase().includes(filter.toLowerCase()) || s.reg.includes(filter))
                    .map(s => `
                        <div class="list-item ${this.state.activeReg === s.reg ? 'active' : ''}" onclick="App.selectStudent('${s.reg}')">
                            <span style="font-family:monospace; font-weight:bold;">${s.reg}</span>
                            <span>${s.name}</span>
                        </div>
                    `).join('');
            }

            selectStudent(reg) {
                this.state.activeReg = reg;
                this.state.viewMode = 'STANDBY';
                this.state.selectedQIDs = [];
                this.updateAdminUI();
                this.broadcast();
            }

            updateAdminUI() {
                const stu = this.students.find(s => s.reg === this.state.activeReg);
                if(stu) {
                    document.getElementById('ctrl-stu-name').innerText = stu.name;
                    document.getElementById('ctrl-stu-reg').innerText = stu.reg;
                } else {
                    document.getElementById('ctrl-stu-name').innerText = "No Selection";
                    document.getElementById('ctrl-stu-reg').innerText = "---";
                }
                
                // Update Q List
                const qList = document.getElementById('admin-q-list');
                qList.innerHTML = this.state.selectedQIDs.map(id => {
                    const q = this.qBank.find(x => x.id == id);
                    return `<div style="background:var(--gold-primary); color:#000; padding:5px 10px; border-radius:4px; font-size:12px;">
                        <b>Q${id}</b> - ${q ? q.surah : 'Unknown'}
                    </div>`;
                }).join('');

                this.renderAdminList(); // To update active class
            }

            setMode(mode) {
                if(!this.state.activeReg) return alert('Select a student first!');
                this.state.viewMode = mode;
                this.broadcast();
            }

            updateSettings() {
                this.state.thilawahMode = document.getElementById('chk-thilawah').checked;
                this.broadcast();
            }

            resetStudent() {
                if(this.state.selectedQIDs.length > 0) {
                    this.state.usedQuestions.push(...this.state.selectedQIDs);
                    this.saveData();
                }
                this.state.activeReg = null;
                this.state.selectedQIDs = [];
                this.state.viewMode = 'STANDBY';
                this.updateAdminUI();
                this.broadcast();
            }
            
            clearHistory() {
                if(confirm("Clear all used question history?")) {
                    this.state.usedQuestions = [];
                    this.saveData();
                    alert("History Cleared");
                }
            }

            // --- THEME ENGINE ---
            changeTheme(dir) {
                let id = this.state.themeID + dir;
                if(id > 100) id = 1;
                if(id < 1) id = 100;
                this.state.themeID = id;
                document.getElementById('theme-label').innerText = `Royal Theme #${id}`;
                this.broadcast();
            }

            // --- COMMUNICATIONS ---
            broadcast() {
                this.channel.postMessage({ type: 'STATE_UPDATE', payload: this.state });
            }

            handleMessage(msg) {
                // Handled by specific windows logic below
                if(msg.type === 'PICK_QUESTION') {
                    this.handlePick(msg.id);
                }
            }
            
            handlePick(id) {
                const limit = parseInt(document.getElementById('pick-limit').value);
                if(this.state.selectedQIDs.length >= limit) return;
                if(this.state.selectedQIDs.includes(id)) return;
                
                this.state.selectedQIDs.push(id);
                this.updateAdminUI();
                
                // If limit reached, switch to Question View automatically after delay
                if(this.state.selectedQIDs.length >= limit) {
                    setTimeout(() => {
                        this.state.viewMode = 'QUESTIONS';
                        this.broadcast();
                    }, 1500);
                } else {
                    this.broadcast();
                }
            }

            // --- SCREEN OPENER ---
            openScreen(type) {
                const w = 1200; const h = 800;
                const win = window.open('', type, `width=${w},height=${h}`);
                
                // INJECT SCREEN CODE
                const screenHTML = `
                <!DOCTYPE html>
                <html lang="dv" dir="rtl">
                <head>
                    <title>${type} Screen</title>
                    <style>
                        @font-face { font-family: 'Faruma'; src: 'fonts/af_faruma.ttf'; }
                        @font-face { font-family: 'Madina'; src: 'fonts/MADDINA.ttf'; }
                        body { 
                            margin:0; overflow:hidden; 
                            background: #000; color: #fff; font-family: 'Faruma';
                            display: flex; justify-content: center; align-items: center;
                            height: 100vh; transition: background 0.8s;
                        }
                        
                        /* Dynamic Theme Vars */
                        :root { --t-col: #FFD700; --t-bg: #000; }
                        
                        .frame {
                            width: 90%; height: 90%;
                            border: 10px solid var(--t-col);
                            border-radius: 30px;
                            box-shadow: 0 0 80px var(--t-col), inset 0 0 50px rgba(0,0,0,0.8);
                            background: rgba(0,0,0,0.7);
                            backdrop-filter: blur(10px);
                            display: flex; flex-direction: column; justify-content: center; align-items: center;
                            position: relative;
                        }
                        
                        /* LOTTERY GRID */
                        .grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; max-width: 1200px; padding: 20px; }
                        .box {
                            width: 110px; height: 110px;
                            border: 2px solid var(--t-col);
                            color: var(--t-col);
                            font-size: 40px; font-weight: bold;
                            display: flex; justify-content: center; align-items: center;
                            cursor: pointer; border-radius: 15px;
                            transition: 0.3s; background: rgba(255,255,255,0.05);
                        }
                        .box:hover { background: var(--t-col); color: #000; transform: scale(1.1); }
                        .box.picked { background: var(--t-col); color: #000; transform: scale(0); opacity: 0; pointer-events: none; }
                        .box.disabled { opacity: 0.1; pointer-events: none; filter: grayscale(1); }

                        /* CARDS */
                        .card-holder { display: flex; gap: 30px; }
                        .q-card {
                            background: #fff; color: #000;
                            width: 450px; min-height: 600px;
                            border-radius: 20px;
                            border: 8px solid var(--t-col);
                            padding: 30px;
                            display: flex; flex-direction: column;
                            box-shadow: 0 20px 60px rgba(0,0,0,0.6);
                            animation: slideUp 0.8s ease-out;
                        }
                        .q-content {
                            flex: 1; display: flex; justify-content: center; align-items: center;
                            text-align: center; font-family: 'Madina'; font-size: 42px; line-height: 1.8;
                        }
                        .blur { filter: blur(15px); cursor: pointer; transition: 0.5s; user-select: none; }
                        .revealed { filter: blur(0); }
                        
                        @keyframes slideUp { from { transform: translateY(100px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
                    </style>
                </head>
                <body>
                    <div id="app" class="frame"><h1>CONNECTING...</h1></div>
                    <script>
                        const channel = new BroadcastChannel('zaad_channel');
                        let qBank = JSON.parse(localStorage.getItem('zaad_qbank') || "[]");
                        
                        channel.onmessage = (ev) => {
                            if(ev.data.type === 'STATE_UPDATE') render(ev.data.payload);
                        };

                        // Initial Sync
                        const raw = localStorage.getItem('zaad_state'); // Fallback if no broadcast immediately
                        // Better approach: Ask for state? Or just wait.

                        function render(state) {
                            applyTheme(state.themeID);
                            const app = document.getElementById('app');
                            
                            if(state.viewMode === 'STANDBY') {
                                app.innerHTML = '<img src="https://academyzaad.com/photos/logo.png" width="200"><h1 style="font-size:60px; margin-top:30px; color:#fff;">WAITING...</h1>';
                            }
                            else if(state.viewMode === 'PROFILE') {
                                const stu = JSON.parse(localStorage.getItem('zaad_students')).find(s => s.reg === state.activeReg);
                                if(stu) {
                                    app.innerHTML = '<h1 style="font-size:90px; margin:0; text-shadow:0 0 20px var(--t-col);">'+stu.name+'</h1><h2 style="font-size:50px; color:var(--t-col);">'+stu.reg+'</h2>';
                                }
                            }
                            else if(state.viewMode === 'LOTTERY') {
                                let html = '<div class="grid">';
                                // Generate 20 placeholder IDs if qBank empty
                                const list = qBank.length ? qBank : Array.from({length:20},(_,i)=>({id:i+1}));
                                
                                list.forEach(q => {
                                    let cls = 'box';
                                    if(state.usedQuestions.includes(q.id)) cls += ' disabled';
                                    if(state.selectedQIDs.includes(q.id)) cls += ' picked';
                                    html += '<div class="'+cls+'" onclick="pick(\\''+q.id+'\\')">'+q.id+'</div>';
                                });
                                html += '</div>';
                                app.innerHTML = html;
                            }
                            else if(state.viewMode === 'QUESTIONS') {
                                let html = '<div class="card-holder">';
                                state.selectedQIDs.forEach(id => {
                                    const q = qBank.find(x => x.id == id);
                                    if(q) {
                                        html += '<div class="q-card">';
                                        html += '<div style="border-bottom:1px solid #ccc; padding-bottom:10px; color:#888; font-size:18px;">Surah '+q.surah+' : '+q.ayah+'</div>';
                                        
                                        // LOGIC: THILAWAH vs HIFZ
                                        if(state.thilawahMode) {
                                            html += '<div class="q-content blur" onclick="this.classList.toggle(\\'revealed\\')">'+q.full+'</div>';
                                            html += '<div style="color:red; font-size:12px; text-align:center;">(Reading Mode: Tap to Reveal)</div>';
                                        } else {
                                            html += '<div class="q-content">'+q.hint+' ...</div>';
                                            html += '<div style="color:green; font-size:12px; text-align:center;">(Memorization Mode: Hint Only)</div>';
                                        }
                                        html += '</div>';
                                    }
                                });
                                html += '</div>';
                                app.innerHTML = html;
                            }
                        }

                        function applyTheme(id) {
                            // High Quality Procedural Theme Generator
                            const hue = (id * 137) % 360;
                            const col = 'hsl('+hue+', 80%, 60%)';
                            const bg = 'radial-gradient(circle at center, hsl('+hue+', 60%, 10%), #000)';
                            
                            document.documentElement.style.setProperty('--t-col', col);
                            document.body.style.background = bg;
                        }

                        window.pick = (id) => {
                            channel.postMessage({ type: 'PICK_QUESTION', id: id });
                        };
                    <\/script>
                </body>
                </html>
                `;
                win.document.write(screenHTML);
            }
            
            // --- MODALS ---
            openModal(id) { document.getElementById(id).style.display = 'flex'; }
            closeModal(id) { document.getElementById(id).style.display = 'none'; }
            
            // --- JUDGE SYNC ---
            syncJudgeView() {
                // Listen to broadcast to update Judge View
                this.channel.onmessage = (ev) => {
                    if(ev.data.type === 'STATE_UPDATE') {
                        const s = ev.data.payload;
                        const stu = this.students.find(x => x.reg === s.activeReg);
                        
                        // Update Info
                        if(stu) {
                            document.getElementById('j-stu-name').innerText = stu.name;
                            document.getElementById('j-stu-reg').innerText = stu.reg;
                        } else {
                            document.getElementById('j-stu-name').innerText = "Waiting...";
                        }
                        
                        // Update Questions (Always show full text to Judge)
                        const qContainer = document.getElementById('j-q-display');
                        if(s.selectedQIDs.length > 0) {
                            qContainer.innerHTML = s.selectedQIDs.map(id => {
                                const q = this.qBank.find(x => x.id == id);
                                return `
                                    <div class="q-display">
                                        <div style="font-size:14px; color:#666; margin-bottom:5px; border-bottom:1px solid #eee;">Q${id} | ${q.surah}</div>
                                        ${q.full}
                                    </div>
                                `;
                            }).join('');
                        } else {
                            qContainer.innerHTML = '<div style="text-align:center; padding-top:50px; color:#aaa;">Waiting for selection...</div>';
                        }
                    }
                };
            }
        }

        // INIT APP
        const App = new ZaadSystem();

        // Admin Filter Helper
        App.filterStudents = function(val) {
            this.renderAdminList(val);
        }

    </script>
</body>
</html>
