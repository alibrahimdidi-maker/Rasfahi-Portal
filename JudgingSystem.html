<!DOCTYPE html>
<html lang="dv" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Royal Judge Ultimate - Full Profile Edition</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Noto+Sans+Thaana:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            --gold: #d4af37;
            --dark: #0f0f0f;
            --panel: #1a1a1a;
            --green: #064e3b;
        }

        body {
            font-family: 'Noto Sans Thaana', 'Amiri', sans-serif;
            background-color: var(--dark);
            color: #eee;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Header */
        header {
            background: linear-gradient(to right, #000, var(--green));
            border-bottom: 2px solid var(--gold);
            padding: 10px 20px;
            display: flex; justify-content: space-between; align-items: center;
        }

        /* Layout */
        .main-container { display: flex; flex: 1; overflow: hidden; }
        
        .sidebar {
            width: 260px; background: #111; border-left: 1px solid #333;
            display: flex; flex-direction: column; padding: 10px; gap: 5px;
        }
        
        .nav-btn {
            padding: 12px; border-radius: 6px; cursor: pointer; color: #888; text-align: right;
            border: 1px solid transparent; transition: 0.2s;
        }
        .nav-btn:hover { background: #222; color: var(--gold); }
        .nav-btn.active { background: var(--green); color: white; border-right: 4px solid var(--gold); font-weight: bold; }

        .content { flex: 1; padding: 20px; overflow-y: auto; background: #141414; }
        .section { display: none; animation: fadeIn 0.3s; }
        .section.active { display: block; }
        @keyframes fadeIn { from{opacity:0;transform:translateY(5px)} to{opacity:1;transform:translateY(0)} }

        /* Cards */
        .card {
            background: var(--panel); border: 1px solid #333; border-radius: 8px;
            padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.5);
        }
        .gold-text { color: var(--gold); text-shadow: 0 1px 1px black; }
        
        button { transition: 0.2s; }
        .btn-gold { background: var(--gold); color: black; font-weight: bold; padding: 8px 16px; border-radius: 4px; }
        .btn-gold:hover { background: white; }
        
        /* SEARCH BAR STYLES */
        .search-container {
            position: relative;
            margin-bottom: 20px;
        }
        .search-input {
            width: 100%;
            background: #000;
            border: 2px solid var(--gold);
            color: white;
            padding: 15px;
            font-size: 1.2rem;
            border-radius: 8px;
            padding-left: 50px; /* For Icon */
            text-align: right;
        }
        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gold);
            font-size: 1.2rem;
        }
        .search-results {
            position: absolute;
            top: 100%; left: 0; right: 0;
            background: #222;
            border: 1px solid #444;
            max-height: 300px;
            overflow-y: auto;
            z-index: 100;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.8);
        }
        .result-item {
            padding: 10px 15px;
            border-bottom: 1px solid #333;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .result-item:hover { background: var(--green); }

        /* STUDENT PROFILE CARD (NEW) */
        .profile-card {
            display: flex;
            gap: 20px;
            background: #000;
            border: 1px solid #444;
            border-top: 3px solid var(--gold);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            align-items: flex-start;
        }
        .profile-photo {
            width: 130px;
            height: 150px;
            background: #111;
            border: 2px solid #555;
            border-radius: 6px;
            overflow: hidden;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .profile-photo img {
            width: 100%; height: 100%; object-fit: cover;
        }
        .profile-details {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            text-align: right;
        }
        .detail-group label {
            display: block;
            font-size: 0.7rem;
            color: #888;
            text-transform: uppercase;
            margin-bottom: 2px;
        }
        .detail-group div {
            font-size: 1.1rem;
            font-weight: bold;
            color: white;
            border-bottom: 1px solid #333;
            padding-bottom: 2px;
        }
        .full-width { grid-column: span 2; }

        /* Rubric Table */
        .rubric-table { width: 100%; border-collapse: separate; border-spacing: 0 10px; }
        .rubric-row { background: #222; border-radius: 8px; overflow: hidden; }
        .rubric-cell { padding: 15px; vertical-align: middle; border-top: 1px solid #333; border-bottom: 1px solid #333; }
        .rubric-row td:first-child { border-left: 1px solid #333; border-radius: 0 8px 8px 0; border-right: 4px solid var(--gold); }
        .rubric-row td:last-child { border-right: 1px solid #333; border-radius: 8px 0 0 8px; }
        
        .deduct-btn {
            background: #333; border: 1px solid #555; color: #aaa; width: 50px; height: 40px;
            border-radius: 4px; font-weight: bold; font-size: 0.8rem; margin: 0 2px;
        }
        .deduct-btn:hover { background: #7f1d1d; color: white; border-color: red; }
        .score-display {
            background: black; color: var(--gold); font-size: 1.5rem; font-weight: bold;
            width: 70px; text-align: center; padding: 5px; border-radius: 5px; border: 1px solid var(--gold);
        }

    </style>
</head>
<body>

    <header>
        <div class="flex items-center gap-3">
            <i class="fa-solid fa-medal text-3xl text-yellow-500"></i>
            <div>
                <h1 class="text-xl font-bold gold-text">Royal Judging System</h1>
                <div class="text-xs text-gray-400">Ultimate Profile Edition</div>
            </div>
        </div>
        <div class="flex gap-4 items-center">
            <select id="comp-mode" onchange="changeMode()" class="bg-gray-900 border-yellow-600 text-yellow-500 font-bold p-1">
                <option value="quran">Quran (Hifz/Thilawa)</option>
                <option value="madhaha">Madhaha</option>
                <option value="speech">Speech</option>
                <option value="lhen">Lhen</option>
                <option value="quiz">Quiz</option>
            </select>
            <button onclick="saveData()" class="btn-gold text-sm"><i class="fa-solid fa-save"></i> Save</button>
        </div>
    </header>

    <div class="main-container">
        <nav class="sidebar">
            <div class="nav-btn active" onclick="nav('setup')"><i class="fa-solid fa-sliders"></i> Configuration</div>
            <div class="nav-btn" onclick="nav('judging')"><i class="fa-solid fa-gavel"></i> Judging Panel</div>
            <div class="nav-btn" onclick="nav('results')"><i class="fa-solid fa-list-check"></i> Results</div>
            
            <div class="mt-auto p-4 border-t border-gray-800">
                <button onclick="exportBulkPDF()" class="w-full bg-red-900 text-white py-2 rounded mb-2 hover:bg-red-800">
                    <i class="fa-solid fa-file-pdf"></i> PDF Export
                </button>
            </div>
        </nav>

        <main class="content">

            <div id="setup" class="section active">
                <div class="card">
                    <h2 class="text-xl gold-text mb-4">1. Import Participants Data</h2>
                    <div class="bg-black p-4 rounded border border-gray-700">
                        <p class="text-gray-400 text-sm mb-2">Upload CSV. Headers needed: <b>ID, Name</b>. Optional: Address, RegNo, Photo, Category, Branch.</p>
                        <input type="file" id="file-students" accept=".csv" class="w-full text-sm bg-gray-800 text-white p-2 rounded">
                        <button onclick="loadCSV()" class="mt-2 bg-gray-700 text-white px-4 py-1 rounded text-sm hover:bg-gray-600">Load Data</button>
                        <span id="st-status" class="text-green-500 text-xs ml-2"></span>
                    </div>
                </div>

                <div class="card">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl gold-text">2. Rubric Configuration: <span id="lbl-mode" class="text-white">Quran</span></h2>
                        <button onclick="addCriteria()" class="bg-green-700 text-white px-3 py-1 rounded text-sm">+ Add Criteria</button>
                    </div>
                    <div id="rubric-config-container" class="space-y-2"></div>
                    <div class="mt-4 flex justify-between">
                         <button onclick="restoreDefaults()" class="text-xs text-red-400 underline">Restore Defaults</button>
                         <div class="text-xl font-bold">Total: <span id="config-total" class="gold-text">100</span></div>
                    </div>
                </div>
            </div>

            <div id="judging" class="section">
                
                <div class="search-container">
                    <i class="fa-solid fa-magnifying-glass search-icon"></i>
                    <input type="text" id="search-box" class="search-input" placeholder="Search by Name or ID..." onkeyup="filterStudents()">
                    <div id="search-results" class="search-results hidden"></div>
                </div>

                <div id="profile-container" class="profile-card hidden">
                    <div class="profile-photo">
                        <img id="p-img" src="" alt="Student" class="hidden">
                        <i id="p-icon" class="fa-solid fa-user text-6xl text-gray-600"></i>
                    </div>
                    
                    <div class="profile-details">
                        <div class="detail-group full-width">
                            <label>Full Name / ފުރިހަމަ ނަން</label>
                            <div id="p-name" class="text-yellow-400 text-xl">--</div>
                        </div>

                        <div class="detail-group">
                            <label>ID Card No</label>
                            <div id="p-id">--</div>
                        </div>
                        <div class="detail-group">
                            <label>Registration No</label>
                            <div id="p-reg">--</div>
                        </div>

                        <div class="detail-group full-width">
                            <label>Permanent Address / ދާއިމީ އެޑްރެސް</label>
                            <div id="p-address" class="text-sm">--</div>
                        </div>

                        <div class="detail-group">
                            <label>Category</label>
                            <div id="p-cat">--</div>
                        </div>
                        <div class="detail-group">
                            <label>Branch / Institute</label>
                            <div id="p-branch" class="text-blue-300">--</div>
                        </div>
                    </div>
                </div>

                <div class="flex justify-between items-end mb-4">
                    <div class="flex gap-2">
                        <button onclick="setJudge(1)" id="jb-1" class="btn-gold">Judge 1</button>
                        <button onclick="setJudge(2)" id="jb-2" class="bg-gray-700 text-white px-4 py-2 rounded">Judge 2</button>
                        <button onclick="setJudge(3)" id="jb-3" class="bg-gray-700 text-white px-4 py-2 rounded">Judge 3</button>
                        <button onclick="setJudge(4)" id="jb-4" class="bg-gray-700 text-white px-4 py-2 rounded">Judge 4</button>
                        <button onclick="setJudge(5)" id="jb-5" class="bg-gray-700 text-white px-4 py-2 rounded">Judge 5</button>
                    </div>
                    <div class="text-right">
                        <div class="text-xs text-gray-500 uppercase">Live Score</div>
                        <div id="live-total" class="text-4xl font-bold gold-text">0.0</div>
                    </div>
                </div>

                <div class="card">
                    <table class="rubric-table">
                        <thead>
                            <tr>
                                <th class="text-right pl-4">Criteria</th>
                                <th class="text-center">Deductions</th>
                                <th class="text-center w-24">Score</th>
                            </tr>
                        </thead>
                        <tbody id="rubric-matrix-body"></tbody>
                    </table>

                    <div class="mt-6">
                        <label class="text-xs text-gray-500 uppercase">Comments</label>
                        <textarea id="judge-comment" class="w-full bg-black border-gray-700 text-white p-2 h-20"></textarea>
                    </div>

                    <button onclick="saveScore()" class="w-full mt-4 bg-green-700 text-white py-3 font-bold rounded hover:bg-green-600">
                        SUBMIT SCORE
                    </button>
                </div>
            </div>

            <div id="results" class="section">
                <div class="card flex justify-between items-center">
                    <h2 class="text-xl gold-text">Final Results</h2>
                    <button onclick="exportCSV()" class="bg-blue-700 text-white px-3 py-1 rounded text-sm">Download CSV</button>
                </div>
                <div class="card overflow-auto">
                    <table class="w-full text-sm text-right">
                        <thead class="bg-green-900 text-white">
                            <tr>
                                <th class="p-2">ID</th>
                                <th class="p-2">Name</th>
                                <th class="p-2">Category</th>
                                <th class="p-2">J1</th><th class="p-2">J2</th><th class="p-2">J3</th><th class="p-2">J4</th><th class="p-2">J5</th>
                                <th class="p-2">Total</th>
                            </tr>
                        </thead>
                        <tbody id="res-body"></tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <script>
        // --- CONFIG DATA ---
        const RUBRICS = {
            quran_thilawa: [
                { id: 'tajweed', name: 'Tajweed Rules', max: 20 },
                { id: 'makhraj', name: 'Makhraj', max: 20 },
                { id: 'sifa', name: 'Sifaat', max: 10 },
                { id: 'voice', name: 'Voice & Tone', max: 10 },
                { id: 'adaa', name: 'Adaa / Performance', max: 10 },
                { id: 'quality', name: 'Overall Quality', max: 30 }
            ],
            quran_hifz: [
                { id: 'hifz', name: 'Fluency / Hifz', max: 40 },
                { id: 'tajweed', name: 'Tajweed', max: 20 },
                { id: 'makhraj', name: 'Makhraj', max: 15 },
                { id: 'voice', name: 'Voice', max: 15 },
                { id: 'quality', name: 'Quality', max: 10 }
            ],
            madhaha: [{id:'v',name:'Voice',max:30}, {id:'m',name:'Melody',max:30}, {id:'p',name:'Perf',max:40}],
            speech: [{id:'c',name:'Content',max:40}, {id:'d',name:'Delivery',max:40}, {id:'l',name:'Language',max:20}],
            lhen: [{id:'m',name:'Meter',max:40}, {id:'mn',name:'Meaning',max:40}, {id:'l',name:'Lang',max:20}],
            quiz: [{id:'ans',name:'Correct Answer',max:10}]
        };

        let app = {
            mode: 'quran',
            students: [],
            scores: {},
            config: JSON.parse(JSON.stringify(RUBRICS)),
            activeStudent: null,
            currJudge: 1
        };

        // --- INIT ---
        window.onload = function() {
            const saved = localStorage.getItem('royal_judge_ultimate_db');
            if(saved) {
                const data = JSON.parse(saved);
                app.students = data.students || [];
                app.scores = data.scores || {};
                if(data.config) app.config = data.config;
            }
            changeMode();
        };

        function nav(sec) {
            document.querySelectorAll('.section').forEach(e => e.classList.remove('active'));
            document.getElementById(sec).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('active'));
            event.currentTarget.classList.add('active');
            if(sec === 'results') renderResults();
        }

        function changeMode() {
            app.mode = document.getElementById('comp-mode').value;
            document.getElementById('lbl-mode').innerText = app.mode.toUpperCase();
            renderConfigTable();
            if(app.activeStudent) renderRubricMatrix();
        }

        // --- SEARCH & PROFILE LOGIC ---
        function filterStudents() {
            const query = document.getElementById('search-box').value.toLowerCase().trim();
            const resDiv = document.getElementById('search-results');
            resDiv.innerHTML = '';
            
            if(query.length < 1) {
                resDiv.classList.add('hidden');
                return;
            }

            const matches = app.students.filter(s => {
                const n = (s.Name || s['Full Name'] || '').toLowerCase();
                const i = (s.ID || s['ID Card'] || '').toLowerCase();
                return n.includes(query) || i.includes(query);
            });

            if(matches.length > 0) {
                resDiv.classList.remove('hidden');
                matches.forEach(s => {
                    const div = document.createElement('div');
                    div.className = 'result-item';
                    div.innerHTML = `<span>${s.Name || s['Full Name']}</span> <span class="text-xs text-yellow-500">${s.ID || s['ID Card']}</span>`;
                    div.onclick = () => selectStudent(s);
                    resDiv.appendChild(div);
                });
            } else {
                resDiv.innerHTML = '<div class="p-2 text-gray-500">No matches found</div>';
                resDiv.classList.remove('hidden');
            }
        }

        function selectStudent(student) {
            app.activeStudent = student;
            document.getElementById('search-results').classList.add('hidden');
            document.getElementById('search-box').value = '';
            
            // POPULATE PROFILE CARD
            document.getElementById('profile-container').classList.remove('hidden');
            const p = student;
            
            document.getElementById('p-name').innerText = p.Name || p['Full Name'] || '--';
            document.getElementById('p-id').innerText = p.ID || p['ID Card'] || '--';
            document.getElementById('p-reg').innerText = p.RegNo || p['Registration No'] || p['Reg No'] || '--';
            document.getElementById('p-address').innerText = p.Address || p['Permanent Address'] || '--';
            document.getElementById('p-cat').innerText = p.Category || p['Age Group'] || '--';
            document.getElementById('p-branch').innerText = p.Branch || p.Institute || '--';

            // Photo Logic
            const photoUrl = p.Photo || p.PhotoURL || p.Image;
            const imgEl = document.getElementById('p-img');
            const iconEl = document.getElementById('p-icon');

            if(photoUrl && photoUrl.trim() !== '') {
                imgEl.src = photoUrl;
                imgEl.classList.remove('hidden');
                iconEl.classList.add('hidden');
            } else {
                imgEl.classList.add('hidden');
                iconEl.classList.remove('hidden');
            }

            renderRubricMatrix();
        }

        // --- RUBRIC UI ---
        function setJudge(n) {
            app.currJudge = n;
            for(let i=1; i<=5; i++) {
                const btn = document.getElementById(`jb-${i}`);
                if(i===n) { btn.className = "btn-gold"; btn.style.color = "black"; }
                else { btn.className = "bg-gray-700 text-white px-4 py-2 rounded"; btn.style.color="white"; }
            }
            renderRubricMatrix();
        }

        function renderRubricMatrix() {
            const tbody = document.getElementById('rubric-matrix-body');
            tbody.innerHTML = '';
            if(!app.activeStudent) return;

            const id = app.activeStudent.ID || app.activeStudent['ID Card'];
            
            // Determine config key
            let key = app.mode;
            if(app.mode === 'quran') {
                const branch = (app.activeStudent.Branch || "").toLowerCase();
                key = branch.includes('hifz') ? 'quran_hifz' : 'quran_thilawa';
            }
            const criteria = app.config[key];
            const saved = app.scores[id]?.[`j${app.currJudge}`] || {};

            let total = 0;

            criteria.forEach(c => {
                let val = saved[c.id] !== undefined ? saved[c.id] : c.max;
                total += parseFloat(val);

                const tr = document.createElement('tr');
                tr.className = 'rubric-row';
                tr.innerHTML = `
                    <td class="rubric-cell">
                        <div class="text-lg font-bold">${c.name}</div>
                        <div class="text-xs text-gray-500">Max: ${c.max}</div>
                    </td>
                    <td class="rubric-cell text-center">
                        <button onclick="updateVal('${c.id}', ${c.max}, ${c.max})" class="deduct-btn border-green-700 text-green-500">Reset</button>
                        <button onclick="deduct('${c.id}', ${c.max}, 0.25)" class="deduct-btn">-0.25</button>
                        <button onclick="deduct('${c.id}', ${c.max}, 0.5)" class="deduct-btn">-0.5</button>
                        <button onclick="deduct('${c.id}', ${c.max}, 1)" class="deduct-btn">-1</button>
                        <button onclick="deduct('${c.id}', ${c.max}, 5)" class="deduct-btn">-5</button>
                    </td>
                    <td class="rubric-cell text-center">
                        <div id="val-${c.id}" class="score-display mx-auto">${val}</div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            document.getElementById('live-total').innerText = total.toFixed(2);
            document.getElementById('judge-comment').value = saved.comment || "";
        }

        function deduct(cid, max, amt) {
            const el = document.getElementById(`val-${cid}`);
            let cur = parseFloat(el.innerText);
            let n = cur - amt;
            if(n < 0) n = 0;
            updateVal(cid, max, n);
        }

        function updateVal(cid, max, val) {
            const el = document.getElementById(`val-${cid}`);
            el.innerText = parseFloat(val).toFixed(2);
            el.style.color = (val < max) ? '#ef4444' : '#d4af37';
            
            // Recalc Total
            let t = 0;
            document.querySelectorAll('.score-display').forEach(d => t += parseFloat(d.innerText));
            document.getElementById('live-total').innerText = t.toFixed(2);
        }

        function saveScore() {
            if(!app.activeStudent) return;
            const id = app.activeStudent.ID || app.activeStudent['ID Card'];
            if(!app.scores[id]) app.scores[id] = {};

            let key = app.mode; 
            if(app.mode === 'quran') {
                const branch = (app.activeStudent.Branch || "").toLowerCase();
                key = branch.includes('hifz') ? 'quran_hifz' : 'quran_thilawa';
            }

            let s = { total: 0 };
            app.config[key].forEach(c => {
                const v = parseFloat(document.getElementById(`val-${c.id}`).innerText);
                s[c.id] = v;
                s.total += v;
            });
            s.comment = document.getElementById('judge-comment').value;

            app.scores[id][`j${app.currJudge}`] = s;
            saveData();
            
            // Flash Button
            const btn = document.querySelector('button[onclick="saveScore()"]');
            const old = btn.innerHTML;
            btn.innerHTML = 'SAVED!';
            setTimeout(() => btn.innerHTML = old, 1000);

            renderResults();
        }

        // --- RESULTS & EXPORT ---
        function renderResults() {
            const tb = document.getElementById('res-body');
            tb.innerHTML = '';
            app.students.forEach(s => {
                const id = s.ID || s['ID Card'];
                const sc = app.scores[id] || {};
                let t = 0, c = 0;
                let cells = '';
                for(let i=1; i<=5; i++) {
                    let v = sc[`j${i}`]?.total || 0;
                    if(v>0) { t+=v; c++; }
                    cells += `<td class="p-2 text-gray-400">${v ? v.toFixed(2) : '-'}</td>`;
                }
                const avg = (c ? t/c : 0).toFixed(2);
                tb.innerHTML += `<tr class="border-b border-gray-800"><td class="p-2">${id}</td><td class="p-2 font-bold">${s.Name||s['Full Name']}</td><td class="p-2">${s.Category||''}</td>${cells}<td class="p-2 font-bold text-yellow-500">${avg}</td></tr>`;
            });
        }

        function exportCSV() {
            let csv = "ID,Name,Category,J1,J2,J3,J4,J5,Average\n";
            app.students.forEach(s => {
                const id = s.ID || s['ID Card'];
                const name = s.Name || s['Full Name'];
                const cat = s.Category || '';
                const sc = app.scores[id] || {};
                let t=0, c=0, row=`"${id}","${name}","${cat}"`;
                for(let i=1; i<=5; i++){
                    let v=sc[`j${i}`]?.total||0;
                    if(v>0){t+=v; c++;}
                    row += `,${v}`;
                }
                row += `,${c? (t/c).toFixed(2) : 0}\n`;
                csv += row;
            });
            const link = document.createElement('a');
            link.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv);
            link.download = `results_${app.mode}.csv`;
            link.click();
        }

        async function exportBulkPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let page = 0;
            
            app.students.forEach(s => {
                const id = s.ID || s['ID Card'];
                const scores = app.scores[id];
                if(!scores) return;

                for(let j=1; j<=5; j++) {
                    const jScore = scores[`j${j}`];
                    if(!jScore) continue;
                    
                    if(page > 0) doc.addPage();
                    page++;

                    // Header
                    doc.setFillColor(6, 78, 59);
                    doc.rect(0, 0, 210, 40, 'F');
                    doc.setTextColor(212, 175, 55);
                    doc.setFontSize(22);
                    doc.text("JUDGING SCORE SHEET", 105, 20, null, null, "center");

                    // Info
                    doc.setTextColor(0,0,0);
                    doc.setFontSize(12);
                    doc.text(`Name: ${s.Name || s['Full Name']}`, 14, 50);
                    doc.text(`ID: ${id}`, 14, 58);
                    doc.text(`Judge: ${j}`, 150, 50);

                    // Table
                    let key = app.mode;
                    if(app.mode === 'quran') {
                        const branch = (s.Branch || "").toLowerCase();
                        key = branch.includes('hifz') ? 'quran_hifz' : 'quran_thilawa';
                    }
                    const rows = app.config[key].map(c => [c.name, c.max, jScore[c.id] || '-']);
                    rows.push(['TOTAL', '', jScore.total.toFixed(2)]);

                    doc.autoTable({
                        startY: 70,
                        head: [['Criteria', 'Max', 'Score']],
                        body: rows,
                        theme: 'grid',
                        headStyles: {fillColor:[6,78,59]}
                    });

                    // Comments
                    let y = doc.lastAutoTable.finalY + 10;
                    doc.text("Comments: " + (jScore.comment||""), 14, y);
                }
            });
            doc.save('Full_Report.pdf');
        }

        // --- FILE & DATA HANDLING ---
        function loadCSV() {
            const f = document.getElementById('file-students').files[0];
            if(!f) return;
            const r = new FileReader();
            r.onload = e => {
                const rows = e.target.result.split('\n').map(x => x.split(','));
                const h = rows[0].map(x => x.trim().replace(/"/g,''));
                app.students = rows.slice(1).filter(x => x.length > 1).map(r => {
                    let o = {}; h.forEach((k, i) => o[k] = r[i]?.trim().replace(/"/g,'') || ''); return o;
                });
                document.getElementById('st-status').innerText = `${app.students.length} Loaded`;
                saveData();
            };
            r.readAsText(f);
        }

        function saveData() {
            localStorage.setItem('royal_judge_ultimate_db', JSON.stringify({ students: app.students, scores: app.scores, config: app.config }));
        }

        // --- CONFIG EDITOR ---
        function renderConfigTable() {
            let key = app.mode === 'quran' ? 'quran_thilawa' : app.mode;
            const c = document.getElementById('rubric-config-container');
            c.innerHTML = '';
            let t = 0;
            app.config[key].forEach((i, idx) => {
                t += parseFloat(i.max);
                c.innerHTML += `<div class="flex gap-2 bg-gray-900 p-2 rounded"><input class="flex-1 bg-black text-sm" value="${i.name}" onchange="app.config['${key}'][${idx}].name=this.value;saveData()"><input type="number" class="w-16 bg-black text-center" value="${i.max}" onchange="app.config['${key}'][${idx}].max=this.value;saveData();renderConfigTable()"></div>`;
            });
            document.getElementById('config-total').innerText = t;
        }
        function addCriteria() {
            let key = app.mode === 'quran' ? 'quran_thilawa' : app.mode;
            app.config[key].push({id:Date.now(), name:'New', max:10});
            renderConfigTable();
        }
        function restoreDefaults() {
            app.config = JSON.parse(JSON.stringify(RUBRICS));
            renderConfigTable();
        }
    </script>
</body>
</html>
