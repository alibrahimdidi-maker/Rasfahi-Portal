<!DOCTYPE html>
<html lang="dv" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Royal Graduation (V18.0 - Ultimate Edition)</title>
    <style>
        /* FONTS & VARIABLES */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thaana:wght@400;700&display=swap');
        @font-face {
            font-family: 'Faruuma';
            src: local('Faruuma'), local('Faruumaa'), url('Fonts/faruuma.ttf') format('truetype');
        }
        :root {
            --royal-accent: #c5a059;      
            --royal-blue-dark: #001b3d;   
            --royal-blue-mid: #0d47a1;    
            --royal-green: #003322;        
            --panel-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
        }

        /* GLOBAL STYLES */
        body {
            -webkit-user-select: none; user-select: none;
            margin: 0; padding: 0;
            background: linear-gradient(135deg, #000c1a 0%, #00281c 100%);
            overflow: hidden; height: 100vh; width: 100vw;
            color: #333;
            font-family: 'Faruuma', 'MV Boli', 'Noto Sans Thaana', serif;
        }

        /* LAYOUT */
        .main-layout { 
            display: flex; gap: 20px; height: 100vh; width: 100vw; 
            padding: 15px; box-sizing: border-box; 
        }

        /* SIDEBAR */
        .sidebar {
            flex: 0 0 380px; 
            background: #f8fbff; 
            padding: 15px; border-radius: 12px;
            display: flex; flex-direction: column; height: 100%; 
            overflow-y: auto;
            box-shadow: var(--panel-shadow);
            border: 3px solid var(--royal-blue-dark);
        }

        /* EDITOR PANEL */
        .editor {
            flex: 1; 
            background: #fff; 
            padding: 25px; border-radius: 12px;
            display: flex; flex-direction: column; height: 100%; overflow-y: auto; 
            position: relative;
            box-shadow: var(--panel-shadow);
            border: 3px solid var(--royal-green);
        }

        /* COMMON ELEMENTS */
        .royal-banner {
            background: linear-gradient(to right, var(--royal-blue-dark), var(--royal-green));
            color: #fff; text-align: center; padding: 15px;
            border-bottom: 3px solid var(--royal-accent);
            border-radius: 8px; margin-bottom: 10px; flex-shrink: 0;
        }
        .banner-main { font-family: 'Times New Roman', serif; font-weight: bold; font-size: 14px; letter-spacing: 2px; color: #a0c4ff; display: block; }
        .banner-sub { font-size: 24px; color: var(--royal-accent); text-shadow: 0 2px 4px #000; display: block; margin-top: 5px; }

        input[type="text"], textarea, select { 
            width: 100%; padding: 10px; 
            border: 1px solid #90caf9; border-radius: 6px; 
            background: #e3f2fd; color: #000; margin-bottom: 8px; 
            font-size: 16px; box-sizing: border-box; font-family: 'Faruuma';
        }
        
        /* GROUPS & HEADERS */
        .d-label { 
            font-size: 16px; font-weight: 900; color: var(--royal-blue-mid);
            display: block; margin-top: 15px; margin-bottom: 5px; 
            border-bottom: 1px solid #b3e5fc; padding-bottom: 2px; 
        }
        .group-box {
            border: 1px solid #bbdefb; border-radius: 10px;
            padding: 25px 15px 15px 15px; margin-bottom: 20px; 
            background: #f1f8e9; position: relative;
        }
        .group-title {
            position: absolute; top: -15px; right: 15px;
            background: var(--royal-blue-dark); color: #fff;
            padding: 5px 20px; font-size: 16px; font-weight: bold;
            border-radius: 20px;
        }

        /* BUTTONS */
        button { cursor: pointer; font-weight: bold; transition: 0.2s; border-radius: 6px; border:none; }
        .launch-btn { background: #b71c1c; color: white; padding: 12px; width: 100%; font-size: 18px; margin-bottom: 10px; }
        .btn-live { background: #2e7d32; color: #fff; padding: 12px; font-size: 18px; width: 100%; margin-top:10px; box-shadow: 0 4px 5px rgba(0,0,0,0.2); }
        .btn-update { background: #0277bd; color: white; padding: 8px; width: 100%; margin-top: 5px; }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: #eee; }
        ::-webkit-scrollbar-thumb { background: #0d47a1; border-radius: 5px; }

        /* SPECIFIC CONTROLS */
        .font-dv { font-family: 'Faruuma'; direction: rtl; }
        .font-en { font-family: 'Times New Roman'; direction: ltr; text-align: left; }
        input[type=range] { width: 100%; accent-color: var(--royal-blue-mid); }
        input[type=color] { width: 40px; height: 30px; border:none; cursor: pointer; }
    </style>
</head>
<body oncontextmenu="return false;">

<div class="main-layout">
    <div class="sidebar">
        <div class="royal-banner">
            <span class="banner-main">GRADUATION SYSTEM V18.0</span>
            <span class="banner-sub">ﬁÉﬁØﬁîﬁ¶ﬁçﬁ∞ ﬁéﬁ™ﬁÉﬁ¨ﬁñﬁ™ﬁáﬁ≠ﬁùﬁ¶ﬁÇﬁ∞ ﬁêﬁ®ﬁêﬁ∞ﬁìﬁ¶ﬁâﬁ∞</span>
        </div>

        <button class="launch-btn" onclick="openTV()">üñ•Ô∏è 1. ﬁìﬁ©ﬁàﬁ© ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁ©ﬁÇﬁ∞ ﬁÄﬁ™ﬁÖﬁ™ﬁáﬁ∞ﬁàﬁß</button>
        <div id="connStatus" style="text-align:center; color:red; font-weight:bold; margin-bottom:10px;">üî¥ Not Connected</div>

        <div class="group-box" style="background:#fff;">
            <span class="d-label">üìÇ ﬁäﬁ¶ﬁáﬁ®ﬁçﬁ∞ﬁåﬁ¶ﬁáﬁ∞</span>
            <label>1. ﬁÜﬁ™ﬁãﬁ®ﬁÇﬁ∞ﬁéﬁ¨ ﬁçﬁ®ﬁêﬁ∞ﬁìﬁ™ (CSV):</label><input type="file" id="csvFile" accept=".csv">
            <label>2. ﬁäﬁÆﬁìﬁØ ﬁäﬁØﬁçﬁ∞ﬁëﬁ¶ﬁÉ:</label><input type="file" id="photoFolder" webkitdirectory directory multiple>
            <label>3. ﬁïﬁßﬁìﬁ∞ﬁÇﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁçﬁØﬁéﬁØﬁåﬁ¶ﬁáﬁ∞:</label><input type="file" id="partnerLogos" accept="image/*" multiple onchange="loadLogos(this)">
            <label>4. ﬁáﬁ®ﬁùﬁ∞ﬁåﬁ®ﬁÄﬁßﬁÉﬁ™ ﬁäﬁÆﬁìﬁØﬁåﬁ¶ﬁáﬁ∞:</label><input type="file" id="adFiles" accept="image/*" multiple onchange="loadAds(this)">
            <label>5. ﬁÜﬁ¶ﬁêﬁ∞ﬁìﬁ¶ﬁâﬁ∞ ﬁÜﬁßﬁëﬁ™ (Image):</label><input type="file" id="customCardBgFile" accept="image/*" onchange="loadCustomCardBg(this)">
        </div>

        <div class="group-box" style="background:#fff;">
            <span class="d-label">üîç ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁÄﬁØﬁáﬁ∞ﬁãﬁ¶ﬁàﬁß</span>
            <input type="text" id="search" placeholder="ﬁÇﬁ¶ﬁÇﬁ∞ ﬁñﬁ¶ﬁáﬁ∞ﬁêﬁ¶ﬁàﬁß..." onkeyup="filterList()">
            <select id="stuList" size="8" style="height:150px;" onchange="loadStudent()"></select>
        </div>
    </div>

    <div class="editor">
        
        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <button class="btn-live" style="flex:1; background:#546e7a;" onclick="clearTV()">Clean Screen</button>
            <button class="btn-live" style="flex:2;" onclick="updateTV()">üî¥ LIVE (Student)</button>
            <button class="btn-live" style="flex:1; background:#fbc02d; color:black;" onclick="toggleAds()">üì¢ Ads Mode</button>
        </div>

        <div style="display:flex; gap:20px; height:100%;">
            
            <div style="flex:1; overflow-y:auto;">
                <h3 style="color:var(--royal-blue-mid); border-bottom:2px solid #ccc;">üéì ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁéﬁ¨ ﬁâﬁ¶ﬁ¢ﬁ™ﬁçﬁ´ﬁâﬁßﬁåﬁ™</h3>
                <input id="nD" class="font-dv" placeholder="ﬁÇﬁ¶ﬁÇﬁ∞ (ﬁãﬁ®ﬁàﬁ¨ﬁÄﬁ®)">
                <input id="nE" class="font-en" placeholder="Name (English)">
                <div style="display:flex; gap:5px;">
                    <input id="fD" class="font-dv" placeholder="ﬁåﬁ¶ﬁäﬁ∞ﬁêﬁ©ﬁçﬁ™ 1 (ﬁãﬁ®ﬁàﬁ¨ﬁÄﬁ®)">
                    <input id="fE" class="font-en" placeholder="Detail 1 (English)">
                </div>
                <div style="display:flex; gap:5px;">
                    <input id="cD" class="font-dv" placeholder="ﬁåﬁ¶ﬁäﬁ∞ﬁêﬁ©ﬁçﬁ™ 2 (ﬁãﬁ®ﬁàﬁ¨ﬁÄﬁ®)">
                    <input id="cE" class="font-en" placeholder="Detail 2 (English)">
                </div>
                <textarea id="cm" rows="2" class="font-dv" placeholder="ﬁáﬁ®ﬁåﬁ™ﬁÉﬁ™ ﬁâﬁ¶ﬁ¢ﬁ™ﬁçﬁ´ﬁâﬁßﬁåﬁ™..."></textarea>
                
                <div style="background:#eee; padding:10px; border-radius:8px; text-align:center; margin-top:10px;">
                    <img id="previewImg" src="https://via.placeholder.com/150" style="height:100px; border:2px solid #ccc;">
                    <div id="pStat">No Photo</div>
                </div>

                <div class="group-box" style="margin-top:20px;">
                    <span class="group-title">üé¨ ﬁìﬁÆﬁïﬁ∞ 5 / ﬁàﬁ©ﬁëﬁ®ﬁáﬁØ ﬁïﬁ∞ﬁçﬁ≠ﬁîﬁ¶ﬁÉ</span>
                    <label>ﬁàﬁ©ﬁëﬁ®ﬁáﬁØ ﬁäﬁ¶ﬁáﬁ®ﬁçﬁ∞ﬁåﬁ¶ﬁáﬁ∞ ﬁÇﬁ¶ﬁéﬁß (Select All):</label>
                    <input type="file" id="videoPlaylist" accept="video/*" multiple>
                    <div style="display:flex; gap:5px; margin-top:5px;">
                        <button class="btn-update" onclick="playNextVideo()">‚ñ∂ Play Next</button>
                        <button class="btn-update" style="background:#d32f2f;" onclick="stopVideo()">‚èπ Stop</button>
                    </div>
                    <div style="margin-top:5px;">
                        <label><input type="checkbox" id="vidOverlayCheck"> ﬁàﬁ©ﬁëﬁ®ﬁáﬁØ ﬁâﬁ¶ﬁåﬁ©ﬁéﬁ¶ﬁáﬁ® ﬁÜﬁ™ﬁáﬁ∞ﬁñﬁßﬁéﬁ¨ ﬁâﬁ¶ﬁáﬁ™ﬁçﬁ´ﬁâﬁßﬁåﬁ™ ﬁãﬁ¶ﬁáﬁ∞ﬁÜﬁß</label>
                    </div>
                </div>

                <div class="group-box">
                    <span class="group-title">üìä ﬁïﬁ∞ﬁÉﬁ¨ﬁíﬁ¨ﬁÇﬁ∞ﬁìﬁ≠ﬁùﬁ¶ﬁÇﬁ∞</span>
                    <input type="text" id="presUrl" class="font-en" placeholder="Google Slides / Canva Embed Link...">
                    <button class="btn-update" style="background:#673ab7;" onclick="togglePresentation()">üåê Show Presentation</button>
                    <small style="display:block; color:#555; margin-top:5px;">PowerPoint ﬁÑﬁ≠ﬁÇﬁ™ﬁÇﬁ∞ﬁÜﬁ™ﬁÉﬁ¶ﬁáﬁ∞ﬁàﬁßﬁÇﬁ¶ﬁâﬁ¶ Google Slides ﬁáﬁ¶ﬁÅﬁ∞ ﬁáﬁ¶ﬁÖﬁ™ﬁáﬁ∞ﬁàﬁßﬁäﬁ¶ﬁáﬁ® ﬁçﬁ®ﬁÇﬁ∞ﬁÜﬁ™ ﬁñﬁ¶ﬁáﬁ∞ﬁêﬁ¶ﬁàﬁß.</small>
                </div>
            </div>

            <div style="flex:1; overflow-y:auto; border-left:1px solid #ccc; padding-left:15px;">
                <h3 style="color:var(--royal-green); text-align:center;">üé® ﬁëﬁ®ﬁíﬁ¶ﬁáﬁ®ﬁÇﬁ∞ ﬁÜﬁÆﬁÇﬁ∞ﬁìﬁ∞ﬁÉﬁØﬁçﬁ∞</h3>

                <div class="group-box">
                    <span class="group-title">üëë ﬁñﬁ¶ﬁçﬁ∞ﬁêﬁßﬁéﬁ¨ ﬁìﬁ¶ﬁáﬁ®ﬁìﬁ∞ﬁçﬁ∞</span>
                    <input type="text" id="jLine1" placeholder="ﬁâﬁ¶ﬁáﬁ® ﬁìﬁ¶ﬁáﬁ®ﬁìﬁ∞ﬁçﬁ∞" oninput="liveJalsa()">
                    <div style="display:flex; gap:5px; align-items:center;">
                        <span>Size:</span><input type="range" oninput="liveUpdate('mtSize', this.value)" min="2" max="10" step="0.1" value="5.5">
                        <input type="color" oninput="liveUpdate('mtColor', this.value)" value="#d4af37">
                    </div>
                    
                    <span class="d-label">ﬁêﬁ¶ﬁÑﬁ∞-ﬁìﬁ¶ﬁáﬁ®ﬁìﬁ∞ﬁçﬁ∞ (7 ﬁäﬁÆﬁÖﬁ™ﬁàﬁ¶ﬁåﬁ∞)</span>
                    <div style="background:#fff; padding:5px; border:1px solid #ccc; margin-bottom:5px;">
                        <small>ﬁáﬁ¨ﬁëﬁ®ﬁìﬁ∞ ﬁÜﬁ™ﬁÉﬁ¶ﬁÇﬁ∞ ﬁÑﬁ≠ﬁÇﬁ™ﬁÇﬁ∞ﬁàﬁß ﬁçﬁ¶ﬁáﬁ®ﬁÇﬁ∞ ﬁÇﬁ¶ﬁéﬁß:</small>
                        <select id="stSelector" onchange="updateStControls()">
                            <option value="1">ﬁçﬁ¶ﬁáﬁ®ﬁÇﬁ∞ 1</option>
                            <option value="2">ﬁçﬁ¶ﬁáﬁ®ﬁÇﬁ∞ 2</option>
                            <option value="3">ﬁçﬁ¶ﬁáﬁ®ﬁÇﬁ∞ 3</option>
                            <option value="4">ﬁçﬁ¶ﬁáﬁ®ﬁÇﬁ∞ 4</option>
                            <option value="5">ﬁçﬁ¶ﬁáﬁ®ﬁÇﬁ∞ 5</option>
                            <option value="6">ﬁçﬁ¶ﬁáﬁ®ﬁÇﬁ∞ 6</option>
                            <option value="7">ﬁçﬁ¶ﬁáﬁ®ﬁÇﬁ∞ 7</option>
                        </select>
                        <div style="display:flex; gap:5px; align-items:center; margin-top:5px;">
                            <span>Size:</span><input type="range" id="stSizeIn" oninput="setStStyle('size', this.value)" min="1" max="6" step="0.1" value="2.5">
                            <input type="color" id="stColorIn" oninput="setStStyle('color', this.value)" value="#ffffff">
                        </div>
                    </div>

                    <input type="text" id="st1" placeholder="Line 1" oninput="liveJalsa()">
                    <input type="text" id="st2" placeholder="Line 2" oninput="liveJalsa()">
                    <input type="text" id="st3" placeholder="Line 3" oninput="liveJalsa()">
                    <input type="text" id="st4" placeholder="Line 4" oninput="liveJalsa()">
                    <input type="text" id="st5" placeholder="Line 5" oninput="liveJalsa()">
                    <input type="text" id="st6" placeholder="Line 6" oninput="liveJalsa()">
                    <input type="text" id="st7" placeholder="Line 7" oninput="liveJalsa()">
                    
                    <button class="btn-update" onclick="liveJalsa()">Update Titles</button>
                </div>

                <div class="group-box">
                    <span class="group-title">üñºÔ∏è ﬁÜﬁßﬁëﬁ™ & ﬁçﬁØﬁéﬁØ</span>
                    
                    <span class="d-label">ﬁÜﬁßﬁëﬁ™ ﬁêﬁ∞ﬁìﬁ¶ﬁáﬁ®ﬁçﬁ∞:</span>
                    <select id="cardStyle" onchange="liveUpdate('cardStyle', this.value)">
                        <option value="std">Standard Theme</option>
                        <option value="custom">Custom Image (Upload #5)</option>
                        <option value="none">No Background</option>
                    </select>
                    
                    <span class="d-label">ﬁçﬁØﬁéﬁØ ﬁêﬁ¨ﬁìﬁ®ﬁÇﬁ∞ﬁéﬁ∞ﬁêﬁ∞:</span>
                    <div style="display:flex; gap:5px; align-items:center;">
                        <span>Size:</span><input type="range" oninput="liveUpdate('logoSize', this.value)" min="50" max="300" value="100">
                    </div>
                    <div style="display:flex; gap:5px; align-items:center;">
                        <span>Gap:</span><input type="range" oninput="liveUpdate('logoGap', this.value)" min="0" max="100" value="20">
                    </div>
                </div>

                <div class="group-box">
                    <span class="group-title">üìç ﬁâﬁ¶ﬁ§ﬁßﬁâﬁ∞ (Positions)</span>
                    <span class="d-label">Main Title Y:</span>
                    <input type="range" oninput="liveUpdate('mtY', this.value)" min="0" max="600" value="100">
                    
                    <span class="d-label">Subtitles Y:</span>
                    <input type="range" oninput="liveUpdate('stY', this.value)" min="0" max="600" value="250">
                    
                    <span class="d-label">Card Y:</span>
                    <input type="range" oninput="liveUpdate('cardY', this.value)" min="0" max="800" value="400">
                </div>

            </div>
        </div>
    </div>
</div>

<script>
    let tvWindow = null;
    let students = [];
    let photoFiles = {};
    let logoFiles = [];
    let adFiles = [];
    let customCardData = null;
    let playlist = [];
    let currentVideoIdx = 0;
    let adInterval = null;

    // Subtitle Styles State
    let stStyles = Array(8).fill({ size: 2.5, color: '#ffffff' }); // 1-7 used

    function openTV() {
        tvWindow = window.open('', 'RoyalTV', 'width=1280,height=720');
        if(!tvWindow) { alert("Popups blocked!"); return; }
        
        const html = `
        <!DOCTYPE html>
        <html dir="rtl">
        <head>
            <style>
                @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thaana:wght@400;700&display=swap');
                @font-face { font-family: 'Faruuma'; src: url('Fonts/faruuma.ttf') format('truetype'); }
                body { margin:0; overflow:hidden; background:#000; font-family:'Faruuma', serif; }
                
                /* LAYERS */
                #bgLayer { position:absolute; width:100%; height:100%; z-index:0; background: radial-gradient(circle, #004d40 0%, #001a12 100%); }
                #logoContainer { position:absolute; bottom:20px; left:0; width:100%; z-index:5; display:flex; justify-content:center; gap:20px; flex-wrap:wrap; padding:20px; box-sizing:border-box; }
                .p-logo { height:100px; object-fit:contain; filter:drop-shadow(0 2px 5px rgba(0,0,0,0.5)); }
                
                #contentLayer { position:absolute; top:0; left:0; width:100%; height:100%; z-index:10; transition:opacity 0.5s; }
                #adLayer { position:absolute; top:0; left:0; width:100%; height:100%; z-index:20; display:none; background:#000; }
                #adImg { width:100%; height:100%; object-fit:contain; }
                
                #videoLayer { position:absolute; top:0; left:0; width:100%; height:100%; z-index:15; display:none; background:#000; }
                #presLayer { position:absolute; top:0; left:0; width:100%; height:100%; z-index:25; display:none; background:#fff; }

                /* TEXT STYLES */
                .main-title { font-size:5.5em; color:#d4af37; text-align:center; position:absolute; width:100%; text-shadow:2px 2px 10px #000; transition:top 0.3s; }
                .sub-titles { position:absolute; width:100%; text-align:center; transition:top 0.3s; display:flex; flex-direction:column; gap:5px; }
                .st-line { text-shadow:1px 1px 5px #000; margin:0; line-height:1.2; }
                .st-line:empty { display:none; }

                /* STUDENT CARD */
                #card { 
                    position:absolute; left:50%; transform:translate(-50%, -50%); 
                    width:90vw; max-width:1400px; height:60vh;
                    display:flex; flex-direction:row-reverse; align-items:center;
                    opacity:0; transition:opacity 0.5s, top 0.3s;
                    z-index:30;
                }
                .card-std { background: rgba(0,20,15,0.9); border: 2px solid #d4af37; border-radius: 20px; padding:30px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
                .card-custom { background-size:100% 100%; background-repeat:no-repeat; border:none; padding:30px; }
                
                .photo-box { width:250px; height:250px; border:5px solid #d4af37; border-radius:50%; overflow:hidden; background:#000; flex-shrink:0; margin-left:30px; }
                .photo-box img { width:100%; height:100%; object-fit:cover; }
                
                .info-box { flex:1; text-align:right; color:#fff; }
                h1 { font-size:4em; margin:0; color:#fff; }
                h2 { font-size:2.5em; margin:5px 0; color:#d4af37; font-family:'Times New Roman'; direction:ltr; text-align:left; }
                .det { font-size:1.8em; color:#b2dfdb; }
                
                /* OVERLAY MODE FOR VIDEO */
                .overlay-mode #card { width:auto; height:auto; bottom:50px; top:auto !important; transform:translate(-50%, 0); background:rgba(0,0,0,0.7); border-radius:15px; padding:15px 40px; border:1px solid #fff; }
                .overlay-mode .photo-box { width:100px; height:100px; border-width:2px; }
                .overlay-mode h1 { font-size:2em; }
                .overlay-mode h2 { font-size:1.5em; }
                .overlay-mode .det { display:none; }
            </style>
        </head>
        <body>
            <div id="bgLayer"></div>
            
            <div id="logoContainer"></div>

            <div id="contentLayer">
                <div id="mt" class="main-title" style="top:100px;"></div>
                <div id="stWrap" class="sub-titles" style="top:250px;">
                    <div id="st1" class="st-line"></div>
                    <div id="st2" class="st-line"></div>
                    <div id="st3" class="st-line"></div>
                    <div id="st4" class="st-line"></div>
                    <div id="st5" class="st-line"></div>
                    <div id="st6" class="st-line"></div>
                    <div id="st7" class="st-line"></div>
                </div>
            </div>

            <div id="card" style="top:400px;">
                <div class="photo-box"><img id="sImg" src=""></div>
                <div class="info-box">
                    <h1 id="sNd"></h1>
                    <h2 id="sNe"></h2>
                    <div id="sD1" class="det"></div>
                    <div id="sD2" class="det"></div>
                    <div id="sCm" class="det" style="margin-top:10px; font-style:italic; color:#ffd54f;"></div>
                </div>
            </div>

            <div id="videoLayer"><video id="mainVid" style="width:100%; height:100%;" autoplay></video></div>
            <div id="adLayer"><img id="adImg" src=""></div>
            <div id="presLayer"><iframe id="presFrame" style="width:100%; height:100%; border:none;"></iframe></div>
        </body>
        </html>
        `;
        tvWindow.document.write(html);
        tvWindow.document.close();
        
        document.getElementById('connStatus').innerText = "‚úÖ CONNECTED";
        document.getElementById('connStatus').style.color = "green";
        
        // Init styles
        liveJalsa();
    }

    // --- DATA LOADING ---
    document.getElementById('csvFile').onchange = e => {
        const r = new FileReader();
        r.onload = ev => {
            let rows = ev.target.result.split('\n');
            students = rows.map(r => {
                let c = r.split(',');
                return { nD: c[0], nE: c[1], fD: c[2], fE: c[3], cD: c[4], cE: c[5], cm: c[6], ph: c[7]?.trim() };
            }).filter(s => s.nD);
            filterList(); alert("Loaded " + students.length + " students.");
        };
        r.readAsText(e.target.files[0]);
    };

    document.getElementById('photoFolder').onchange = e => {
        for(let f of e.target.files) photoFiles[f.name.split('.')[0].toLowerCase()] = f;
        alert("Photos Loaded!");
    };

    function loadLogos(inp) {
        logoFiles = Array.from(inp.files);
        updateLogosOnTV();
    }
    
    function updateLogosOnTV() {
        if(!tvWindow) return;
        const c = tvWindow.document.getElementById('logoContainer');
        c.innerHTML = '';
        logoFiles.forEach(f => {
            let url = URL.createObjectURL(f);
            let img = document.createElement('img');
            img.src = url; img.className = 'p-logo';
            // Apply current size setting
            let size = document.querySelector("input[oninput*='logoSize']").value;
            let gap = document.querySelector("input[oninput*='logoGap']").value;
            img.style.height = size + 'px';
            c.style.gap = gap + 'px';
            c.appendChild(img);
        });
    }

    function loadAds(inp) {
        adFiles = Array.from(inp.files);
        alert(adFiles.length + " Ads loaded.");
    }
    
    function loadCustomCardBg(inp) {
        let f = inp.files[0];
        if(f) {
            customCardData = URL.createObjectURL(f);
            liveUpdate('cardStyle', 'custom');
            document.getElementById('cardStyle').value = 'custom';
        }
    }

    // --- SEARCH & SELECT ---
    function filterList() {
        let q = document.getElementById('search').value.toLowerCase();
        let sel = document.getElementById('stuList'); sel.innerHTML = '';
        students.forEach((s, i) => {
            if((s.nD+s.nE).toLowerCase().includes(q)) {
                let opt = document.createElement('option');
                opt.value = i; opt.text = s.nD; sel.add(opt);
            }
        });
    }

    function loadStudent() {
        let s = students[document.getElementById('stuList').value];
        document.getElementById('nD').value = s.nD || '';
        document.getElementById('nE').value = s.nE || '';
        document.getElementById('fD').value = s.fD || '';
        document.getElementById('fE').value = s.fE || '';
        document.getElementById('cD').value = s.cD || '';
        document.getElementById('cE').value = s.cE || '';
        document.getElementById('cm').value = s.cm || '';
        
        let pName = s.ph ? s.ph.toLowerCase() : '';
        let f = photoFiles[pName];
        if(f) {
            let url = URL.createObjectURL(f);
            document.getElementById('previewImg').src = url;
            document.getElementById('pStat').innerText = "Found: " + s.ph;
            document.getElementById('pStat').style.color = "green";
        } else {
            document.getElementById('previewImg').src = "";
            document.getElementById('pStat').innerText = "Missing";
            document.getElementById('pStat').style.color = "red";
        }
    }

    // --- TV CONTROL ---
    function updateTV() {
        if(!tvWindow) return;
        const doc = tvWindow.document;
        
        // Hide Ads/Video
        stopAds(); stopVideo(); togglePresentation(false);

        // Fill Data
        doc.getElementById('sNd').innerText = document.getElementById('nD').value;
        doc.getElementById('sNe').innerText = document.getElementById('nE').value;
        doc.getElementById('sD1').innerHTML = document.getElementById('fD').value + "<br>" + document.getElementById('fE').value;
        doc.getElementById('sD2').innerHTML = document.getElementById('cD').value + "<br>" + document.getElementById('cE').value;
        doc.getElementById('sCm').innerText = document.getElementById('cm').value;
        doc.getElementById('sImg').src = document.getElementById('previewImg').src;

        // Show
        doc.getElementById('card').style.opacity = 1;
        doc.getElementById('contentLayer').style.opacity = 0; // Hide titles
    }

    function clearTV() {
        if(!tvWindow) return;
        stopAds(); stopVideo(); togglePresentation(false);
        tvWindow.document.getElementById('card').style.opacity = 0;
        tvWindow.document.getElementById('contentLayer').style.opacity = 1; // Show titles
        tvWindow.document.body.classList.remove('overlay-mode');
    }

    // --- ADS MODE ---
    let adIndex = 0;
    function toggleAds() {
        if(adInterval) stopAds(); else startAds();
    }
    
    function startAds() {
        if(!tvWindow || adFiles.length === 0) return;
        tvWindow.document.getElementById('adLayer').style.display = 'block';
        adIndex = 0;
        
        const showAd = () => {
            let url = URL.createObjectURL(adFiles[adIndex]);
            tvWindow.document.getElementById('adImg').src = url;
            adIndex = (adIndex + 1) % adFiles.length;
        };
        showAd();
        adInterval = setInterval(showAd, 5000); // 5 seconds
    }
    
    function stopAds() {
        clearInterval(adInterval); adInterval = null;
        if(tvWindow) tvWindow.document.getElementById('adLayer').style.display = 'none';
    }

    // --- TITLES & STYLING ---
    function updateStControls() {
        let idx = document.getElementById('stSelector').value;
        document.getElementById('stSizeIn').value = stStyles[idx].size;
        document.getElementById('stColorIn').value = stStyles[idx].color;
    }

    function setStStyle(prop, val) {
        let idx = document.getElementById('stSelector').value;
        if(prop === 'size') stStyles[idx].size = val;
        if(prop === 'color') stStyles[idx].color = val;
        liveJalsa();
    }

    function liveJalsa() {
        if(!tvWindow) return;
        const doc = tvWindow.document;
        
        doc.getElementById('mt').innerText = document.getElementById('jLine1').value;
        
        for(let i=1; i<=7; i++) {
            let el = doc.getElementById('st'+i);
            el.innerText = document.getElementById('st'+i).value;
            el.style.fontSize = stStyles[i].size + 'em';
            el.style.color = stStyles[i].color;
        }
    }

    function liveUpdate(key, val) {
        if(!tvWindow) return;
        const doc = tvWindow.document;
        
        if(key === 'mtSize') doc.getElementById('mt').style.fontSize = val + 'em';
        if(key === 'mtColor') doc.getElementById('mt').style.color = val;
        
        if(key === 'mtY') doc.getElementById('mt').style.top = val + 'px';
        if(key === 'stY') doc.getElementById('stWrap').style.top = val + 'px';
        if(key === 'cardY') doc.getElementById('card').style.top = val + 'px';

        if(key === 'logoSize') doc.querySelectorAll('.p-logo').forEach(i => i.style.height = val + 'px');
        if(key === 'logoGap') doc.getElementById('logoContainer').style.gap = val + 'px';

        if(key === 'cardStyle') {
            const card = doc.getElementById('card');
            card.className = '';
            if(val === 'std') card.classList.add('card-std');
            if(val === 'custom') {
                card.classList.add('card-custom');
                if(customCardData) card.style.backgroundImage = `url(${customCardData})`;
            }
        }
    }

    // --- VIDEO PLAYLIST ---
    document.getElementById('videoPlaylist').onchange = e => {
        playlist = Array.from(e.target.files);
        currentVideoIdx = 0;
        alert(playlist.length + " Videos queued.");
    };

    function playNextVideo() {
        if(!tvWindow || playlist.length === 0) return;
        if(currentVideoIdx >= playlist.length) currentVideoIdx = 0;

        let file = playlist[currentVideoIdx];
        let url = URL.createObjectURL(file);
        
        const vl = tvWindow.document.getElementById('videoLayer');
        const v = tvWindow.document.getElementById('mainVid');
        vl.style.display = 'block';
        v.src = url;
        v.play();
        
        // Handle Overlay
        if(document.getElementById('vidOverlayCheck').checked) {
            tvWindow.document.body.classList.add('overlay-mode');
            updateTV(); // Show student info
        } else {
            tvWindow.document.body.classList.remove('overlay-mode');
            tvWindow.document.getElementById('card').style.opacity = 0;
        }

        currentVideoIdx++;
    }

    function stopVideo() {
        if(!tvWindow) return;
        tvWindow.document.getElementById('videoLayer').style.display = 'none';
        tvWindow.document.getElementById('mainVid').pause();
        tvWindow.document.body.classList.remove('overlay-mode');
    }

    // --- PRESENTATION ---
    function togglePresentation(forceShow) {
        if(!tvWindow) return;
        const layer = tvWindow.document.getElementById('presLayer');
        const iframe = tvWindow.document.getElementById('presFrame');
        
        if(forceShow === undefined) {
            // Toggle
            if(layer.style.display === 'block') {
                layer.style.display = 'none';
                iframe.src = '';
            } else {
                layer.style.display = 'block';
                iframe.src = document.getElementById('presUrl').value;
            }
        } else if (forceShow === true) {
             layer.style.display = 'block';
             iframe.src = document.getElementById('presUrl').value;
        } else {
             layer.style.display = 'none';
        }
    }

</script>
</body>
</html>
