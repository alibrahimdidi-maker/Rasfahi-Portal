<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rasfahi Event & Graduation Software (Ultimate Edition)</title>
    <style>
        /* =========================================
           1. GLOBAL FONTS & VARIABLES
           ========================================= */
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Amiri:wght@400;700&family=Noto+Sans+Thaana:wght@400;700&display=swap');

        :root {
            --gold: #D4AF37;
            --gold-dim: #aa8c2c;
            --gold-bright: #FFD700;
            --royal-blue: #001a33;
            --royal-green: #002b15;
            --panel-bg: rgba(11, 16, 22, 0.95);
            --text-main: #ffffff;
        }

        /* User Custom Font Placeholder */
        @font-face { 
            font-family: 'CustomDv'; 
            src: local('Faruuma'), local('Waheed'), url(''); 
        }

        * { 
            box-sizing: border-box; 
            user-select: none; 
            outline: none; 
        }
        
        body {
            margin: 0; 
            padding: 0;
            background: #000; 
            color: #fff;
            height: 100vh; 
            width: 100vw;
            overflow: hidden;
            display: flex; 
            font-family: 'Cinzel', sans-serif;
        }

        /* =========================================
           2. SECURITY OVERLAY (LOCK SCREEN)
           ========================================= */
        #securityOverlay {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            background: radial-gradient(circle at center, #001a33 0%, #000000 100%); 
            z-index: 99999;
            display: flex; 
            justify-content: center; 
            align-items: center;
        }

        .login-card {
            width: 650px; 
            padding: 60px; 
            text-align: center;
            border: 6px double var(--gold); 
            border-radius: 20px;
            background: rgba(0, 0, 0, 0.95);
            box-shadow: 0 0 80px rgba(212, 175, 55, 0.3);
            position: relative;
        }

        .login-card h1 {
            color: var(--gold); 
            font-family: 'Cinzel', serif; 
            font-size: 36px; 
            margin: 0 0 15px 0; 
            letter-spacing: 3px;
            text-shadow: 0 2px 10px #000;
            border-bottom: 1px solid var(--gold-dim);
            padding-bottom: 15px;
        }
        
        .pass-input {
            width: 80%; 
            padding: 15px; 
            font-size: 22px; 
            text-align: center;
            border: 2px solid var(--gold-dim); 
            background: #080808; 
            color: var(--gold-bright);
            border-radius: 8px; 
            font-family: monospace; 
            letter-spacing: 4px;
            margin-top: 20px;
            transition: all 0.3s;
        }

        .pass-input:focus {
            border-color: var(--gold-bright);
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.5);
        }

        .auth-btn {
            background: linear-gradient(to bottom, #D4AF37, #aa8c2c);
            color: #000; 
            font-weight: 900; 
            font-size: 20px;
            padding: 15px 50px; 
            border: 1px solid #fff; 
            border-radius: 8px;
            margin-top: 25px; 
            cursor: pointer; 
            transition: 0.3s;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .auth-btn:hover { 
            transform: scale(1.05); 
            filter: brightness(1.2); 
            box-shadow: 0 0 30px var(--gold);
        }

        .disclaimer {
            font-family: sans-serif; 
            font-size: 12px; 
            color: #888;
            margin-top: 30px; 
            padding: 15px; 
            border: 1px dashed #444; 
            background: #0b0b0b;
            line-height: 1.6; 
            text-align: left;
        }

        /* =========================================
           3. MAIN APP FRAME & SIDEBAR
           ========================================= */
        .app-container {
            width: 98vw; 
            height: 96vh;
            border: 5px solid var(--gold);
            border-radius: 15px;
            display: flex;
            /* Ultra Royal Gradient Background */
            background: linear-gradient(135deg, #001a33 0%, #002b15 50%, #330000 100%);
            box-shadow: 0 0 100px rgba(212, 175, 55, 0.3);
            position: relative;
            overflow: hidden;
        }

        .sidebar {
            width: 480px; 
            flex-shrink: 0;
            background: rgba(0, 0, 0, 0.7); 
            backdrop-filter: blur(20px);
            display: flex; 
            flex-direction: column;
            z-index: 100; 
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            border-right: 3px solid var(--gold);
        }

        /* Dynamic Border handling via JS for RTL/LTR */
        
        .header {
            padding: 25px; 
            text-align: center;
            background: linear-gradient(to bottom, rgba(0,0,0,0.9), rgba(0,0,0,0));
            border-bottom: 2px solid var(--gold);
        }

        .app-title {
            color: var(--gold); 
            font-size: 22px; 
            margin: 0;
            text-shadow: 0 2px 5px #000; 
            letter-spacing: 1.5px; 
            font-weight: 900;
        }

        .content { 
            flex: 1; 
            overflow-y: auto; 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
        }

        /* Scrollbar Styling */
        .content::-webkit-scrollbar { width: 8px; }
        .content::-webkit-scrollbar-track { background: #111; }
        .content::-webkit-scrollbar-thumb { background: var(--gold-dim); border-radius: 4px; }

        /* Panels */
        .panel {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(212, 175, 55, 0.4); 
            border-radius: 8px; 
            padding: 15px;
            box-shadow: inset 0 0 30px rgba(0,0,0,0.5);
            transition: border-color 0.3s;
        }
        
        .panel:hover {
            border-color: var(--gold-bright);
        }

        h2 {
            color: var(--gold); 
            margin: 0 0 12px 0; 
            font-size: 15px;
            border-bottom: 1px dashed rgba(212, 175, 55, 0.5); 
            padding-bottom: 8px;
            font-family: 'Noto Sans Thaana', 'Cinzel', sans-serif; 
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        label { 
            color: #ccc; 
            font-size: 13px; 
            display: block; 
            margin: 12px 0 4px; 
            font-family: sans-serif; 
            font-weight: bold;
        }
        
        input, select {
            width: 100%; 
            padding: 10px; 
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid #445566; 
            color: #fff; 
            border-radius: 5px;
            font-size: 14px; 
            margin-bottom: 5px;
            transition: 0.3s;
        }

        input:focus, select:focus {
            border-color: var(--gold);
            background: rgba(0,0,0,0.9);
        }

        /* Buttons */
        button { 
            width: 100%;
            padding: 10px;
            margin-bottom: 5px;
            cursor: pointer; 
            background: linear-gradient(to bottom, #334455, #223344); 
            font-weight: bold; 
            border: 1px solid #556677; 
            border-radius: 5px;
            color: #fff;
            transition: all 0.2s;
            text-transform: uppercase;
            font-size: 13px;
        }

        button:hover { 
            border-color: var(--gold); 
            color: var(--gold); 
            transform: translateY(-2px);
        }
        
        button:active {
            transform: translateY(1px);
        }

        .btn-gold { 
            background: linear-gradient(to bottom, #D4AF37, #aa8c2c) !important; 
            color: #000 !important; 
            border: 1px solid #fff !important; 
            font-weight: 900 !important;
            font-size: 16px !important;
            padding: 15px !important;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        .btn-green { 
            background: linear-gradient(to bottom, #004d00, #003300) !important; 
            border-color: #006600 !important; 
        }

        .btn-red { 
            background: linear-gradient(to bottom, #8b0000, #500000) !important; 
            border-color: #b71c1c !important; 
        }

        /* Sidebar Footer */
        .sidebar-footer {
            padding: 15px; 
            text-align: center; 
            font-size: 11px; 
            color: #aaa;
            border-top: 1px solid var(--gold); 
            background: rgba(0,0,0,0.9);
            font-family: sans-serif; 
            line-height: 1.5;
        }
        
        .drive-link-btn {
            display: block; 
            margin-top: 10px; 
            padding: 12px;
            background: linear-gradient(90deg, rgba(212, 175, 55, 0.1), transparent); 
            border: 1px solid var(--gold);
            color: var(--gold); 
            text-decoration: none; 
            border-radius: 5px;
            font-weight: bold; 
            font-size: 11px;
            transition: 0.3s;
        }

        .drive-link-btn:hover { 
            background: rgba(212, 175, 55, 0.3); 
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.2);
        }

        /* =========================================
           4. PREVIEW MONITOR (UPDATED SIZE & BANNERS)
           ========================================= */
        .main-view {
            flex: 1; 
            background-image: radial-gradient(circle, rgba(255,255,255,0.05) 1px, transparent 1px);
            background-size: 30px 30px;
            display: flex; 
            flex-direction: column;
            justify-content: center; 
            align-items: center;
            position: relative;
        }

        /* INFO BANNER */
        .info-banner {
            width: 85%;
            padding: 15px 30px;
            margin-bottom: 20px;
            background: linear-gradient(90deg, transparent, rgba(0,0,0,0.8), transparent);
            border-top: 2px solid var(--gold);
            border-bottom: 2px solid var(--gold);
            color: var(--gold-bright);
            font-family: 'Noto Sans Thaana', 'Cinzel', sans-serif;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            text-shadow: 0 0 15px rgba(212,175,55,0.6);
            display: flex; 
            align-items: center; 
            justify-content: center;
            min-height: 60px;
        }

        /* PREVIEW CONTAINER */
        #previewContainer {
            width: 85%; 
            height: 75%; /* Large Preview */
            border: 10px double var(--gold);
            display: flex; 
            justify-content: center; 
            align-items: center;
            background: #000; 
            color: #fff;
            box-shadow: 0 0 100px rgba(0,0,0,0.9);
            position: relative; 
            overflow: hidden;
            border-radius: 15px;
        }
        
        /* PREVIEW CONTENT WRAPPER (FOR FADE) */
        #previewContent {
            text-align: center; 
            padding: 40px; 
            width: 100%;
            transition: opacity 0.5s ease-in-out;
            opacity: 1;
        }

        /* ROUND FULLSCREEN BUTTON */
        #fsToggleBtn {
            position: absolute; 
            bottom: 40px; 
            right: 40px;
            width: 80px; 
            height: 80px;
            border-radius: 50%;
            background: radial-gradient(circle, var(--gold), #8a6e15);
            border: 4px solid #fff;
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.6);
            cursor: pointer; 
            z-index: 200;
            display: flex; 
            justify-content: center; 
            align-items: center;
            font-size: 30px; 
            color: #000;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        #fsToggleBtn:hover { 
            transform: scale(1.15) rotate(90deg); 
            box-shadow: 0 0 50px var(--gold); 
        }

        /* --- UTILS --- */
        .lang-bar { 
            display: flex; 
            margin-bottom: 15px; 
            border: 1px solid #555; 
            border-radius: 5px; 
            overflow: hidden; 
        }
        .lang-btn { 
            flex: 1; 
            background: rgba(0,0,0,0.5); 
            color: #888; 
            border: none; 
            font-size: 12px; 
            margin: 0; 
            border-right: 1px solid #555; 
            border-radius: 0; 
        }
        .lang-btn.active { 
            background: var(--royal-blue); 
            color: var(--gold); 
            font-weight: bold; 
        }
        
        .row { display: flex; gap: 5px; margin-bottom:5px; }
        .hidden { display: none !important; }
        .fade-out { opacity: 0 !important; }

    </style>
</head>
<body oncontextmenu="return false;">

    <div id="securityOverlay">
        <div class="login-card">
            <h1>RASFAHI EVENT & GRADUATION</h1>
            <p style="color:#ccc; margin-bottom:20px;">Quran Recitation Module (Ultimate Presidential Edition)</p>
            
            <input type="password" id="passcode" class="pass-input" placeholder="PASTE LICENSE KEY">
            <br>
            <button onclick="unlockSystem()" class="auth-btn">AUTHENTICATE SYSTEM</button>
            <p id="errMsg" style="color:#ff4444; height:20px; margin-top:10px; font-weight:bold;"></p>

            <div class="disclaimer">
                <strong style="color:var(--gold);">‚ö†Ô∏è IMPORTANT VERIFICATION:</strong><br>
                Before projecting to the screen, please verify all Quranic verses with or compare with the Madina Mus'haf. Ensure Dhivehi translations conform to the version endorsed by the President's Office or Ministry of Islamic Affairs.<br>
                <span style="opacity:0.7;">(System Version: 26.5 | Licensed for Event Use Only)</span>
            </div>
        </div>
    </div>

    <div class="app-container" id="mainAppContainer">
        
        <div class="sidebar" id="sidebar">
            <div class="header">
                <div class="app-title">RASFAHI EVENT SOFTWARE</div>
                <div style="font-size:11px; color:#aaa; margin-top:5px;">Professional Quran Recitation Display System</div>
            </div>

            <div class="content">
                <div class="lang-bar">
                    <button class="lang-btn active" onclick="setLang('en')">ENGLISH (LTR)</button>
                    <button class="lang-btn" onclick="setLang('dv')">ﬁãﬁ®ﬁàﬁ¨ﬁÄﬁ® (RTL)</button>
                </div>

                <div class="panel">
                    <h2 data-key="config">CONFIGURATION</h2>
                    <div class="row">
                        <button class="btn-green" onclick="saveConfig()" data-key="btnSave">üíæ SAVE CONFIG</button>
                        <button class="btn-green" onclick="document.getElementById('confInput').click()" data-key="btnLoad">üìÇ LOAD CONFIG</button>
                        <input type="file" id="confInput" accept=".json" class="hidden" onchange="loadConfig(this)">
                    </div>
                    <div id="autoSaveStatus" style="font-size:10px; color:var(--gold); text-align:center; opacity:0; transition:opacity 0.5s;">Autosaved Settings</div>
                </div>

                <div class="panel">
                    <h2 data-key="data">DATA & FONTS</h2>
                    <label data-key="lblFont">Install Font (Faruuma/Waheed):</label>
                    <input type="file" id="fontInput" accept=".ttf,.otf,.woff">
                    <label data-key="lblCsv">Load Quran Database (CSV):</label>
                    <input type="file" id="csvInput" accept=".csv">
                </div>

                <div class="panel">
                    <h2 data-key="select">SELECTION</h2>
                    <label data-key="lblSurah">Select Surah:</label>
                    <select id="selSurah" onchange="updateRanges()"></select>
                    
                    <div class="row">
                        <div style="flex:1"><label data-key="lblStart">Start Ayah:</label><select id="selStart" onchange="setAyahRange()"></select></div>
                        <div style="flex:1"><label data-key="lblEnd">End Ayah:</label><select id="selEnd" onchange="setAyahRange()"></select></div>
                    </div>

                    <label data-key="lblTransMode">Translation Display Mode:</label>
                    <select id="transMode" onchange="updateLive(false)">
                        <option value="both">Dual (Dhivehi & English)</option>
                        <option value="dv">Dhivehi Only</option>
                        <option value="en">English Only</option>
                        <option value="none">Arabic Only</option>
                    </select>
                </div>

                <div class="panel">
                    <h2 data-key="adjust">TEXT ADJUSTMENT</h2>
                    
                    <label data-key="lblArSize">Arabic Size/Color:</label>
                    <div class="row">
                        <input type="color" id="colAr" value="#D4AF37" style="width:50px; cursor:pointer;" onchange="updateLive(false)">
                        <input type="range" id="sizeAr" min="1" max="10" step="0.1" value="3.5" oninput="updateLive(false)">
                    </div>

                    <label data-key="lblDvSize">Dhivehi Size/Color:</label>
                    <div class="row">
                        <input type="color" id="colDv" value="#ffffff" style="width:50px; cursor:pointer;" onchange="updateLive(false)">
                        <input type="range" id="sizeDv" min="1" max="8" step="0.1" value="1.8" oninput="updateLive(false)">
                    </div>

                    <label data-key="lblEnSize">English Size/Color:</label>
                    <div class="row">
                        <input type="color" id="colEn" value="#cccccc" style="width:50px; cursor:pointer;" onchange="updateLive(false)">
                        <input type="range" id="sizeEn" min="1" max="8" step="0.1" value="1.5" oninput="updateLive(false)">
                    </div>
                </div>

                <div class="panel">
                    <h2 data-key="themes">PRESIDENTIAL THEMES</h2>
                    <select id="themeSelect" onchange="updateLive(false)">
                        </select>
                </div>

                <div class="panel" style="border:1px solid var(--gold); background: rgba(212, 175, 55, 0.15);">
                    <h2 style="color:#fff; border-bottom:1px solid #fff;" data-key="live">LIVE PROJECTION</h2>
                    <button class="btn-gold" onclick="openProjector()" data-key="btnLaunch">üì∫ LAUNCH BIG SCREEN</button>
                    
                    <div class="row" style="margin-top:10px;">
                        <button class="btn-green" onclick="sendPhase('start')" data-key="txtBasmalah">BASMALAH</button>
                        <button class="btn-red" onclick="sendPhase('end')" data-key="txtSadaqallah">SADAQALLAH</button>
                    </div>
                    
                    <div class="row">
                        <button onclick="navigate(-1)" data-key="txtPrev">‚óÄ PREV</button>
                        <button onclick="navigate(1)" data-key="txtNext">NEXT ‚ñ∂</button>
                    </div>
                    
                    <input type="text" id="eventTitle" placeholder="Event Title" oninput="updateLive(false)" style="text-align:center; font-weight:bold;">
                    <button onclick="sendPhase('cover')" data-key="btnTitle">SHOW TITLE CARD</button>
                </div>

            </div>

            <div class="sidebar-footer">
                Software Designed by: <strong>RASFAHI - ALI IBRAHIM DIDI / 7791550</strong>
                <a href="https://drive.google.com/drive/folders/17DleEUNHdJkYlfiDefSghez-wIpA9MYL?usp=sharing" target="_blank" class="drive-link-btn">
                    üì• DOWNLOAD FONTS & CSV (GOOGLE DRIVE)
                </a>
            </div>
        </div>

        <div class="main-view">
            
            <div id="infoBanner" class="info-banner">
                Select a Surah to Begin
            </div>

            <div style="margin-bottom:10px; color:#aaa; font-size:12px; letter-spacing:2px; font-weight:bold;">LIVE PREVIEW MONITOR</div>
            
            <div id="previewContainer">
                <div id="previewContent">
                    <div id="prevAr" style="font-family:'Amiri'; font-size:32px; color:var(--gold); line-height:1.8;">ÿ®Ÿêÿ≥ŸíŸÖŸê Ÿ±ŸÑŸÑŸéŸëŸ∞ŸáŸê Ÿ±ŸÑÿ±ŸéŸëÿ≠ŸíŸÖŸéŸ∞ŸÜŸê Ÿ±ŸÑÿ±ŸéŸëÿ≠ŸêŸäŸÖŸê</div>
                    <div id="prevTr" style="font-family:'CustomDv'; font-size:18px; margin-top:15px; color:#ccc;">Preview Active</div>
                </div>
            </div>
            
            <button id="fsToggleBtn" onclick="toggleAppFullscreen()" title="Fullscreen Mode">‚õ∂</button>
        </div>

    </div> <script>
        // --- CORE STATE ---
        const DB = {}; 
        let themes = [];
        let activeAyahs = [];
        let curIndex = 0;
        let curPhase = 'cover';
        let projWin = null;
        let customFontData = null;

        // --- LOCALIZATION DICTIONARY ---
        const langData = {
            en: {
                config: "CONFIGURATION", btnSave: "üíæ SAVE CONFIG", btnLoad: "üìÇ LOAD CONFIG",
                data: "DATA & FONTS", lblFont: "Install Font:", lblCsv: "Load CSV Database:",
                select: "SELECTION", lblSurah: "Select Surah:", lblStart: "Start Ayah:", lblEnd: "End Ayah:", lblTransMode: "Translation Mode:",
                adjust: "TEXT ADJUSTMENT", lblArSize: "Arabic Size/Color:", lblDvSize: "Dhivehi Size/Color:", lblEnSize: "English Size/Color:",
                themes: "PRESIDENTIAL THEMES", 
                live: "LIVE PROJECTION", btnLaunch: "üì∫ LAUNCH BIG SCREEN", btnTitle: "SHOW TITLE CARD",
                lblBannerDef: "Select a Surah to Begin",
                txtBasmalah: "BASMALAH", txtSadaqallah: "SADAQALLAH", txtPrev: "‚óÄ PREV", txtNext: "NEXT ‚ñ∂"
            },
            dv: {
                config: "ﬁêﬁ®ﬁêﬁ∞ﬁìﬁ¶ﬁâﬁ∞ ﬁÜﬁÆﬁÇﬁ∞ﬁäﬁ®ﬁéﬁ¶ﬁÉﬁ≠ﬁùﬁ¶ﬁÇﬁ∞", btnSave: "üíæ ﬁêﬁ≠ﬁàﬁ∞ ﬁÜﬁÆﬁÇﬁ∞ﬁäﬁ®ﬁéﬁ∞", btnLoad: "üìÇ ﬁçﬁØﬁëﬁ∞ ﬁÜﬁÆﬁÇﬁ∞ﬁäﬁ®ﬁéﬁ∞",
                data: "ﬁëﬁ≠ﬁìﬁß ﬁáﬁ¶ﬁãﬁ® ﬁäﬁÆﬁÇﬁ∞ﬁìﬁ∞", lblFont: "ﬁäﬁÆﬁÇﬁ∞ﬁìﬁ∞ ﬁáﬁ®ﬁÇﬁ∞ﬁêﬁ∞ﬁìﬁØﬁçﬁ∞:", lblCsv: "ﬁëﬁ≠ﬁìﬁßﬁÑﬁ≠ﬁêﬁ∞ ﬁäﬁ¶ﬁáﬁ®ﬁçﬁ∞:",
                select: "ﬁáﬁßﬁîﬁ¶ﬁåﬁ∞ ﬁÇﬁ¨ﬁéﬁ™ﬁÇﬁ∞", lblSurah: "ﬁêﬁ´ﬁÉﬁ¶ﬁåﬁ∞ ﬁÇﬁ¶ﬁéﬁß:", lblStart: "ﬁäﬁ¶ﬁÅﬁß ﬁáﬁßﬁîﬁ¶ﬁåﬁ∞:", lblEnd: "ﬁÇﬁ®ﬁâﬁ≠ ﬁáﬁßﬁîﬁ¶ﬁåﬁ∞:", lblTransMode: "ﬁåﬁ¶ﬁÉﬁ™ﬁñﬁ¶ﬁâﬁß ﬁãﬁ¶ﬁáﬁ∞ﬁÜﬁßﬁéﬁÆﬁåﬁ∞:",
                adjust: "ﬁçﬁ®ﬁîﬁ™ﬁÇﬁ∞ ﬁÑﬁ¶ﬁãﬁ¶ﬁçﬁ™ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞", lblArSize: "ﬁ¢ﬁ¶ﬁÉﬁ¶ﬁÑﬁ® ﬁêﬁ¶ﬁáﬁ®ﬁíﬁ∞/ﬁÜﬁ™ﬁçﬁ¶:", lblDvSize: "ﬁãﬁ®ﬁàﬁ¨ﬁÄﬁ® ﬁêﬁ¶ﬁáﬁ®ﬁíﬁ∞/ﬁÜﬁ™ﬁçﬁ¶:", lblEnSize: "ﬁáﬁ®ﬁÇﬁéﬁ®ﬁÉﬁ≠ﬁêﬁ® ﬁêﬁ¶ﬁáﬁ®ﬁíﬁ∞/ﬁÜﬁ™ﬁçﬁ¶:",
                themes: "ﬁùﬁßﬁÄﬁ© ﬁåﬁ©ﬁâﬁ∞ﬁåﬁ¶ﬁáﬁ∞", 
                live: "ﬁçﬁ¶ﬁáﬁ®ﬁàﬁ∞ ﬁÜﬁÆﬁÇﬁ∞ﬁìﬁ∞ﬁÉﬁØﬁçﬁ∞", btnLaunch: "üì∫ ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁ©ﬁÇﬁ∞ ﬁáﬁ¶ﬁÉﬁ™ﬁàﬁß", btnTitle: "ﬁìﬁ¶ﬁáﬁ®ﬁìﬁ∞ﬁçﬁ∞ ﬁãﬁ¶ﬁáﬁ∞ﬁÜﬁß",
                lblBannerDef: "ﬁÜﬁ®ﬁîﬁ¨ﬁàﬁ™ﬁâﬁ¶ﬁÅﬁ∞ ﬁêﬁ´ﬁÉﬁ¶ﬁåﬁ¨ﬁáﬁ∞ ﬁöﬁ®ﬁîﬁßﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ¶ﬁáﬁ∞ﬁàﬁß",
                txtBasmalah: "ﬁÑﬁ®ﬁêﬁ∞ﬁâﬁ®", txtSadaqallah: "ﬁûﬁ¶ﬁãﬁ¶ﬁ§ﬁ¶Ô∑≤", txtPrev: "‚óÄ ﬁÜﬁ™ﬁÉﬁ®ﬁîﬁ¶ﬁÅﬁ∞", txtNext: "ﬁäﬁ¶ﬁÄﬁ¶ﬁåﬁ¶ﬁÅﬁ∞ ‚ñ∂"
            }
        };

        // --- 1. SECURITY & UNLOCK (FIXED LOGIC FOR KEYGEN) ---
        function unlockSystem() {
            const inp = document.getElementById('passcode').value.trim();
            const err = document.getElementById('errMsg');

            if (inp === "AIDD-2026-MASTER") {
                grantAccess("Admin");
                return;
            }

            if (!inp) { err.innerText = "Please enter a key."; return; }

            try {
                // Decode from KeyGenerator (Format: ROYAL_EXP_DATE_CUST_NAME)
                const decoded = atob(inp); 
                
                // KeyGen uses this format: ROYAL_EXP_YYYY-MM-DD_CUST_Name
                if (!decoded.startsWith("ROYAL_EXP_")) throw "Invalid Key Format";

                const parts = decoded.split("_CUST_");
                if(parts.length !== 2) throw "Invalid Key Structure";

                const prefixDate = parts[0].replace("ROYAL_EXP_", "");
                const custName = parts[1];

                const expDate = new Date(prefixDate);
                const today = new Date();
                today.setHours(0,0,0,0); // Comparison without time

                if (isNaN(expDate.getTime())) throw "Invalid Date in Key";
                if (expDate < today) throw "License Expired on " + prefixDate;

                // Success
                grantAccess(custName);

            } catch (e) {
                console.error(e);
                err.innerText = "‚õî ACCESS DENIED: " + (typeof e === 'string' ? e : "Invalid Key");
            }
        }

        function grantAccess(name) {
            document.getElementById('securityOverlay').style.display = 'none';
            initThemes(); 
            loadFromLocal(); 
            setInterval(saveToLocal, 5000); 
            alert("WELCOME " + name + "\nSystem Unlocked Successfully.");
        }
        
        document.onkeydown = e => { if(e.keyCode == 123 || (e.ctrlKey && e.shiftKey && e.keyCode == 73)) return false; };

        // --- 2. LANGUAGE SWITCHER ---
        function setLang(l) {
            const sb = document.getElementById('sidebar');
            const btns = document.querySelectorAll('.lang-btn');
            
            btns.forEach(b => b.classList.remove('active'));
            document.querySelector(`button[onclick="setLang('${l}')"]`).classList.add('active');
            document.documentElement.lang = l;

            const t = langData[l];
            document.querySelectorAll('[data-key]').forEach(el => {
                const k = el.getAttribute('data-key');
                if(t[k]) el.innerText = t[k];
            });

            const app = document.getElementById('mainAppContainer');
            if(l === 'en') {
                app.style.flexDirection = 'row'; 
                sb.style.borderRight = "3px solid var(--gold)"; sb.style.borderLeft = "none";
                document.documentElement.dir = "ltr";
            } else {
                app.style.flexDirection = 'row-reverse'; 
                sb.style.borderLeft = "3px solid var(--gold)"; sb.style.borderRight = "none";
                document.documentElement.dir = "rtl";
            }
            updateBanner();
        }

        // --- 3. SMOOTH FADE LOGIC (KEY UPGRADE) ---
        function fadePreview(callback) {
            const el = document.getElementById('previewContent');
            el.style.opacity = 0; // Trigger CSS Fade Out
            
            setTimeout(() => {
                callback(); // Change content while invisible
                el.style.opacity = 1; // Trigger CSS Fade In
            }, 300); // Wait 300ms for fade out
        }

        function updateLive(triggerFade = true) {
            const data = getDisplayData();
            
            // 1. Update Monitor (With Fade)
            if (triggerFade) {
                fadePreview(() => {
                    document.getElementById('prevAr').innerText = data.arabic;
                    document.getElementById('prevTr').innerHTML = data.htmlTrans; 
                    document.getElementById('prevTr').style.fontFamily = 'CustomDv';
                });
            } else {
                // Instant update for sliders
                document.getElementById('prevAr').innerText = data.arabic;
                document.getElementById('prevTr').innerHTML = data.htmlTrans; 
            }
            
            // 2. Update Projector (Sends fade signal)
            if(projWin && !projWin.closed) { 
                projWin.render(data, triggerFade); 
            }
        }

        // --- 4. DISPLAY DATA LOGIC ---
        function getDisplayData() {
            const title = document.getElementById('eventTitle').value;
            const themeIdx = document.getElementById('themeSelect').value || 0;
            const mode = document.getElementById('transMode').value;
            
            const styles = {
                ar: {c:document.getElementById('colAr').value, s:document.getElementById('sizeAr').value},
                dv: {c:document.getElementById('colDv').value, s:document.getElementById('sizeDv').value},
                en: {c:document.getElementById('colEn').value, s:document.getElementById('sizeEn').value}
            };

            let ar = "", tr = "";

            if(curPhase === 'cover') {
                ar = title; tr = "";
            } else if(curPhase === 'start') {
                ar = "ÿ®Ÿêÿ≥ŸíŸÖŸê Ÿ±ŸÑŸÑŸéŸëŸ∞ŸáŸê Ÿ±ŸÑÿ±ŸéŸëÿ≠ŸíŸÖŸéŸ∞ŸÜŸê Ÿ±ŸÑÿ±ŸéŸëÿ≠ŸêŸäŸÖŸê"; tr = "";
            } else if(curPhase === 'end') {
                ar = "ÿµŸéÿØŸéŸÇŸé Ÿ±ŸÑŸÑŸëŸ∞ŸáŸè Ÿ±ŸÑŸíÿπŸéÿ∏ŸêŸäŸÖŸè"; tr = "";
            } else if(activeAyahs[curIndex]) {
                const ay = activeAyahs[curIndex];
                ar = ay.ar;
                if(mode === 'dv') tr = `<div class="dv-text">${ay.dv}</div>`;
                else if(mode === 'en') tr = `<div class="en-text">${ay.en}</div>`;
                else if(mode === 'none') tr = "";
                else if(mode === 'both') {
                    tr = `<div class="dv-text">${ay.dv}</div><div class="royal-line"></div><div class="en-text">${ay.en}</div>`;
                }
            }

            return {
                arabic: ar, htmlTrans: tr, theme: themes[themeIdx] || themes[0],
                phase: curPhase, fontData: customFontData, styles: styles, transMode: mode
            };
        }

        // --- 5. NAVIGATION ---
        function sendPhase(p) {
            curPhase = p;
            if(p === 'reciting') curIndex = 0;
            updateLive(true); // Fade
        }

        function navigate(dir) {
            if(curPhase !== 'reciting') { sendPhase('reciting'); return; }
            let n = curIndex + dir;
            if(n >= 0 && n < activeAyahs.length) {
                curIndex = n;
                updateLive(true); // Fade
            } else if (n >= activeAyahs.length) {
                sendPhase('end');
            }
        }

        // --- 6. FILE LOADING ---
        document.getElementById('fontInput').onchange = e => {
            const r = new FileReader(); r.onload = ev => {
                customFontData = ev.target.result;
                const s = document.createElement('style');
                s.innerHTML = `@font-face { font-family: 'CustomDv'; src: url('${customFontData}'); }`;
                document.head.appendChild(s);
                alert("Font Installed!"); updateLive(false);
            };
            r.readAsDataURL(e.target.files[0]);
        };

        document.getElementById('csvInput').onchange = e => {
            const r = new FileReader(); r.onload = ev => {
                const rows = ev.target.result.split('\n');
                rows.slice(1).forEach(row => {
                    const c = row.split(',');
                    if(c.length >= 3) {
                        const s = c[0].trim();
                        const a = { no: c[1].trim(), ar: c[2].trim(), dv: c[3]?.trim()||"", en: c[4]?.trim()||"" };
                        if(!DB[s]) DB[s] = []; DB[s].push(a);
                    }
                });
                const sel = document.getElementById('selSurah');
                sel.innerHTML = '<option value="">-- Select --</option>';
                Object.keys(DB).forEach(k => sel.add(new Option(k, k)));
                alert("Database Loaded!");
            };
            r.readAsText(e.target.files[0]);
        };

        function updateRanges() {
            const s = document.getElementById('selSurah').value;
            const st = document.getElementById('selStart');
            const en = document.getElementById('selEnd');
            st.innerHTML = ''; en.innerHTML = '';
            if(DB[s]) {
                DB[s].forEach((a, i) => { const o = new Option(`Ayah ${a.no}`, i); st.add(o); en.add(o.cloneNode(true)); });
                en.value = DB[s].length - 1; setAyahRange();
            }
        }

        function setAyahRange() {
            const s = document.getElementById('selSurah').value;
            const i1 = parseInt(document.getElementById('selStart').value);
            const i2 = parseInt(document.getElementById('selEnd').value);
            if(DB[s]) {
                activeAyahs = DB[s].slice(i1, i2 + 1);
                curIndex = 0; sendPhase('reciting'); updateBanner();
            }
        }

        function updateBanner() {
            const s = document.getElementById('selSurah').value;
            const st = document.getElementById('selStart');
            const en = document.getElementById('selEnd');
            const banner = document.getElementById('infoBanner');
            const lang = document.documentElement.lang || 'en';

            if(s && st.options.length > 0) {
                const startTxt = st.options[st.selectedIndex].text;
                const endTxt = en.options[en.selectedIndex].text;
                if(lang === 'dv') banner.innerText = `ﬁâﬁ®ﬁñﬁ¶ﬁçﬁ∞ﬁêﬁßﬁéﬁ¶ﬁáﬁ® ﬁÜﬁ®ﬁîﬁ¶ﬁàﬁ¶ﬁÇﬁ∞ ﬁÄﬁ¶ﬁâﬁ¶ﬁñﬁ¨ﬁÄﬁ®ﬁäﬁ¶ﬁáﬁ®ﬁàﬁ¶ﬁÇﬁ©: ${s} (${startTxt} ﬁÇﬁ∞ ${endTxt} ﬁáﬁ¶ﬁÅﬁ∞)`;
                else banner.innerText = `Scheduled: ${s} (${startTxt} to ${endTxt})`;
            } else {
                banner.innerText = langData[lang].lblBannerDef;
            }
        }

        // --- 7. THEMES ---
        function initThemes() {
            // Expanded theme palette
            const colors = [
                {bg:"radial-gradient(circle, #004400, #000)", b:"#006600"}, 
                {bg:"radial-gradient(circle, #001a4d, #000)", b:"#003366"}, 
                {bg:"radial-gradient(circle, #440000, #000)", b:"#660000"}, 
                {bg:"radial-gradient(circle, #1a1a1a, #000)", b:"#333"},
                {bg:"radial-gradient(circle, #003333, #000)", b:"#005555"},
                {bg:"radial-gradient(circle, #2a0033, #000)", b:"#4d0066"},
                {bg:"radial-gradient(circle, #fff, #f0f0f0)", b:"#D4AF37", t:"#000"}
            ];
            const borders = ["15px double", "6px solid", "20px double", "10px ridge", "5px inset", "8px outset"];
            const sel = document.getElementById('themeSelect'); 
            sel.innerHTML = ""; 
            let count = 1;

            colors.forEach(col => { 
                borders.forEach(bord => {
                    themes.push({ 
                        id: count, 
                        bg: col.bg, 
                        border: `${bord} ${col.b}`, 
                        boxShadow: `0 0 60px ${col.b}80`, 
                        textColor: col.t || "#fff", 
                        accentColor: "#D4AF37" 
                    });
                    sel.add(new Option(`Royal Theme ${count}`, count-1)); 
                    count++;
                });
            });
        }

        // --- 8. UTILS ---
        function toggleAppFullscreen() { if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else if(document.exitFullscreen) document.exitFullscreen(); }
        function saveToLocal() { const st = { evtTitle: document.getElementById('eventTitle').value, theme: document.getElementById('themeSelect').value, transMode: document.getElementById('transMode').value, styles: getDisplayData().styles }; localStorage.setItem('rasfahi_pro', JSON.stringify(st)); document.getElementById('autoSaveStatus').style.opacity = 1; setTimeout(()=>document.getElementById('autoSaveStatus').style.opacity=0,1000); }
        function loadFromLocal() { const s = localStorage.getItem('rasfahi_pro'); if(s) applyState(JSON.parse(s)); }
        function saveConfig() { const b = new Blob([localStorage.getItem('rasfahi_pro')], {type:"application/json"}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download="config.json"; a.click(); }
        function loadConfig(i) { const r=new FileReader(); r.onload=e=>{applyState(JSON.parse(e.target.result)); alert("Loaded!");}; r.readAsText(i.files[0]); }
        function applyState(s) { if(s.evtTitle) document.getElementById('eventTitle').value=s.evtTitle; if(s.theme) document.getElementById('themeSelect').value=s.theme; if(s.transMode) document.getElementById('transMode').value=s.transMode; if(s.styles){ document.getElementById('colAr').value = s.styles.ar.c; document.getElementById('sizeAr').value = s.styles.ar.s; document.getElementById('colDv').value = s.styles.dv.c; document.getElementById('sizeDv').value = s.styles.dv.s; document.getElementById('colEn').value = s.styles.en.c; document.getElementById('sizeEn').value = s.styles.en.s; } updateLive(false); }

        // --- 9. PROJECTOR WINDOW ---
        function openProjector() {
            if(projWin && !projWin.closed) { projWin.focus(); return; }
            projWin = window.open("", "RasfahiProjector", "width=1280,height=720");
            
            const html = `
            <!DOCTYPE html><html lang="en"><head>
            <style>
                @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Amiri:wght@400;700&family=Noto+Sans+Thaana:wght@400;700&display=swap');
                body { margin:0; background:#000; height:100vh; display:flex; justify-content:center; align-items:center; overflow:hidden; font-family:'Amiri'; }
                
                #card { width:92vw; height:90vh; display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center; padding:4vw; border-radius:2vw; position:relative; box-sizing:border-box; transition: all 0.5s ease; }
                
                /* SMOOTH FADE WRAPPER */
                #contentWrapper { width:100%; transition: opacity 0.6s cubic-bezier(0.4, 0, 0.2, 1); opacity: 1; }
                .fade-out { opacity: 0 !important; }

                #arabicText { direction:rtl; line-height:1.6; text-shadow:0 0.4vw 0.8vw rgba(0,0,0,0.6); width:100%; margin-bottom:3vh; }
                #transContainer { width:100%; display:flex; flex-direction:column; align-items:center; text-shadow:0 0.2vw 0.4vw rgba(0,0,0,0.8); }
                .dv-text { font-family:'CustomDv','Noto Sans Thaana'; direction:rtl; line-height:1.6; margin-bottom:1vh; }
                .en-text { font-family:'Cinzel'; direction:ltr; margin-top:1vh; text-transform:uppercase; letter-spacing:0.1vw; }
                .royal-line { width:50%; height:0.2vw; background:linear-gradient(90deg,transparent,#D4AF37,transparent); margin:1.5vh auto; box-shadow:0 0 1vw #D4AF37; }
                .title-mode { font-family:'Cinzel'; text-transform:uppercase; color:#D4AF37!important; text-shadow:0 0 2vw #000; }
                .watermark { position:fixed; bottom:2vh; left:2vw; color:rgba(255,255,255,0.15); font-family:'Cinzel'; font-size:1.2vw; pointer-events:none; }
            </style></head>
            <body onclick="if(!document.fullscreenElement)document.documentElement.requestFullscreen();else document.exitFullscreen()">
            <div id="card">
                <div id="contentWrapper">
                    <div id="arabicText"></div>
                    <div id="transContainer"></div>
                </div>
            </div>
            <div class="watermark">¬©RASFAHI( AIDD )</div>
            <script>
                window.render = function(data, triggerFade) {
                    if(data.fontData && !window.fontLoaded) {
                        const s = document.createElement('style'); s.innerHTML = \`@font-face { font-family: 'CustomDv'; src: url('\${data.fontData}'); }\`;
                        document.head.appendChild(s); window.fontLoaded = true;
                    }
                    
                    const card = document.getElementById('card');
                    card.style.background = data.theme.bg; card.style.border = data.theme.border; card.style.boxShadow = data.theme.boxShadow; card.style.color = data.theme.textColor;

                    const wrapper = document.getElementById('contentWrapper');
                    const arBox = document.getElementById('arabicText');
                    const trBox = document.getElementById('transContainer');

                    // UPDATE CONTENT FUNCTION
                    const updateContent = () => {
                        arBox.innerHTML = data.arabic;
                        trBox.innerHTML = data.htmlTrans;
                        
                        // Sizing logic based on Viewport Width (VW)
                        const base = parseFloat(data.scale);
                        if(data.phase === 'cover') {
                            arBox.className = 'title-mode'; arBox.style.fontSize = (data.styles.ar.s * 1.5) + 'vw'; arBox.style.color = data.styles.ar.c;
                        } else if (data.phase === 'start' || data.phase === 'end') {
                            arBox.className = ''; arBox.style.fontSize = (data.styles.ar.s * 1.5) + 'vw'; arBox.style.color = '#fff';
                        } else {
                            arBox.className = ''; arBox.style.fontSize = data.styles.ar.s + 'vw'; arBox.style.color = data.styles.ar.c;
                            const dv = document.querySelector('.dv-text'); const en = document.querySelector('.en-text');
                            if(dv) { dv.style.fontSize = data.styles.dv.s + 'vw'; dv.style.color = data.styles.dv.c; }
                            if(en) { en.style.fontSize = data.styles.en.s + 'vw'; en.style.color = data.styles.en.c; }
                        }
                    };

                    // FADE LOGIC
                    if(triggerFade) {
                        wrapper.classList.add('fade-out');
                        setTimeout(() => {
                            updateContent();
                            wrapper.classList.remove('fade-out');
                        }, 600); // 600ms total transition cycle
                    } else {
                        updateContent();
                    }
                }
            <\/script></body></html>`;
            projWin.document.write(html); 
            projWin.document.close(); 
            setTimeout(()=>updateLive(false), 500);
        }
    </script>
</body>
</html>
