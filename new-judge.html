<!DOCTYPE html>
<html lang="dv" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rasfahi Royal Judging System V26.0 (Presidential Edition)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thaana:wght@400;700;900&family=Cinzel:wght@400;700&family=Amiri:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* --- ROYAL THEME VARIABLES --- */
        :root {
            --royal-green: #004d40;
            --royal-blue: #00254d;
            --royal-gold: #c5a059; /* Standard Gold */
            --royal-gold-bright: #ffd700; /* Bright Gold for Effects */
            --bg-dark: #0f1215;
            --panel-bg: #1a1d21;
            --text-light: #e0e0e0;
            --danger: #b71c1c;
            --success: #1b5e20;
            --border-radius: 8px;
            --shadow-soft: 0 4px 6px rgba(0,0,0,0.3);
            --shadow-glow: 0 0 15px rgba(197, 160, 89, 0.3);
        }

        /* --- GLOBAL STYLES --- */
        * { box-sizing: border-box; user-select: none; -webkit-user-select: none; }
        
        body {
            font-family: 'Noto Sans Thaana', 'Cinzel', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-light);
            margin: 0; padding: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
        }

        /* --- SCROLLBAR --- */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: var(--royal-gold); border-radius: 4px; }

        /* --- HELPER CLASSES --- */
        .hidden { display: none !important; }
        .flex { display: flex; gap: 10px; }
        .center { display: flex; justify-content: center; align-items: center; }
        .col { flex-direction: column; }
        .bold { font-weight: bold; }
        .gold-text { color: var(--royal-gold); }
        .w-100 { width: 100%; }
        
        /* --- BUTTONS (ROYAL STYLE) --- */
        button {
            padding: 10px 15px;
            border: 1px solid var(--royal-gold);
            background: linear-gradient(180deg, #2a2d31 0%, #15171a 100%);
            color: var(--royal-gold);
            font-family: 'Noto Sans Thaana', sans-serif;
            font-weight: bold;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
            text-transform: uppercase;
            font-size: 14px;
        }
        button:hover {
            background: linear-gradient(180deg, var(--royal-gold) 0%, #8a6e30 100%);
            color: #000;
            box-shadow: 0 0 10px var(--royal-gold);
        }
        button:active { transform: scale(0.98); }
        
        .btn-green { border-color: #00e676; color: #00e676; }
        .btn-green:hover { background: #00e676; color: #000; box-shadow: 0 0 10px #00e676; }
        
        .btn-red { border-color: #ff5252; color: #ff5252; }
        .btn-red:hover { background: #ff5252; color: #fff; box-shadow: 0 0 10px #ff5252; }

        /* --- INPUTS --- */
        input, select, textarea {
            background: #000;
            border: 1px solid #444;
            color: #fff;
            padding: 8px;
            border-radius: 4px;
            font-family: 'Noto Sans Thaana', sans-serif;
            font-size: 14px;
        }
        input:focus, select:focus { border-color: var(--royal-gold); outline: none; }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 350px;
            background: linear-gradient(180deg, #051821 0%, #000000 100%);
            border-left: 3px solid var(--royal-gold);
            display: flex; flex-direction: column;
            z-index: 100;
            box-shadow: 5px 0 20px rgba(0,0,0,0.5);
            transition: width 0.3s;
        }
        
        .logo-area {
            padding: 20px;
            text-align: center;
            border-bottom: 2px solid var(--royal-gold);
            background: radial-gradient(circle, var(--royal-blue) 0%, #000 100%);
        }
        .logo-area h1 { margin: 0; color: var(--royal-gold); font-family: 'Cinzel', serif; font-size: 24px; text-shadow: 0 2px 4px #000; }
        .logo-area p { margin: 5px 0 0; color: #aaa; font-size: 12px; }

        .nav-items { flex: 1; overflow-y: auto; padding: 10px; }
        .nav-btn {
            width: 100%; text-align: right; padding: 15px; margin-bottom: 5px;
            background: transparent; border: none; border-bottom: 1px solid #333;
            color: #ccc; display: flex; align-items: center; justify-content: space-between;
        }
        .nav-btn.active { background: var(--royal-green); color: #fff; border-left: 4px solid var(--royal-gold); }
        
        /* --- MAIN CONTENT --- */
        .main-stage {
            flex: 1;
            background-color: #222;
            background-image: radial-gradient(#333 1px, transparent 1px);
            background-size: 20px 20px;
            padding: 20px;
            overflow-y: auto;
            position: relative;
        }

        .panel-box {
            background: var(--panel-bg);
            border: 1px solid var(--royal-gold);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-soft);
        }
        .panel-title {
            color: var(--royal-gold);
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
            margin-bottom: 15px;
            font-family: 'Cinzel', 'Noto Sans Thaana';
            font-size: 18px;
            display: flex; justify-content: space-between;
        }

        /* --- STUDENT BANNER --- */
        .student-banner {
            background: linear-gradient(90deg, var(--royal-green) 0%, var(--royal-blue) 100%);
            border: 4px double var(--royal-gold);
            border-radius: 10px;
            padding: 20px;
            display: flex;
            align-items: center;
            color: #fff;
            margin-bottom: 20px;
            box-shadow: var(--shadow-glow);
        }
        .std-photo {
            width: 100px; height: 100px;
            border-radius: 50%;
            border: 3px solid var(--royal-gold);
            object-fit: cover;
            background: #aaa;
            margin-left: 20px;
        }
        .std-info h1 { margin: 0; font-size: 32px; color: var(--royal-gold-bright); text-shadow: 1px 1px 2px #000; }
        .std-info p { margin: 5px 0 0; font-size: 16px; opacity: 0.9; }

        /* --- GRID SYSTEM --- */
        .grid-wrapper {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
        }
        .grid-cell {
            background: #111;
            border: 1px solid #444;
            height: 60px;
            display: flex; justify-content: center; align-items: center;
            font-size: 20px; font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }
        .grid-cell:hover { background: var(--royal-gold); color: #000; }
        .grid-cell.taken { background: #300; color: #555; pointer-events: none; border-color: #500; }
        .grid-cell.selected { background: var(--royal-green); color: #fff; border: 2px solid #fff; }

        /* --- JUDGE RUBRIC TABLE --- */
        .rubric-table { width: 100%; border-collapse: collapse; }
        .rubric-table th { text-align: right; background: #111; padding: 10px; color: #aaa; border-bottom: 2px solid var(--royal-gold); }
        .rubric-table td { padding: 10px; border-bottom: 1px solid #333; }
        
        .score-ctrl { display: flex; gap: 5px; align-items: center; justify-content: flex-end; }
        .deduct-btn {
            width: 35px; height: 35px; border-radius: 50%;
            background: #300; border: 1px solid #f00; color: #f00;
            padding: 0; font-size: 12px; display: flex; justify-content: center; align-items: center;
        }
        .deduct-btn:hover { background: #f00; color: #fff; }
        .score-display {
            font-size: 20px; font-weight: bold; color: var(--royal-gold);
            width: 60px; text-align: center;
        }

        /* --- FULL SCREEN BTN --- */
        #fs-btn {
            position: fixed; bottom: 20px; right: 20px;
            width: 60px; height: 60px;
            border-radius: 50%;
            background: var(--royal-gold);
            color: #000;
            font-size: 24px;
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 0 20px rgba(197, 160, 89, 0.5);
            z-index: 999;
            cursor: pointer;
        }

        /* --- LOGIN OVERLAY --- */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 10000;
            display: flex; justify-content: center; align-items: center;
            flex-direction: column;
        }
        .login-box {
            border: 2px solid var(--royal-gold); padding: 40px; border-radius: 10px;
            text-align: center; background: #111; box-shadow: 0 0 50px var(--royal-gold);
        }

        /* --- PRINT STYLES --- */
        @media print {
            .sidebar, #fs-btn, .no-print { display: none !important; }
            .main-stage { background: #fff; color: #000; }
            .panel-box { border: none; box-shadow: none; }
            table { color: #000; border-collapse: collapse; }
            th, td { border: 1px solid #000; }
        }

    </style>
</head>
<body oncontextmenu="return false;"> <div id="login-overlay">
        <div class="login-box">
            <h1 style="color:var(--royal-gold); margin-bottom:10px;">RASFAHI JUDGING V26.0</h1>
            <p style="color:#aaa;">Enter License Key to Activate</p>
            <input type="password" id="licenseKey" placeholder="XXXX-XXXX-XXXX" style="width:100%; text-align:center; font-size:18px; margin: 15px 0;">
            <button onclick="unlockSystem()" style="width:100%;">AUTHENTICATE</button>
            <p id="loginMsg" style="color:red; margin-top:10px; font-size:12px;"></p>
        </div>
    </div>

    <div class="sidebar">
        <div class="logo-area">
            <h1>ﬁÉﬁ¶ﬁêﬁ∞ﬁäﬁ¶ﬁÄﬁ® ﬁñﬁ¶ﬁñﬁ®ﬁÇﬁ∞ﬁé</h1>
            <p>PRESIDENTIAL EDITION V26.0</p>
        </div>
        
        <div class="nav-items">
            <button class="nav-btn active" onclick="showPanel('dashboard')">
                <span>ﬁëﬁ≠ﬁùﬁ∞ﬁÑﬁØﬁëﬁ∞ (Dashboard)</span> üìä
            </button>
            <button class="nav-btn" onclick="showPanel('students')">
                <span>ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ (Participants)</span> üéì
            </button>
            <button class="nav-btn" onclick="showPanel('control')">
                <span>ﬁÜﬁÆﬁÇﬁ∞ﬁìﬁ∞ﬁÉﬁØﬁçﬁ∞ ﬁÉﬁ´ﬁâﬁ∞ (Control)</span> üéõÔ∏è
            </button>
            <button class="nav-btn" onclick="showPanel('results')">
                <span>ﬁÇﬁ¶ﬁåﬁ©ﬁñﬁß / ﬁÉﬁ®ﬁïﬁØﬁìﬁ∞ (Results)</span> üèÜ
            </button>
            <button class="nav-btn" onclick="showPanel('settings')">
                <span>ﬁêﬁ¨ﬁìﬁ®ﬁÇﬁ∞ﬁéﬁ∞ﬁêﬁ∞ (Settings)</span> ‚öôÔ∏è
            </button>
            
            <hr style="border-color:#333; margin: 20px 0;">
            
            <div style="padding:10px;">
                <label style="color:#aaa; font-size:12px;">Interface Language:</label>
                <div class="flex" style="margin-top:5px;">
                    <button class="w-100" onclick="setLang('dv')">ﬁãﬁ®ﬁàﬁ¨ﬁÄﬁ®</button>
                    <button class="w-100" onclick="setLang('en')">English</button>
                    <button class="w-100" onclick="setLang('ar')">ÿπÿ±ÿ®Ÿä</button>
                </div>
            </div>
        </div>
    </div>

    <div class="main-stage">
        
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <div style="font-size:12px; color:#aaa;">
                System Status: <span style="color:var(--royal-green);">‚óè ONLINE (Local Mode)</span>
            </div>
            <div id="clock" style="font-family:'Cinzel'; font-weight:bold; color:var(--royal-gold);">12:00 PM</div>
        </div>

        <div id="panel-dashboard" class="panel-box">
            <div class="panel-title"><span>ﬁâﬁ™ﬁÑﬁßﬁÉﬁßﬁåﬁ™ﬁéﬁ¨ ﬁöﬁ™ﬁçﬁßﬁûﬁß</span></div>
            <div class="grid-wrapper" style="grid-template-columns: repeat(3, 1fr); gap:20px;">
                <div style="background:#004d40; padding:20px; border-radius:8px; text-align:center;">
                    <h2 style="margin:0; font-size:40px;" id="stat-total">0</h2>
                    <p>ﬁñﬁ™ﬁâﬁ∞ﬁçﬁ¶ ﬁÑﬁ¶ﬁáﬁ®ﬁàﬁ¨ﬁÉﬁ®ﬁÇﬁ∞</p>
                </div>
                <div style="background:#00254d; padding:20px; border-radius:8px; text-align:center;">
                    <h2 style="margin:0; font-size:40px;" id="stat-completed">0</h2>
                    <p>ﬁÇﬁ®ﬁâﬁ™ﬁÇﬁ™ ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁÇﬁ∞</p>
                </div>
                <div style="background:#c5a059; padding:20px; border-radius:8px; text-align:center; color:#000;">
                    <h2 style="margin:0; font-size:40px;" id="stat-pending">0</h2>
                    <p>ﬁÑﬁßﬁÜﬁ© ﬁåﬁ®ﬁÑﬁ®</p>
                </div>
            </div>
        </div>

        <div id="panel-control" class="panel-box hidden">
            <div class="panel-title">
                <span>ﬁçﬁ¶ﬁáﬁ®ﬁàﬁ∞ ﬁñﬁ¶ﬁñﬁ®ﬁÇﬁ∞ﬁé ﬁêﬁ∞ﬁìﬁ≠ﬁùﬁ¶ﬁÇﬁ∞</span>
                <button class="btn-green" onclick="launchScreens()">üöÄ Launch Screens (Student/Judge)</button>
            </div>

            <div id="active-student-area" class="hidden">
                <div class="student-banner">
                    <img src="" id="live-photo" class="std-photo">
                    <div class="std-info" style="margin-right:20px;">
                        <h1 id="live-name">Select a Student</h1>
                        <p id="live-details">ID: -- | Group: --</p>
                    </div>
                    <div style="margin-right:auto; text-align:center;">
                        <div style="font-size:12px; color:#aaa;">LIVE SCORE</div>
                        <div id="live-total-score" style="font-size:40px; font-weight:bold; color:#fff;">0.00</div>
                    </div>
                </div>
            </div>

            <div class="flex">
                <div class="panel-box w-100" style="flex:1;">
                    <h3 class="gold-text">1. ﬁêﬁ™ﬁàﬁßﬁçﬁ™ ﬁÇﬁ¨ﬁéﬁ™ﬁÇﬁ∞ (Grid)</h3>
                    <div class="flex" style="margin-bottom:10px;">
                         <select id="q-set-select" class="w-100">
                             <option value="1">Set 1 (Surah 1-10)</option>
                             <option value="2">Set 2 (Juz 30)</option>
                         </select>
                         <button onclick="generateGrid()">Reset Grid</button>
                    </div>
                    <div id="grid-container" class="grid-wrapper" style="height:200px; overflow-y:auto; padding:5px;">
                        </div>
                    <div style="margin-top:10px; text-align:center;">
                        <span id="selected-q-display" style="color:var(--royal-green); font-weight:bold;">No Question Selected</span>
                    </div>
                    <div class="flex" style="margin-top:10px;">
                        <button class="w-100" onclick="sendToScreen('GRID')">Show Grid on Screen</button>
                        <button class="w-100 btn-green" onclick="sendToScreen('QUESTION')">Show Question</button>
                    </div>
                </div>

                <div class="panel-box w-100" style="flex:1;">
                    <h3 class="gold-text">2. ﬁñﬁ¶ﬁñﬁ®ﬁÇﬁ∞ﬁé (Scoring)</h3>
                    <div style="height:300px; overflow-y:auto;">
                        <table class="rubric-table">
                            <thead>
                                <tr>
                                    <th>Criteria</th>
                                    <th width="50">Max</th>
                                    <th>Deductions</th>
                                    <th>Score</th>
                                </tr>
                            </thead>
                            <tbody id="rubric-body">
                                </tbody>
                        </table>
                    </div>
                    <div style="margin-top:10px; text-align:right;">
                        <button class="btn-green" style="width:100%; font-size:18px;" onclick="saveResult()">üíæ SAVE FINAL RESULT</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="panel-students" class="panel-box hidden">
             <div class="panel-title">
                <span>ﬁÑﬁ¶ﬁáﬁ®ﬁàﬁ¨ﬁÉﬁ®ﬁÇﬁ∞ﬁéﬁ¨ ﬁçﬁ®ﬁêﬁ∞ﬁìﬁ∞</span>
                <button onclick="document.getElementById('csv-input').click()">Import CSV</button>
                <input type="file" id="csv-input" class="hidden" accept=".csv" onchange="loadCSV(this)">
            </div>
            <div class="flex" style="margin-bottom:10px;">
                <input type="text" id="search-box" placeholder="Search Name / ID..." class="w-100" onkeyup="filterStudents()">
                <select id="filter-group" onchange="filterStudents()">
                    <option value="All">All Groups</option>
                    <option value="Under 6">Under 6</option>
                    <option value="Under 9">Under 9</option>
                    <option value="Under 11">Under 11</option>
                    <option value="Adults">Adults</option>
                </select>
                <select id="filter-inst" onchange="filterStudents()">
                    <option value="All">All Institutions</option>
                    <option value="School">Schools</option>
                    <option value="University">Universities</option>
                    <option value="Office">Offices</option>
                </select>
            </div>
            <div style="height:60vh; overflow-y:auto;">
                <table class="rubric-table" id="student-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Group</th>
                            <th>Institution</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </div>

        <div id="panel-results" class="panel-box hidden">
             <div class="panel-title"><span>ﬁÇﬁ¶ﬁåﬁ©ﬁñﬁß ﬁùﬁ©ﬁìﬁ∞</span></div>
             <div class="flex" style="margin-bottom:20px;">
                 <button onclick="generateReport('top3')" class="w-100">Top 3 Report</button>
                 <button onclick="generateReport('top5')" class="w-100">Top 5 Report</button>
                 <button onclick="generateReport('full')" class="w-100">Full Result Sheet</button>
                 <button onclick="exportCSV()" class="btn-green w-100">Export CSV</button>
             </div>
             <div id="report-preview" style="background:#fff; color:#000; padding:20px; min-height:400px;">
                 <h2 style="text-align:center;">Report Preview</h2>
                 <p style="text-align:center; color:#666;">Select a report type above</p>
             </div>
        </div>
        
        <div id="panel-settings" class="panel-box hidden">
            <div class="panel-title"><span>ﬁêﬁ¨ﬁìﬁ®ﬁÇﬁ∞ﬁéﬁ∞ﬁêﬁ∞</span></div>
            <div class="flex">
                <div class="w-100">
                    <label>Competition Name</label>
                    <input type="text" id="conf-comp-name" value="Rasfahi Quran Competition 2026" class="w-100">
                </div>
                 <div class="w-100">
                    <label>Total Judges</label>
                    <select id="conf-judge-count" class="w-100">
                        <option value="1">1 Judge (Master)</option>
                        <option value="3">3 Judges</option>
                        <option value="5">5 Judges</option>
                    </select>
                </div>
            </div>
            <h4 class="gold-text" style="margin-top:20px;">Rubric Configuration</h4>
            <textarea id="conf-rubric" class="w-100" rows="5">
[
    {"name": "Hifz (Memorization)", "max": 40},
    {"name": "Tajweed", "max": 30},
    {"name": "Fasaha", "max": 20},
    {"name": "Saut (Voice)", "max": 10}
]
            </textarea>
            <button class="btn-green" style="margin-top:10px;" onclick="saveSettings()">Save Configuration</button>
        </div>

    </div>

    <div id="fs-btn" onclick="toggleFullScreen()" title="Toggle Full Screen">‚õ∂</div>

    <script type="text/template" id="student-window-template">
        <!DOCTYPE html>
        <html dir="rtl">
        <head>
            <title>Student Display</title>
            <style>
                body { margin:0; background:#000; color:#fff; font-family:sans-serif; display:flex; flex-direction:column; height:100vh; overflow:hidden; }
                .banner { background: linear-gradient(90deg, #004d40, #00254d); padding:20px; text-align:center; border-bottom:4px double #c5a059; }
                .banner h1 { margin:0; color:#c5a059; font-size:4vw; }
                .content { flex:1; display:flex; justify-content:center; align-items:center; position:relative; }
                .quran-img { max-height:80vh; max-width:90vw; box-shadow:0 0 30px rgba(255,255,255,0.1); }
                .grid-view { display:grid; grid-template-columns:repeat(5, 1fr); gap:10px; width:80%; }
                .grid-box { background:#222; border:1px solid #444; height:100px; display:flex; justify-content:center; align-items:center; font-size:30px; color:#c5a059; }
            </style>
        </head>
        <body>
            <div class="banner"><h1 id="s-name">Welcome</h1></div>
            <div class="content" id="s-content">
                <h2 style="color:#555;">Waiting for control...</h2>
            </div>
            <script>
                window.updateDisplay = function(data) {
                    document.getElementById('s-name').innerText = data.name || "Rasfahi Competition";
                    const content = document.getElementById('s-content');
                    if(data.mode === 'GRID') {
                        let html = '<div class="grid-view">';
                        for(let i=1; i<=20; i++) html += `<div class="grid-box" style="${data.taken.includes(i)?'opacity:0.2':''}">${i}</div>`;
                        html += '</div>';
                        content.innerHTML = html;
                    } else if (data.mode === 'QUESTION') {
                        // In real app, this src comes from data. For demo, placeholder.
                        content.innerHTML = `<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/64/1_Surah_Al_Fatihah.png/640px-1_Surah_Al_Fatihah.png" class="quran-img">`;
                    }
                }
            <\/script>
        </body>
        </html>
    </script>

    <script>
        /* --- CORE LOGIC --- */
        
        // State
        let state = {
            students: [],
            currentStudent: null,
            rubric: [],
            gridTaken: [],
            results: []
        };
        
        let childWindows = { student: null, judges: [] };

        // Initialization
        window.onload = function() {
            startClock();
            loadSettings();
            // Mock Data if empty
            if(state.students.length === 0) {
                state.students = [
                    {id:"A001", name:"Ahmed Ali", group:"Under 11", inst:"Ghazee School", photo:""},
                    {id:"A002", name:"Fathimath Sara", group:"Under 9", inst:"Rehendhi School", photo:""},
                    {id:"A003", name:"Mohamed Zaid", group:"Adults", inst:"MNDF", photo:""}
                ];
            }
            renderStudentTable();
            renderRubricTable();
            generateGrid();
            updateDashboard();
            
            // Auto-save check
            if(localStorage.getItem('rasfahi_results')) {
                state.results = JSON.parse(localStorage.getItem('rasfahi_results'));
                updateDashboard();
            }
        };

        function unlockSystem() {
            const k = document.getElementById('licenseKey').value;
            if(k === "ADMIN-OVERRIDE") {
                document.getElementById('login-overlay').classList.add('hidden');
            } else {
                document.getElementById('loginMsg').innerText = "Invalid License Key";
            }
        }

        /* --- NAVIGATION --- */
        function showPanel(id) {
            document.querySelectorAll('.panel-box').forEach(p => p.classList.add('hidden'));
            document.getElementById('panel-'+id).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        /* --- DATA HANDLING --- */
        function loadSettings() {
            const savedRubric = document.getElementById('conf-rubric').value;
            try {
                state.rubric = JSON.parse(savedRubric);
            } catch(e) {
                console.error("Rubric JSON Error");
            }
        }

        function saveSettings() {
            loadSettings();
            renderRubricTable();
            alert("Settings Saved!");
        }

        function renderStudentTable() {
            const tbody = document.querySelector('#student-table tbody');
            tbody.innerHTML = "";
            state.students.forEach((s, idx) => {
                let row = `<tr>
                    <td>${s.id}</td>
                    <td>${s.name}</td>
                    <td>${s.group}</td>
                    <td>${s.inst}</td>
                    <td><button class="btn-green" onclick="selectStudent(${idx})">JUDGE</button></td>
                </tr>`;
                tbody.innerHTML += row;
            });
        }

        function selectStudent(idx) {
            state.currentStudent = state.students[idx];
            
            // Update UI
            document.getElementById('panel-students').classList.add('hidden');
            document.getElementById('panel-control').classList.remove('hidden');
            document.getElementById('active-student-area').classList.remove('hidden');
            
            document.getElementById('live-name').innerText = state.currentStudent.name;
            document.getElementById('live-details').innerText = `ID: ${state.currentStudent.id} | ${state.currentStudent.inst}`;
            
            // Reset Scoring
            renderRubricTable();
            generateGrid(); 
            
            // Update Screen
            sendToScreen('UPDATE_INFO');
        }

        /* --- SCORING LOGIC --- */
        function renderRubricTable() {
            const tbody = document.getElementById('rubric-body');
            tbody.innerHTML = "";
            state.rubric.forEach((cat, idx) => {
                let row = `
                <tr>
                    <td>${cat.name}</td>
                    <td class="bold">${cat.max}</td>
                    <td>
                        <div class="score-ctrl">
                            <button class="deduct-btn" onclick="adjustScore(${idx}, -0.5)">-0.5</button>
                            <button class="deduct-btn" onclick="adjustScore(${idx}, -1.0)">-1</button>
                            <button class="deduct-btn" onclick="adjustScore(${idx}, -2.0)">-2</button>
                            <button class="deduct-btn" style="border-color:#555; color:#aaa; background:#222;" onclick="resetRow(${idx})">‚Ü∫</button>
                        </div>
                    </td>
                    <td>
                        <div id="score-${idx}" class="score-display">${cat.max}</div>
                    </td>
                </tr>`;
                tbody.innerHTML += row;
            });
            updateTotal();
        }

        function adjustScore(idx, amount) {
            const disp = document.getElementById(`score-${idx}`);
            let current = parseFloat(disp.innerText);
            let max = state.rubric[idx].max;
            let newVal = current + amount;
            if(newVal < 0) newVal = 0;
            if(newVal > max) newVal = max;
            disp.innerText = newVal;
            updateTotal();
        }

        function resetRow(idx) {
            document.getElementById(`score-${idx}`).innerText = state.rubric[idx].max;
            updateTotal();
        }

        function updateTotal() {
            let total = 0;
            state.rubric.forEach((cat, idx) => {
                total += parseFloat(document.getElementById(`score-${idx}`).innerText);
            });
            document.getElementById('live-total-score').innerText = total.toFixed(2);
        }

        function saveResult() {
            if(!state.currentStudent) return;
            
            const total = document.getElementById('live-total-score').innerText;
            const result = {
                ...state.currentStudent,
                score: parseFloat(total),
                breakdown: state.rubric.map((r, i) => ({
                    cat: r.name,
                    score: document.getElementById(`score-${i}`).innerText
                })),
                timestamp: new Date().toISOString()
            };
            
            state.results.push(result);
            localStorage.setItem('rasfahi_results', JSON.stringify(state.results));
            
            updateDashboard();
            alert("Result Saved Successfully!");
            
            // Reset
            state.currentStudent = null;
            document.getElementById('active-student-area').classList.add('hidden');
            showPanel('students');
        }

        /* --- GRID LOGIC --- */
        function generateGrid() {
            const container = document.getElementById('grid-container');
            container.innerHTML = "";
            state.gridTaken = [];
            for(let i=1; i<=20; i++) {
                let div = document.createElement('div');
                div.className = 'grid-cell';
                div.innerText = i;
                div.onclick = function() {
                    if(div.classList.contains('taken')) return;
                    document.querySelectorAll('.grid-cell').forEach(c => c.classList.remove('selected'));
                    div.classList.add('selected');
                    document.getElementById('selected-q-display').innerText = `Selected Question: ${i}`;
                    state.selectedQ = i;
                };
                container.appendChild(div);
            }
        }

        /* --- MULTI-WINDOW LOGIC --- */
        function launchScreens() {
            // Open Student Window
            const studentHTML = document.getElementById('student-window-template').innerHTML;
            const win = window.open("", "RasfahiStudent", "width=1280,height=720");
            win.document.write(studentHTML);
            childWindows.student = win;
        }

        function sendToScreen(action) {
            if(!childWindows.student || childWindows.student.closed) {
                alert("Student screen is not open! Click 'Launch Screens'.");
                return;
            }

            let payload = {
                name: state.currentStudent ? state.currentStudent.name : "",
                mode: action,
                taken: state.gridTaken
            };

            if(action === 'QUESTION') {
                 // Mark grid as taken
                 if(state.selectedQ) {
                     state.gridTaken.push(state.selectedQ);
                     // Update Admin Grid UI
                     const cells = document.querySelectorAll('.grid-cell');
                     cells[state.selectedQ-1].classList.add('taken');
                     cells[state.selectedQ-1].classList.remove('selected');
                 }
            }

            childWindows.student.updateDisplay(payload);
        }

        /* --- REPORTING --- */
        function generateReport(type) {
            let data = [...state.results];
            data.sort((a,b) => b.score - a.score); // Sort Descending
            
            if(type === 'top3') data = data.slice(0, 3);
            if(type === 'top5') data = data.slice(0, 5);
            
            let html = `
                <div style="text-align:center; padding:20px; border:2px double #000;">
                    <h1 style="text-transform:uppercase;">Rasfahi Quran Competition</h1>
                    <h3>Official Result Sheet (${type.toUpperCase()})</h3>
                    <table style="width:100%; border-collapse:collapse; margin-top:20px;">
                        <tr style="background:#eee;">
                            <th style="border:1px solid #000; padding:10px;">Rank</th>
                            <th style="border:1px solid #000; padding:10px;">Name</th>
                            <th style="border:1px solid #000; padding:10px;">Institution</th>
                            <th style="border:1px solid #000; padding:10px;">Score</th>
                        </tr>
            `;
            
            data.forEach((r, i) => {
                html += `
                    <tr>
                        <td style="border:1px solid #000; padding:10px; text-align:center;">${i+1}</td>
                        <td style="border:1px solid #000; padding:10px;">${r.name}</td>
                        <td style="border:1px solid #000; padding:10px;">${r.inst}</td>
                        <td style="border:1px solid #000; padding:10px; text-align:center; font-weight:bold;">${r.score}</td>
                    </tr>
                `;
            });
            
            html += `</table>
                <div style="margin-top:50px; display:flex; justify-content:space-between;">
                    <div>Judge 1: ________</div>
                    <div>Judge 2: ________</div>
                    <div>Chief Judge: ________</div>
                </div>
            </div>`;
            
            const preview = document.getElementById('report-preview');
            preview.innerHTML = html;
        }
        
        function exportCSV() {
            let csv = "Rank,Name,ID,Institution,Score\n";
            let data = [...state.results].sort((a,b) => b.score - a.score);
            data.forEach((r, i) => {
                csv += `${i+1},"${r.name}","${r.id}","${r.inst}",${r.score}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "Rasfahi_Results.csv";
            a.click();
        }

        /* --- UTILS --- */
        function updateDashboard() {
            document.getElementById('stat-total').innerText = state.students.length;
            document.getElementById('stat-completed').innerText = state.results.length;
            document.getElementById('stat-pending').innerText = state.students.length - state.results.length;
        }

        function startClock() {
            setInterval(() => {
                const now = new Date();
                document.getElementById('clock').innerText = now.toLocaleTimeString();
            }, 1000);
        }

        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }
        
        function filterStudents() {
            const term = document.getElementById('search-box').value.toLowerCase();
            const grp = document.getElementById('filter-group').value;
            const inst = document.getElementById('filter-inst').value;
            
            const rows = document.querySelectorAll('#student-table tbody tr');
            state.students.forEach((s, i) => {
                let textMatch = s.name.toLowerCase().includes(term) || s.id.toLowerCase().includes(term);
                let grpMatch = grp === 'All' || s.group === grp;
                let instMatch = inst === 'All' || s.inst.includes(inst); // Simple contains check
                
                if(textMatch && grpMatch && instMatch) {
                    rows[i].classList.remove('hidden');
                } else {
                    rows[i].classList.add('hidden');
                }
            });
        }
        
        function setLang(lang) {
            const titles = {
                dv: "ﬁÉﬁ¶ﬁêﬁ∞ﬁäﬁ¶ﬁÄﬁ® ﬁñﬁ¶ﬁñﬁ®ﬁÇﬁ∞ﬁé",
                en: "Rasfahi Judging",
                ar: "ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ™ÿ≠ŸÉŸäŸÖ"
            };
            document.querySelector('.logo-area h1').innerText = titles[lang];
            document.dir = (lang === 'en') ? 'ltr' : 'rtl';
        }

    </script>
</body>
</html>
