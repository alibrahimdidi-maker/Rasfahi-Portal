<!DOCTYPE html>
<html lang="dv" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rasfahi Ultimate Event System (MAXIMUM EDITION)</title>
    <style>
        /* =========================================
           1. GLOBAL STYLES & FONTS
           ========================================= */
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Amiri:wght@400;700&family=Noto+Sans+Thaana:wght@400;700&display=swap');

        :root {
            --gold: #D4AF37;
            --gold-dim: #aa8c2c;
            --gold-bright: #FFD700;
            --bg-dark: #0a0a0a;
            --panel-bg: #141414;
            --border-color: #333;
            --royal-blue: #001a33;
        }

        * { box-sizing: border-box; outline: none; user-select: none; }

        body {
            margin: 0; padding: 0;
            background: radial-gradient(circle at center, #1a0f00 0%, #000000 100%);
            color: #fff;
            height: 100vh; width: 100vw;
            overflow: hidden;
            font-family: 'Noto Sans Thaana', 'Cinzel', sans-serif;
            display: flex;
        }

        /* =========================================
           2. SIDEBAR & LAYOUT
           ========================================= */
        .sidebar {
            width: 450px;
            background: rgba(10, 10, 10, 0.95);
            border-left: 3px solid var(--gold);
            display: flex; flex-direction: column;
            box-shadow: 10px 0 30px rgba(0,0,0,0.8);
            z-index: 100;
        }

        .header {
            padding: 20px; text-align: center;
            border-bottom: 2px solid var(--gold);
            background: linear-gradient(to bottom, #222, #111);
        }

        .app-title {
            color: var(--gold); font-size: 24px; font-weight: 900;
            text-transform: uppercase; letter-spacing: 2px;
            text-shadow: 0 2px 5px #000;
        }

        .content-area {
            flex: 1; overflow-y: auto; padding: 15px;
        }

        .main-display {
            flex: 1; position: relative;
            background-image: radial-gradient(rgba(212, 175, 55, 0.1) 1px, transparent 1px);
            background-size: 40px 40px;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }

        /* =========================================
           3. UI COMPONENTS (Buttons, Inputs, Panels)
           ========================================= */
        .panel {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-color);
            border-radius: 8px; padding: 15px;
            margin-bottom: 15px;
            transition: 0.3s;
        }
        .panel:hover { border-color: var(--gold-dim); }

        h3 {
            color: var(--gold); margin: 0 0 10px 0;
            font-size: 14px; text-transform: uppercase;
            border-bottom: 1px dashed #444; padding-bottom: 5px;
        }

        .row { display: flex; gap: 5px; margin-bottom: 5px; }

        button {
            padding: 10px; cursor: pointer; border-radius: 4px;
            font-family: 'Noto Sans Thaana', sans-serif; font-weight: bold;
            border: 1px solid #444; color: #fff;
            background: linear-gradient(to bottom, #333, #222);
            flex: 1; transition: 0.2s; font-size: 13px;
        }
        button:hover { transform: translateY(-2px); filter: brightness(1.2); }
        button:active { transform: translateY(0); }

        .btn-gold { background: linear-gradient(to bottom, #D4AF37, #997510) !important; color: #000 !important; border-color: #fff !important; font-weight: 900; }
        .btn-red { background: linear-gradient(to bottom, #600, #300) !important; border-color: #900 !important; }
        .btn-green { background: linear-gradient(to bottom, #060, #030) !important; border-color: #090 !important; }
        .btn-blue { background: linear-gradient(to bottom, #004, #002) !important; border-color: #006 !important; }

        input, select {
            width: 100%; padding: 8px; background: #000;
            border: 1px solid #444; color: #fff;
            border-radius: 4px; margin-bottom: 5px;
            font-family: 'Noto Sans Thaana';
        }
        input:focus { border-color: var(--gold); }

        /* TABS */
        .tabs { display: flex; border-bottom: 1px solid #444; margin-bottom: 15px; }
        .tab-btn {
            background: transparent; border: none; color: #888;
            padding: 10px; border-bottom: 3px solid transparent;
            border-radius: 0;
        }
        .tab-btn.active { color: var(--gold); border-bottom-color: var(--gold); background: rgba(212,175,55,0.05); }

        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* =========================================
           4. GRID OVERLAY & STUDENT CARD
           ========================================= */
        #gridOverlay {
            display: none; position: absolute;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 800px; padding: 30px;
            background: rgba(0,0,0,0.95);
            border: 4px double var(--gold);
            border-radius: 15px; z-index: 200;
            grid-template-columns: repeat(5, 1fr); gap: 15px;
            box-shadow: 0 0 100px rgba(0,0,0,0.8);
        }

        .grid-num {
            height: 100px; font-size: 32px; font-weight: bold;
            background: #111; border: 2px solid #444; color: var(--gold);
            cursor: pointer; transition: 0.3s;
            font-family: 'Cinzel';
        }
        .grid-num:hover { background: var(--gold); color: #000; transform: scale(1.1); box-shadow: 0 0 20px var(--gold); }
        .grid-num.used { background: #300; border-color: #500; color: #666; pointer-events: none; opacity: 0.5; }

        /* Student Preview Card */
        .stu-preview {
            width: 90%; background: linear-gradient(90deg, #001a33, #000);
            border: 2px solid var(--gold); border-radius: 10px;
            padding: 20px; display: flex; align-items: center; gap: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .stu-img-lg { width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--gold); object-fit: cover; }
        
        /* Control Panel Detailed View */
        .control-stu-info {
            display: flex; gap: 10px; margin-top: 10px; padding: 10px;
            background: #000; border: 1px solid #333; border-radius: 5px;
        }
        .control-stu-img {
            width: 60px; height: 60px; object-fit: cover; border-radius: 4px; border: 1px solid #555;
        }
        .control-details { font-size: 11px; color: #ccc; line-height: 1.4; }
        .control-details strong { color: var(--gold); }
        
        /* =========================================
           5. PRINT STYLES
           ========================================= */
        @media print {
            body * { visibility: hidden; }
            #printArea, #printArea * { visibility: visible; }
            #printArea { position: absolute; left: 0; top: 0; width: 100%; color: #000; background: #fff; }
        }

    </style>
</head>
<body>

    <div class="sidebar">
        <div class="header">
            <div class="app-title">RASFAHI EVENT SUITE</div>
            <div style="font-size:11px; color:#666; margin-top:5px;">MAXIMUM INTEGRATED EDITION</div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="setTab('ctrl')">CONTROL</button>
            <button class="tab-btn" onclick="setTab('stud')">STUDENTS</button>
            <button class="tab-btn" onclick="setTab('judg')">JUDGES</button>
            <button class="tab-btn" onclick="setTab('quran')">QURAN</button>
        </div>

        <div class="content-area">
            
            <div id="ctrl" class="tab-content active">
                <div class="panel">
                    <h3>1. SELECT STUDENT</h3>
                    <select id="mainStuSelect" onchange="previewStudent()"></select>
                    
                    <div id="detailedStuView" style="display:none;" class="control-stu-info">
                        <img id="ctrlImg" src="" class="control-stu-img">
                        <div class="control-details" id="ctrlDetails"></div>
                    </div>

                    <div id="miniStuInfo" style="font-size:11px; color:#aaa; margin-bottom:5px; margin-top:5px; text-align:center;">No student selected</div>
                    <button class="btn-gold" onclick="sendToStage()">üöÄ SEND TO STAGE & JUDGES</button>
                </div>

                <div class="panel">
                    <h3>2. QUESTION SELECTION</h3>
                    <div class="row">
                        <button class="btn-blue" onclick="toggleGrid()">üî¢ OPEN GRID (1-20)</button>
                        <button onclick="document.getElementById('qCsv').click()">üìÇ LOAD Q-CSV</button>
                        <input type="file" id="qCsv" hidden accept=".csv" onchange="loadQuestions(this)">
                    </div>
                    <select id="qSelect" onchange="previewQuestion()"><option>-- Manual Select --</option></select>
                </div>

                <div class="panel">
                    <h3>3. SCREEN MODE</h3>
                    <div class="row">
                        <button onclick="setMode('cover')">TITLE</button>
                        <button onclick="setMode('student')">STUDENT</button>
                        <button onclick="setMode('quran')">QURAN</button>
                        <button class="btn-red" onclick="setMode('black')">BLACK</button>
                    </div>
                    <button class="btn-gold" style="margin-top:5px;" onclick="launchProjector()">üì∫ LAUNCH PROJECTOR</button>
                </div>
            </div>

            <div id="stud" class="tab-content">
                <div class="panel">
                    <h3>DATABASE MANAGEMENT</h3>
                    <p style="font-size:11px; color:#aaa;">Import the "Master Data" CSV file to populate the list. Includes Full Info & Photos.</p>
                    <button class="btn-green" onclick="downloadSample()">‚¨áÔ∏è 1. DOWNLOAD MASTER CSV TEMPLATE</button>
                    <div style="height:10px;"></div>
                    <button class="btn-blue" onclick="document.getElementById('sCsv').click()">üìÇ 2. IMPORT MASTER DATA</button>
                    <input type="file" id="sCsv" hidden accept=".csv" onchange="loadStudents(this)">
                    
                    <div style="margin-top:15px; border-top:1px dashed #444; padding-top:10px;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span id="stuCount" style="color:var(--gold);">0 Students</span>
                            <button class="btn-red" style="width:auto; padding:5px 10px;" onclick="clearData()">CLEAR</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="judg" class="tab-content">
                <div class="panel">
                    <h3>JUDGE MONITORS</h3>
                    <p style="font-size:11px; color:#aaa;">Open a window for each judge. They will sync automatically.</p>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
                        <button onclick="openJudge(1)">JUDGE 1</button>
                        <button onclick="openJudge(2)">JUDGE 2</button>
                        <button onclick="openJudge(3)">JUDGE 3</button>
                        <button onclick="openJudge(4)">JUDGE 4</button>
                        <button onclick="openJudge(5)">JUDGE 5</button>
                        <button class="btn-gold" onclick="openChief()">CHIEF JUDGE</button>
                    </div>
                </div>

                <div class="panel">
                    <h3>SCORING & REPORTS</h3>
                    <button class="btn-green" onclick="exportFullResults()">üìä DOWNLOAD FULL RESULT MASTER (CSV)</button>
                     <div style="height:5px;"></div>
                    <button class="btn-blue" onclick="generateReport()">üìÑ PRINT OFFICIAL MARKSHEET</button>
                    <button class="btn-red" style="margin-top:5px;" onclick="resetMarks()">‚ö†Ô∏è RESET ALL SCORES</button>
                </div>
            </div>

            <div id="quran" class="tab-content">
                <div class="panel">
                    <h3>DISPLAY CONFIG</h3>
                    <label>Font Size (VW):</label>
                    <input type="range" id="fSize" min="2" max="6" step="0.1" value="3.5" oninput="updateSettings()">
                    <label>Lines Per Page:</label>
                    <input type="number" id="lPage" value="8" onchange="updateSettings()">
                    <label>Translation Mode:</label>
                    <select onchange="updateSettings()" id="tMode">
                        <option value="none">Arabic Only</option>
                        <option value="both">With Translation</option>
                    </select>
                </div>
            </div>

        </div>
    </div>

    <div class="main-display">
        <div style="position:absolute; top:20px; color:var(--gold); font-size:12px; letter-spacing:2px;">LIVE MONITOR PREVIEW</div>
        <div id="previewBox" style="text-align:center; width:100%;">
            <h1 style="color:#333;">SYSTEM READY</h1>
        </div>
    </div>

    <div id="gridOverlay"></div>

    <div id="printArea" style="display:none;"></div>

    <script>
        // =========================================
        // 1. DATA & STATE MANAGEMENT
        // =========================================
        let DB = {
            students: JSON.parse(localStorage.getItem('rasfahi_students')) || [],
            questions: [],
            marks: JSON.parse(localStorage.getItem('rasfahi_marks')) || {},
            config: { font: 3.5, lines: 8, trans: 'none' }
        };

        let STATE = {
            screen: 'cover',
            activeStudent: null,
            activeQuestion: null
        };

        // Initialize
        window.onload = () => {
            refreshStuDropdown();
            buildGrid();
            window.addEventListener('storage', syncHandler); // Listen for updates from other windows
        };

        function syncHandler(e) {
            if(e.key === 'rasfahi_marks') DB.marks = JSON.parse(e.newValue);
        }

        function saveData() {
            localStorage.setItem('rasfahi_students', JSON.stringify(DB.students));
            localStorage.setItem('rasfahi_marks', JSON.stringify(DB.marks));
        }

        function setTab(id) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.target.classList.add('active');
        }

        // =========================================
        // 2. STUDENT HANDLING (FULL CSV SUPPORT)
        // =========================================
        
        function downloadSample() {
            // Full requested headers for Master CSV as per your instructions
            const headers = [
                "SerialNo", 
                "FullName", 
                "Gender(M/F)", 
                "IDCardNo", 
                "RegNo", 
                "PermAddress", 
                "Phone", 
                "GuardianName", 
                "GuardianPhone", 
                "Email", 
                "Relationship", 
                "Branch(Balayegen/Nubalai)", 
                "AgeGroup", 
                "InstitutionName", 
                "InstType(School/Uni/Club/Pvt)", 
                "Hafiz(Yes/No)", 
                "ImageURL",
                // Extra columns for manual checking/legacy
                "Mark_Res1", "Mark_Res2", "Mark_Res3", "Mark_Res4", "Mark_Res5", 
                "Mark_Res6", "Mark_Res7", "Mark_Res8", "Mark_Res9", "Mark_Res10",
                "Mark_Res11", "Mark_Res12", "Mark_Res13", "Mark_Res14", "Mark_Res15",
                "Total_J1", "Total_J2", "Total_J3", "Total_J4", "Total_J5", 
                "GrandTotal", "Average", "FinalRank"
            ];
            
            let csvContent = headers.join(",") + "\n";
            // Detailed Dummy Data Row for testing
            csvContent += "1,Ali Ahmed,M,A123456,REG001,M.Rose,7771234,Ahmed Solih,7775555,ali@mail.com,Father,Balayegen,Under 13,Iskandhar School,School,No,https://via.placeholder.com/150,,,,,,,,,,,,,,,,,,,,,,,\n";
            csvContent += "2,Fathimath Ziyadha,F,A987654,REG002,H.Sunbeam,9991234,Aishath Reena,9995555,fathu@mail.com,Mother,Nubalai,Under 16,Quran Centre,Uni,No,https://via.placeholder.com/150,,,,,,,,,,,,,,,,,,,,,,,\n";
            
            const blob = new Blob([csvContent], {type: 'text/csv'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'Rasfahi_Full_Master_Database.csv';
            a.click();
        }

        function loadStudents(input) {
            const r = new FileReader();
            r.onload = e => {
                const rows = e.target.result.split('\n');
                let count = 0;
                let newS = [];
                
                rows.forEach((row, i) => {
                    if (i === 0 || !row.trim()) return; // Skip header
                    const c = row.split(','); 
                    if (c.length > 5) { 
                        newS.push({
                            serial: c[0]?.trim(),
                            name: c[1]?.trim(),
                            gender: c[2]?.trim(),
                            id: c[3]?.trim(),
                            regNo: c[4]?.trim(),
                            address: c[5]?.trim(),
                            phone: c[6]?.trim(),
                            guardian: c[7]?.trim(),
                            gPhone: c[8]?.trim(),
                            email: c[9]?.trim(),
                            relation: c[10]?.trim(),
                            branch: c[11]?.trim(),
                            ageGroup: c[12]?.trim(),
                            institution: c[13]?.trim(),
                            instType: c[14]?.trim(),
                            hafiz: c[15]?.trim(),
                            img: c[16]?.trim() || 'https://via.placeholder.com/150'
                        });
                        count++;
                    }
                });

                if (count > 0) {
                    if(confirm(`Found ${count} students. Update Database?`)) {
                        DB.students = newS;
                        saveData();
                        refreshStuDropdown();
                        alert("Database Updated Successfully!");
                    }
                } else {
                    alert("No valid data found in CSV.");
                }
            };
            r.readAsText(input.files[0]);
        }

        function refreshStuDropdown() {
            const s = document.getElementById('mainStuSelect');
            s.innerHTML = '<option value="">-- Select Student --</option>';
            DB.students.forEach((stu, i) => {
                s.add(new Option(`${stu.serial || i+1}. ${stu.name} (${stu.branch})`, i));
            });
            document.getElementById('stuCount').innerText = DB.students.length + " Students";
        }

        function previewStudent() {
            const idx = document.getElementById('mainStuSelect').value;
            const detView = document.getElementById('detailedStuView');
            
            if(idx === "") {
                detView.style.display = 'none';
                document.getElementById('miniStuInfo').innerText = "No student selected";
                STATE.activeStudent = null;
                return;
            }

            const stu = DB.students[idx];
            STATE.activeStudent = stu;
            detView.style.display = 'flex';
            document.getElementById('ctrlImg').src = stu.img;
            document.getElementById('ctrlDetails').innerHTML = `
                <strong>${stu.name}</strong><br>
                ID: ${stu.id} | Reg: ${stu.regNo}<br>
                Branch: <span style="color:#D4AF37">${stu.branch}</span><br>
                Cat: ${stu.ageGroup} | ${stu.institution}
            `;
            document.getElementById('miniStuInfo').innerText = `${stu.branch} | ${stu.institution}`;
        }

        function sendToStage() {
            if(!STATE.activeStudent) return alert("Please select a student first.");
            localStorage.setItem('rasfahi_live_student', JSON.stringify(STATE.activeStudent));
            setMode('student');
        }

        function clearData() {
            if(confirm("DELETE ALL STUDENTS?")) {
                DB.students = [];
                DB.marks = {}; 
                saveData();
                refreshStuDropdown();
                document.getElementById('detailedStuView').style.display = 'none';
            }
        }

        // =========================================
        // 3. QUESTION & GRID SYSTEM
        // =========================================
        function buildGrid() {
            const g = document.getElementById('gridOverlay');
            g.innerHTML = `<button onclick="toggleGrid()" style="position:absolute;top:10px;right:10px;background:#500;width:40px;height:40px;border-radius:50%;">‚úï</button>`;
            for(let i=1; i<=20; i++) {
                const b = document.createElement('div');
                b.className = 'grid-num';
                b.innerText = i;
                b.onclick = () => activateQuestion(i, b);
                g.appendChild(b);
            }
        }

        function toggleGrid() {
            const g = document.getElementById('gridOverlay');
            g.style.display = g.style.display === 'grid' ? 'none' : 'grid';
        }

        function loadQuestions(input) {
            const r = new FileReader();
            r.onload = e => {
                const rows = e.target.result.split('\n');
                DB.questions = rows.map(row => {
                    const c = row.split(',');
                    return { id: c[0], type: c[1], content: c[2] };
                }).filter(q => q.id); 
                
                const sel = document.getElementById('qSelect');
                sel.innerHTML = '<option>-- Manual Select --</option>';
                DB.questions.forEach(q => {
                    sel.add(new Option(`Q${q.id} (${q.type})`, q.id));
                });
                alert("Questions Loaded: " + DB.questions.length);
            };
            r.readAsText(input.files[0]);
        }

        function activateQuestion(id, btnElement) {
            let q = DB.questions.find(x => x.id == id);
            if(!q) q = { id: id, type: 'General', content: `[DEMO] Question ${id} content...` };
            STATE.activeQuestion = q;
            if(btnElement) btnElement.classList.add('used');
            toggleGrid();
            localStorage.setItem('rasfahi_live_question', JSON.stringify(q));
            setMode('quran');
        }

        function previewQuestion() {
            activateQuestion(document.getElementById('qSelect').value, null);
        }

        // =========================================
        // 4. SCREEN & PROJECTOR LOGIC
        // =========================================
        function setMode(mode) {
            STATE.screen = mode;
            localStorage.setItem('rasfahi_screen_mode', mode);
            renderPreview();
        }

        function updateSettings() {
            DB.config.font = document.getElementById('fSize').value;
            DB.config.lines = document.getElementById('lPage').value;
            localStorage.setItem('rasfahi_config', JSON.stringify(DB.config));
            renderPreview();
        }

        function renderPreview() {
            const box = document.getElementById('previewBox');
            box.innerHTML = '';
            if (STATE.screen === 'cover') {
                box.innerHTML = `<h1 style="color:var(--gold); font-size:40px;">RASFAHI EVENT 2026</h1><h3 style="color:#aaa;">QURAN COMPETITION</h3>`;
            } 
            else if (STATE.screen === 'black') {
                box.innerHTML = `<div style="color:#333;">[BLACK SCREEN]</div>`;
            }
            else if (STATE.screen === 'student' && STATE.activeStudent) {
                const s = STATE.activeStudent;
                box.innerHTML = `
                    <div class="stu-preview">
                        <img src="${s.img}" class="stu-img-lg">
                        <div style="text-align:left;">
                            <div style="font-size:24px; color:var(--gold); font-weight:bold;">${s.name}</div>
                            <div style="color:#fff;">${s.branch} | ${s.ageGroup}</div>
                            <div style="color:#888; font-size:12px;">${s.institution}</div>
                        </div>
                    </div>`;
            }
            else if (STATE.screen === 'quran' && STATE.activeQuestion) {
                const q = STATE.activeQuestion;
                if (q.content && (q.content.toLowerCase().endsWith('.png') || q.content.toLowerCase().endsWith('.jpg'))) {
                    box.innerHTML = `<img src="${q.content}" style="max-height:300px; border:2px solid var(--gold);">`;
                } else {
                    box.innerHTML = `<div style="font-family:'Amiri'; font-size:${DB.config.font}vw; line-height:1.6; padding:20px; direction:rtl;">${q.content}</div>`;
                }
            }
        }

        function launchProjector() {
            const win = window.open("", "Projector", "width=1280,height=720");
            injectWindowCode(win, 'projector', 0);
        }

        function openJudge(id) {
            const win = window.open("", "Judge"+id, "width=1000,height=850");
            injectWindowCode(win, 'judge', id);
        }

        function openChief() {
            const win = window.open("", "ChiefJudge", "width=1100,height=850");
            injectWindowCode(win, 'chief', 0);
        }

        // =========================================
        // 5. CHILD WINDOW INJECTOR (COMPLETE LOGIC)
        // =========================================
        function injectWindowCode(w, type, id) {
            const isProj = type === 'projector';
            const bg = isProj ? '#000' : '#141414';
            
            const html = `
            <!DOCTYPE html>
            <html lang="dv" dir="rtl">
            <head>
                <title>${type.toUpperCase()} ${id}</title>
                <style>
                    @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Noto+Sans+Thaana:wght@400;700&display=swap');
                    body { margin:0; background: ${bg}; color: #fff; font-family: 'Noto Sans Thaana'; display:flex; flex-direction:column; height:100vh; overflow:hidden; }
                    .header { background: #000; border-bottom: 2px solid #D4AF37; padding: 10px; display: flex; justify-content: space-between; align-items: center; height: 90px; }
                    
                    .stu-badge { display: flex; align-items: center; gap: 15px; width: 100%; }
                    .stu-badge img { height: 70px; width: 70px; border-radius: 5px; border: 2px solid #D4AF37; object-fit: cover; }
                    .stu-info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 12px; color: #ccc; width: 100%; margin-left: 20px;}
                    
                    .container { flex: 1; display: flex; height: calc(100vh - 92px); }
                    .quran-area { flex: 2; display: flex; align-items: center; justify-content: center; text-align: center; padding: 20px; overflow-y: auto; position: relative; }
                    .judge-sidebar { 
                        flex: ${isProj ? '0' : '1'}; 
                        background: #1a1a1a; 
                        border-right: 2px solid #333; 
                        padding: 15px; 
                        overflow-y: auto; 
                        display: ${isProj ? 'none' : 'block'};
                        min-width: 450px; 
                    }
                    
                    /* DEDUCTION STYLES */
                    .rubric-item { background: #222; padding: 10px; margin-bottom: 8px; border-radius: 6px; border:1px solid #333; }
                    .rubric-header { display:flex; justify-content:space-between; margin-bottom:5px; align-items:center; }
                    .deduct-bar { display:flex; gap:5px; background:#111; padding:5px; border-radius:4px; }
                    
                    /* Small specific buttons */
                    .d-btn-sm { background: #400; border:1px solid #600; color:#fff; font-size:10px; cursor:pointer; padding:3px 8px; border-radius:3px; }
                    .d-btn-sm:active { background: #f00; transform:scale(0.95); }
                    
                    /* Large general buttons */
                    .deduct-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-bottom: 10px; }
                    .d-btn { background: #400; color: #fff; border: 1px solid #600; cursor: pointer; padding: 5px; font-size: 11px; }
                    .d-btn:hover { background: #600; }

                    .score-inp { width: 70px; padding: 5px; background: #000; border: 1px solid #D4AF37; color: #D4AF37; text-align: center; font-weight: bold; font-size: 18px; }
                    .proj-title { font-size: 5vw; color: #D4AF37; font-family: 'Cinzel'; text-shadow: 0 0 20px rgba(212,175,55,0.5); }
                    .proj-stu-card { background: linear-gradient(90deg, #001a33, #000); border: 4px double #D4AF37; padding: 40px; border-radius: 20px; display: flex; align-items: center; gap: 30px; transform: scale(1.2); }
                </style>
            </head>
            <body>
                ${!isProj ? `
                <div class="header">
                    <div class="stu-badge" id="headInfo"><div style="color:#666;">Waiting...</div></div>
                    <div style="text-align:left; min-width:150px;">
                        <div style="font-weight:bold; color:#D4AF37;">${type === 'chief' ? 'CHIEF' : 'JUDGE ' + id}</div>
                    </div>
                </div>` : ''}

                <div class="container">
                    <div class="judge-sidebar">
                        ${!isProj ? getJudgeHTML(id) : ''}
                    </div>
                    <div class="quran-area" id="quranView">
                        ${isProj ? '<div class="proj-title">RASFAHI EVENT</div>' : '<div style="color:#555;">Waiting...</div>'}
                    </div>
                </div>

                <script>
                    let judgeId = ${id};
                    window.addEventListener('storage', (e) => {
                        if(e.key === 'rasfahi_live_student') updateStudent(JSON.parse(e.newValue));
                        if(e.key === 'rasfahi_live_question') updateQuran(JSON.parse(e.newValue));
                        if(e.key === 'rasfahi_screen_mode') updateScreen(e.newValue);
                    });

                    // LOAD INITIAL STATE
                    const initS = localStorage.getItem('rasfahi_live_student');
                    if(initS) updateStudent(JSON.parse(initS));
                    const initQ = localStorage.getItem('rasfahi_live_question');
                    if(initQ) updateQuran(JSON.parse(initQ));

                    function updateStudent(s) {
                        const h = document.getElementById('headInfo');
                        if(h) h.innerHTML = \`<img src="\${s.img}" onerror="this.src='https://via.placeholder.com/70'"> <div class="stu-info-grid"><div>\${s.name}</div><div>\${s.branch}</div><div>\${s.ageGroup}</div></div>\`;
                    }

                    function updateQuran(q) {
                        const v = document.getElementById('quranView');
                        let html = '';
                        if(q.content && q.content.toLowerCase().match(/\\.(jpeg|jpg|png)$/)) {
                            html = '<img src="'+q.content+'" style="max-height:80vh; max-width:90%; border:5px solid #D4AF37;">';
                        } else {
                            html = '<div style="font-family:Amiri; direction:rtl; font-size:3.5vw; line-height:1.8;">'+q.content+'</div>';
                        }
                        if('${type}' !== 'projector') v.innerHTML = html;
                        else window.pendingQuran = html;
                    }

                    function updateScreen(mode) {
                        if('${type}' !== 'projector') return;
                        const v = document.getElementById('quranView');
                        v.innerHTML = ''; 
                        if(mode === 'cover') v.innerHTML = '<div class="proj-title">QURAN COMPETITION</div>';
                        else if(mode === 'student') {
                             const s = JSON.parse(localStorage.getItem('rasfahi_live_student'));
                             v.innerHTML = '<div class="proj-stu-card"><img src="'+s.img+'" style="height:150px;width:150px;border-radius:50%;"><div><h1 style="color:#D4AF37;">'+s.name+'</h1><h3>'+s.branch+'</h3></div></div>';
                        }
                        else if(mode === 'quran') v.innerHTML = window.pendingQuran || '';
                    }

                    // --- GENERAL DEDUCTION LOGIC (Log Only) ---
                    function deduct(amt, reason) {
                        const log = document.getElementById('dLog');
                        const current = log.value;
                        log.value = reason + ' (-' + amt + ')\\n' + current;
                    }

                    // --- SPECIFIC RUBRIC DEDUCTION LOGIC ---
                    function applySpecificDeduct(inputId, amount) {
                        const inp = document.getElementById(inputId);
                        let val = parseFloat(inp.value) || 0;
                        val = val - amount; // Keeps subtracting
                        if(val < 0) val = 0; // Prevent negative
                        inp.value = val.toFixed(2);
                        calcTotal();
                    }

                    function calcTotal() {
                        let sum = 0;
                        for(let i=1; i<=7; i++) sum += parseFloat(document.getElementById('c'+i).value) || 0;
                        document.getElementById('totalDisp').innerText = sum.toFixed(2);
                    }

                    function submitScore() {
                        const stu = JSON.parse(localStorage.getItem('rasfahi_live_student'));
                        if(!stu) return alert("No Student Active");
                        const scores = {};
                        let total = 0;
                        for(let i=1; i<=7; i++) {
                            let val = parseFloat(document.getElementById('c'+i).value) || 0;
                            scores['c'+i] = val;
                            total += val;
                        }
                        const payload = { 
                            judgeId: judgeId, 
                            studentId: stu.id, 
                            scores: scores, 
                            total: total,
                            deductions: document.getElementById('dLog').value,
                            remarks: document.getElementById('rem').value
                        };
                        let marks = JSON.parse(localStorage.getItem('rasfahi_marks')) || {};
                        if(!marks[stu.id]) marks[stu.id] = {};
                        marks[stu.id][judgeId] = payload;
                        localStorage.setItem('rasfahi_marks', JSON.stringify(marks));
                        alert("Scores Submitted! Total: " + total);
                    }
                <\/script>
            </body>
            </html>`;
            w.document.write(html);
        }

        // =========================================
        // 6. GENERATE JUDGE HTML STRING (WITH BOTH DEDUCTION TYPES)
        // =========================================
        function getJudgeHTML(id) {
            // Helper for Specific Deductions
            const mkBlock = (id, label, max) => `
                <div class="rubric-item">
                    <div class="rubric-header">
                        <label style="color:#D4AF37; font-weight:bold;">${label}</label>
                        <input type="number" id="${id}" class="score-inp" value="${max}" max="${max}" oninput="calcTotal()">
                    </div>
                    <div class="deduct-bar">
                        <span style="font-size:10px; color:#666; padding-top:4px;">DEDUCT:</span>
                        <button class="d-btn-sm" onclick="applySpecificDeduct('${id}', 0.25)">-0.25</button>
                        <button class="d-btn-sm" onclick="applySpecificDeduct('${id}', 0.5)">-0.5</button>
                        <button class="d-btn-sm" onclick="applySpecificDeduct('${id}', 1.0)">-1.0</button>
                        <button class="d-btn-sm" onclick="applySpecificDeduct('${id}', 2.0)">-2.0</button>
                    </div>
                </div>
            `;

            // I have restored the "General Deduction" block you liked, AND added the new specific buttons
            return `
            <div style="background:#222; padding:10px; border-radius:5px; margin-bottom:15px; border:1px solid #444;">
                <div style="font-size:12px; font-weight:bold; color:#aaa; margin-bottom:5px;">GENERAL DEDUCTIONS (LOG ONLY)</div>
                <div class="deduct-grid">
                    <button class="d-btn" onclick="deduct(0.25, 'Harakath')">-0.25</button>
                    <button class="d-btn" onclick="deduct(0.5, 'Tajweed')">-0.5</button>
                    <button class="d-btn" onclick="deduct(1.0, 'Word')">-1.0</button>
                    <button class="d-btn" onclick="deduct(2.0, 'Line')">-2.0</button>
                    <button class="d-btn" onclick="deduct(5.0, 'Stop')">-5.0</button>
                </div>
                <textarea id="dLog" style="width:100%; height:40px; background:#000; border:1px solid #333; color:#f88; font-size:11px;" placeholder="Deduction Log..." readonly></textarea>
            </div>

            <h3 style="color:#D4AF37; border-bottom:1px solid #555;">SCORING RUBRIC</h3>
            
            ${mkBlock('c1', '1. Thilawa / Tajweed (30)', 30)}
            ${mkBlock('c2', '2. Makhraj (20)', 20)}
            ${mkBlock('c3', '3. Sifa (20)', 20)}
            ${mkBlock('c4', '4. Fasaha (10)', 10)}
            ${mkBlock('c5', '5. Talaffuz (10)', 10)}
            ${mkBlock('c6', '6. Maqamat (5)', 5)}
            ${mkBlock('c7', '7. Ada (5)', 5)}

            <div style="margin-top:20px; text-align:right; border-top:2px solid #333; padding-top:10px;">
                <span style="font-size:14px; color:#aaa;">TOTAL SCORE: </span>
                <span id="totalDisp" style="font-size:32px; color:#D4AF37; font-weight:bold;">100.00</span>
            </div>
            
            <textarea id="rem" style="width:100%; height:60px; margin-top:10px; background:#111; border:1px solid #444; color:#fff;" placeholder="Remarks..."></textarea>

            <button onclick="submitScore()" style="width:100%; padding:15px; margin-top:15px; background:#D4AF37; color:#000; font-weight:bold; font-size:16px; border:none; border-radius:5px; cursor:pointer;">SUBMIT FINAL SCORE</button>
            `;
        }

        // =========================================
        // 7. EXPORT FULL RESULTS (FULL DETAILED CSV)
        // =========================================
        function exportFullResults() {
            if(DB.students.length === 0) return alert("No data to export.");

            // 1. Define Headers (Massive List for filtering)
            let headers = [
                "Rank", "Serial", "ID", "Name", "Branch", "AgeGroup", "Institution", "Gender", 
                // Judge 1
                "J1_Thilawa", "J1_Makhraj", "J1_Sifa", "J1_Fasaha", "J1_Talaffuz", "J1_Maqamat", "J1_Ada", "J1_TOTAL",
                // Judge 2
                "J2_Thilawa", "J2_Makhraj", "J2_Sifa", "J2_Fasaha", "J2_Talaffuz", "J2_Maqamat", "J2_Ada", "J2_TOTAL",
                // Judge 3
                "J3_Thilawa", "J3_Makhraj", "J3_Sifa", "J3_Fasaha", "J3_Talaffuz", "J3_Maqamat", "J3_Ada", "J3_TOTAL",
                // Judge 4
                "J4_Thilawa", "J4_Makhraj", "J4_Sifa", "J4_Fasaha", "J4_Talaffuz", "J4_Maqamat", "J4_Ada", "J4_TOTAL",
                // Judge 5
                "J5_Thilawa", "J5_Makhraj", "J5_Sifa", "J5_Fasaha", "J5_Talaffuz", "J5_Maqamat", "J5_Ada", "J5_TOTAL",
                // Final
                "GRAND_TOTAL", "AVERAGE_SCORE"
            ];

            // 2. Process Data
            let processedData = DB.students.map(s => {
                const sMarks = DB.marks[s.id] || {};
                let row = {
                    serial: s.serial, id: s.id, name: s.name, branch: s.branch, age: s.ageGroup, inst: s.institution, gen: s.gender,
                    grandTotal: 0,
                    avg: 0,
                    validJudges: 0
                };

                // Loop Judges 1-5
                for(let j=1; j<=5; j++) {
                    const jData = sMarks[j];
                    if(jData) {
                        row[`j${j}_c1`] = jData.scores.c1;
                        row[`j${j}_c2`] = jData.scores.c2;
                        row[`j${j}_c3`] = jData.scores.c3;
                        row[`j${j}_c4`] = jData.scores.c4;
                        row[`j${j}_c5`] = jData.scores.c5;
                        row[`j${j}_c6`] = jData.scores.c6;
                        row[`j${j}_c7`] = jData.scores.c7;
                        row[`j${j}_tot`] = jData.total;
                        row.grandTotal += jData.total;
                        row.validJudges++;
                    } else {
                        // Fill empty if judge didn't score
                        row[`j${j}_c1`] = 0; row[`j${j}_c2`] = 0; row[`j${j}_c3`] = 0; row[`j${j}_c4`] = 0; 
                        row[`j${j}_c5`] = 0; row[`j${j}_c6`] = 0; row[`j${j}_c7`] = 0; row[`j${j}_tot`] = 0;
                    }
                }
                
                row.avg = row.validJudges > 0 ? (row.grandTotal / row.validJudges) : 0;
                return row;
            });

            // 3. Sort by Average (Rank)
            processedData.sort((a,b) => b.avg - a.avg);

            // 4. Build CSV String
            let csv = headers.join(",") + "\n";
            processedData.forEach((row, index) => {
                let line = [
                    index + 1, // Rank
                    row.serial, row.id, row.name, row.branch, row.age, row.inst, row.gen,
                    // J1
                    row.j1_c1, row.j1_c2, row.j1_c3, row.j1_c4, row.j1_c5, row.j1_c6, row.j1_c7, row.j1_tot,
                    // J2
                    row.j2_c1, row.j2_c2, row.j2_c3, row.j2_c4, row.j2_c5, row.j2_c6, row.j2_c7, row.j2_tot,
                    // J3
                    row.j3_c1, row.j3_c2, row.j3_c3, row.j3_c4, row.j3_c5, row.j3_c6, row.j3_c7, row.j3_tot,
                    // J4
                    row.j4_c1, row.j4_c2, row.j4_c3, row.j4_c4, row.j4_c5, row.j4_c6, row.j4_c7, row.j4_tot,
                    // J5
                    row.j5_c1, row.j5_c2, row.j5_c3, row.j5_c4, row.j5_c5, row.j5_c6, row.j5_c7, row.j5_tot,
                    // Totals
                    row.grandTotal.toFixed(2), row.avg.toFixed(2)
                ];
                csv += line.join(",") + "\n";
            });

            // 5. Download
            const blob = new Blob([csv], {type: 'text/csv'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'Rasfahi_FINAL_MASTER_RESULTS.csv';
            a.click();
        }

        // =========================================
        // 8. PRINT REPORT (FULL TABLE)
        // =========================================
        function generateReport() {
            const pa = document.getElementById('printArea');
            let h = `
            <div style="padding:40px; font-family:'Noto Sans Thaana'; text-align:center;">
                <div style="border-bottom:2px solid #000; padding-bottom:10px; margin-bottom:20px;">
                    <h1 style="margin:0;">RASFAHI QURAN COMPETITION</h1>
                    <p style="margin:0;">OFFICIAL RESULTS SHEET - DETAILED</p>
                </div>
                
                <table style="width:100%; border-collapse:collapse; font-size:12px;" border="1" cellpadding="8">
                    <thead style="background:#eee;">
                        <tr>
                            <th width="5%">RK</th>
                            <th width="10%">ID</th>
                            <th width="20%">NAME</th>
                            <th width="10%">BRANCH</th>
                            <th width="10%">AGE GROUP</th>
                            <th>J1</th><th>J2</th><th>J3</th><th>J4</th><th>J5</th>
                            <th width="10%" style="background:#ddd;">AVG</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
            // Calculate Results
            let data = DB.students.map(s => {
                const sm = DB.marks[s.id] || {};
                let sum = 0, count = 0;
                let jScores = [];
                for(let i=1; i<=5; i++) {
                    let v = sm[i] ? sm[i].total : 0;
                    jScores.push(v || '-');
                    if(v > 0) { sum += v; count++; }
                }
                let avg = count > 0 ? (sum / count).toFixed(2) : 0;
                return { ...s, jScores, avg: parseFloat(avg) };
            });

            // Sort by Rank
            data.sort((a,b) => b.avg - a.avg);

            data.forEach((r, i) => {
                h += `<tr>
                    <td style="font-weight:bold;">${i+1}</td>
                    <td>${r.id}</td>
                    <td>${r.name}</td>
                    <td>${r.branch}</td>
                    <td>${r.ageGroup}</td>
                    <td>${r.jScores[0]}</td>
                    <td>${r.jScores[1]}</td>
                    <td>${r.jScores[2]}</td>
                    <td>${r.jScores[3]}</td>
                    <td>${r.jScores[4]}</td>
                    <td style="font-weight:bold; background:#f0f0f0;">${r.avg.toFixed(2)}</td>
                </tr>`;
            });

            h += `</tbody></table>
            
            <div style="display:flex; justify-content:space-between; margin-top:80px; padding:0 50px;">
                <div style="text-align:center;">
                    <div style="border-top:1px solid #000; width:200px; margin:auto;"></div>
                    <p>CHIEF JUDGE</p>
                </div>
                <div style="text-align:center;">
                    <div style="border-top:1px solid #000; width:200px; margin:auto;"></div>
                    <p>EVENT COORDINATOR</p>
                </div>
            </div>
            
            <div style="margin-top:20px; font-size:10px; color:#555;">Generated by Rasfahi Event Suite Pro</div>
            </div>`;
            
            pa.innerHTML = h;
            window.print();
        }

        function resetMarks() {
            if(confirm("DANGER: This will delete ALL scores. Proceed?")) {
                DB.marks = {};
                saveData();
                alert("Scores Reset.");
            }
        }
    </script>
</body>
</html>
