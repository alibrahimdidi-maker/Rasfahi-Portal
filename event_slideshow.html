<!DOCTYPE html>
<html lang="dv" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Royal Event Master (V36 - Ultimate Security)</title>
    <style>
        /* --- GLOBAL & SECURITY STYLES --- */
        body {
            -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none;
            margin: 0; padding: 0;
            background: #001a12; font-family: 'Faruuma', 'Times New Roman', serif;
            overflow: hidden; height: 100vh; width: 100vw;
        }
        @font-face {
            font-family: 'Faruuma';
            src: local('Faruuma'), local('Faruumaa'), url('Fonts/faruuma.ttf') format('truetype');
        }

        /* Login / Security Overlay */
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #00281c; z-index: 10000;
            display: flex; flex-direction: column; justify-content: center; align-items: center; color: #d4af37;
        }
        #loginBox {
            background: rgba(0, 0, 0, 0.6); padding: 40px; border-radius: 15px; border: 2px solid #d4af37; text-align: center; box-shadow: 0 0 20px #000;
        }
        #passInput {
            padding: 10px; font-size: 20px; border-radius: 5px; border: 1px solid #d4af37; text-align: center; width: 250px; margin-top: 15px; font-family: sans-serif; letter-spacing: 2px;
        }
        #loginBtn {
            margin-top: 15px; padding: 10px 30px; font-size: 18px; cursor: pointer; background: #d4af37; border: none; border-radius: 5px; font-weight: bold; color: #00281c; font-family: 'Faruuma';
        }

        /* --- LAYOUT --- */
        .main-layout { display: none; gap: 5px; height: 100vh; width: 100vw; padding: 5px; box-sizing: border-box; background: #00281c; }
        
        .sidebar { flex: 0 0 260px; background: #f1f8e9; padding: 5px; border-radius: 5px; display: flex; flex-direction: column; height: 100%; overflow-y: auto; border-right: 3px solid #d4af37; }
        .editor { flex: 1; background: #ffffff; padding: 5px; border-radius: 5px; display: flex; flex-direction: column; height: 100%; overflow-y: auto; position: relative; }
        .extra-panel { flex: 0 0 280px; background: #e0f2f1; padding: 5px; border-radius: 5px; display: flex; flex-direction: column; height: 100%; overflow-y: auto; border-left: 3px solid #d4af37; }

        /* UI Components */
        h3 { margin: 4px 0; color: #004d40; font-family: 'Faruuma'; font-size: 14px; border-bottom: 1px solid #aaa; }
        label { display: block; font-weight: bold; font-size: 10px; margin-bottom: 1px; color: #333; }
        input[type="text"], textarea, select { width: 98%; padding: 3px; border: 1px solid #aaa; border-radius: 3px; font-size: 11px; margin-bottom: 2px; font-family: 'Faruuma', 'Times New Roman'; }
        
        .target-selector { display:flex; gap:2px; margin-bottom:5px; background:#b2dfdb; padding:3px; border-radius:3px; }
        .target-btn { flex:1; border:1px solid #00695c; background:#e0f2f1; cursor:pointer; font-size:10px; padding:3px; color:#004d40; }
        .target-btn.active { background:#004d40; color:#fff; font-weight:bold; }

        .file-box { background: #eee; padding: 5px; border-radius: 5px; margin-bottom: 5px; border: 1px solid #ccc; }
        input[type="file"] { width: 100%; font-size: 9px; }
        
        .row { display: flex; gap: 2px; margin-bottom: 2px; } .col { flex: 1; }
        .btn-vid { font-size: 11px; padding: 4px; margin-top: 2px; border:none; border-radius:3px; color:white; width: 100%; cursor: pointer; }
        .controls { display: flex; gap: 2px; margin-top: 5px; }
        button.action { flex: 1; padding: 8px; font-size: 12px; border: none; border-radius: 4px; color: white; cursor: pointer; }
        .btn-live { background: #004d40; flex: 2; border: 2px solid #ffd700; color: #ffd700; }
        .btn-nav { background: #455a64; } .btn-clear { background: #b71c1c; flex: 0.5; }
        
        .preview-container { display: flex; gap: 5px; align-items: center; justify-content: center; background: #fff8e1; padding: 4px; border: 1px solid #ffb300; border-radius: 4px; margin-top: 5px; }
        #previewImg { width: 60px; height: 60px; object-fit: cover; border: 1px solid #d4af37; }
        #logoPreview { height: 30px; object-fit: contain; }

        .screen-launcher { display: grid; grid-template-columns: 1fr 1fr; gap: 3px; margin-bottom: 5px; }
        .launch-btn { background: #37474f; color: white; padding: 6px; border: none; border-radius: 3px; font-size: 10px; width: 100%; cursor: pointer; }
        .launch-btn:hover { background: #455a64; }
        
        /* Design Panel */
        .design-panel { background: #fff3e0; border: 1px solid #ffb74d; border-radius: 5px; padding: 5px; margin-bottom: 5px; display:none; }
        .design-panel.active { display:block; }
        .d-label { font-size: 9px; font-weight: bold; color: #e65100; display:block; }
        input[type=range] { height: 10px; width: 100%; cursor: pointer; }
        input[type=color] { height: 15px; width: 20px; border:none; padding:0; }
        .d-grp { border-bottom: 1px dashed #ccc; padding-bottom: 3px; margin-bottom: 3px; }

        /* Video Panel (Restored) */
        .video-panel { background: #e3f2fd; padding: 5px; border-radius: 5px; border: 1px solid #90caf9; margin-top: auto; }

        #statusMsg { text-align: center; margin-top: auto; font-weight: bold; color: green; font-size: 11px; background: #e8f5e9; padding: 2px; }
        .active-label { font-size:10px; color:#c62828; font-weight:bold; text-align:center; display:block; margin-bottom:2px; }
    </style>
</head>
<body oncontextmenu="return false;">

    <div id="loginOverlay">
        <div id="loginBox">
            <h1 style="color:#d4af37; font-family:'Faruuma';">Royal Event Master</h1>
            <p id="expiryMsg" style="font-size:10px; color:#aaa;"></p>
            <input type="password" id="passInput" placeholder="License Key">
            <button id="loginBtn" onclick="checkPassword()">Verify & Login</button>
            <p id="loginError" style="color: #ff5252; display: none; margin-top: 10px;">Invalid License!</p>
        </div>
    </div>

    <div class="main-layout" id="mainApp">
        
        <div class="sidebar">
            <div class="screen-launcher">
                <button class="launch-btn" style="background:#c62828; grid-column: span 2;" onclick="openTV(1)">üñ•Ô∏è 1. MAIN (Stage)</button>
                <button class="launch-btn" onclick="openTV(2)">üñ•Ô∏è 2. Banner L</button>
                <button class="launch-btn" onclick="openTV(3)">üñ•Ô∏è 3. Banner R</button>
                <button class="launch-btn" onclick="openTV(4)">üñ•Ô∏è 4. Presentation</button>
            </div>
            <div id="connStatus" style="font-size:10px; color:red; text-align:center; margin-bottom:2px;">Not Connected</div>

            <div style="background:#ffebee; padding:5px; border:1px solid #ffcdd2; border-radius:4px; margin-bottom:5px;">
                <span class="active-label">STEP 1: SELECT SCREEN TO EDIT</span>
                <div class="target-selector">
                    <button class="target-btn active" onclick="setTarget(1)" id="btnT1">Screen 1</button>
                    <button class="target-btn" onclick="setTarget(2)" id="btnT2">Scr 2</button>
                    <button class="target-btn" onclick="setTarget(3)" id="btnT3">Scr 3</button>
                    <button class="target-btn" onclick="setTarget(4)" id="btnT4">Scr 4</button>
                </div>
            </div>

            <div class="file-box">
                <span class="active-label" id="fileLabel">Configuring: Screen 1</span>
                
                <label>1. Content (CSV):</label>
                <input type="file" id="targetCsv" accept=".csv" onchange="loadTargetCsv(this)">
                
                <label>2. Background (Img/Vid):</label>
                <input type="file" id="targetBg" accept="video/*, image/*" onchange="updateTargetBg(this)">
                
                <div id="mainOnlyFiles">
                    <label>3. Photos (Main Only):</label>
                    <input type="file" id="photoFolder" webkitdirectory directory multiple onchange="loadPhotos(this)">
                    <label>4. Logo (Main Only):</label>
                    <input type="file" id="logoFile" accept="image/*" onchange="loadLogo(this)">
                </div>
            </div>

            <label>Select Item:</label>
            <input type="text" id="search" placeholder="Search..." onkeyup="filterList()">
            <select id="stuList" size="5" style="flex-grow:1;" onchange="loadContentToEditor()"></select>
            
            <button onclick="toggleDesignPanel()" class="btn-vid" style="background:#555;">üé® Design Panel</button>
        </div>

        <div class="editor">
            <div style="background:#e8f5e9; padding:5px; border-radius:4px; margin-bottom:5px;">
                <h3>‚úèÔ∏è Edit Active Content</h3>
                <input type="text" id="line1" placeholder="Line 1 / Main Title" class="font-dv" style="font-weight:bold;">
                <input type="text" id="line2" placeholder="Line 2 / Sub Title" class="font-dv">
                <input type="text" id="line3" placeholder="Line 3 / Detail 1" class="font-dv">
                <input type="text" id="line4" placeholder="Line 4 / Detail 2" class="font-dv">
                <button class="btn-vid" style="background:#2e7d32;" onclick="updateTargetScreen()">‚ö° Update Selected Screen</button>
            </div>

            <div id="mainPreview" class="preview-container">
                <div style="width:40px;"><img id="logoPreview" alt="Logo" style="width:100%;"></div>
                <div><img id="previewImg" src="https://via.placeholder.com/150"></div>
            </div>

            <div class="controls">
                <button class="action btn-nav" onclick="move(-1)">‚óÄ Prev</button>
                <button class="action btn-live" onclick="updateTargetScreen()">üì∫ SEND</button>
                <button class="action btn-nav" onclick="move(1)">Next ‚ñ∂</button>
                <button class="action btn-clear" onclick="clearTarget()">Clear</button>
            </div>

            <div class="video-panel">
                <h3>üé• Video Controller (Main Screen)</h3>
                <div class="row">
                    <input type="file" id="videoLocal" accept="video/*" style="width:70%">
                    <button class="btn-vid" style="background:#e65100; width:30%; margin:0;" onclick="playLocalVideo()">‚ñ∂ Local</button>
                </div>
                <div class="row">
                    <input type="text" id="ytLink" placeholder="YouTube Link..." style="width:70%; text-align:left;" class="font-en">
                    <button class="btn-vid" style="background:#c62828; width:30%; margin:0;" onclick="playYoutube()">‚ñ∂ YT</button>
                </div>
                <button class="btn-vid" style="background:#333;" onclick="stopVideo()">‚èπ STOP VIDEO</button>
            </div>
        </div>

        <div class="extra-panel">
            
            <div id="designPanel" class="design-panel active">
                <label style="color:#e65100;">üé® Design: <span id="designTargetLabel">Screen 1</span></label>
                
                <div id="mainDesignCtrls">
                    <div class="d-grp">
                        <span class="d-label">Frame & Theme:</span>
                        <select id="in_cBorder" onchange="liveUpdate('cBorder', this.value)" style="width:100%;">
                            <option value="frame-1">Gold</option><option value="b0">None</option>
                            <option value="frame-2">Glow</option><option value="frame-10">Scroll</option>
                        </select>
                        <select id="in_mainTheme" onchange="liveUpdate('mainTheme', this.value)" style="width:100%; margin-top:2px;">
                            <option value="theme-1">Green</option><option value="theme-2">Blue</option>
                            <option value="theme-4">Black</option><option value="theme-7">Red</option>
                        </select>
                    </div>
                    <div class="d-grp">
                        <span class="d-label">Photo Pos (X/Y):</span>
                        <div class="row">
                            <input id="in_pX" type="range" min="-800" max="800" value="-40" oninput="liveUpdate('pX', this.value)">
                            <input id="in_pY" type="range" min="-500" max="500" value="0" oninput="liveUpdate('pY', this.value)">
                        </div>
                    </div>
                </div>

                <div id="subDesignCtrls" style="display:none;">
                    <div class="d-grp">
                        <span class="d-label">Text Position (X/Y):</span>
                        <div class="row">
                            <input id="in_subX" type="range" min="-800" max="800" value="0" oninput="liveUpdate('subX', this.value)">
                            <input id="in_subY" type="range" min="-800" max="800" value="0" oninput="liveUpdate('subY', this.value)">
                        </div>
                    </div>
                    <div class="d-grp">
                        <span class="d-label">Text Style:</span>
                        <div class="row">
                            <input id="in_subSize" type="range" min="1" max="10" step="0.1" value="4.0" oninput="liveUpdate('subSize', this.value)">
                            <input id="in_subColor" type="color" value="#d4af37" oninput="liveUpdate('subColor', this.value)">
                        </div>
                    </div>
                </div>
            </div>

            <div id="statusMsg">Ready</div>
        </div>
    </div>

<script>
    // --- SECURITY & CONFIG ---
    const LICENSE_KEY = "7791550";
    const EXPIRY_DATE = "2025-12-31"; 

    // Disable Right Click & DevTools (Basic Level)
    document.addEventListener('contextmenu', event => event.preventDefault());
    document.onkeydown = function(e) {
        if(e.keyCode == 123) { return false; }
        if(e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) { return false; }
        if(e.ctrlKey && e.shiftKey && e.keyCode == 'C'.charCodeAt(0)) { return false; }
        if(e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) { return false; }
        if(e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) { return false; }
    }

    // --- APP STATE ---
    let activeTarget = 1;
    let tvWindows = {};
    let screenData = { 1: [], 2: [], 3: [], 4: [] }; // Data for each screen
    let bgData = { 1: {d:null, t:'none'}, 2: {d:null, t:'none'}, 3: {d:null, t:'none'}, 4: {d:null, t:'none'} };
    let photoFiles = {};
    let logoData = null;

    // Design State per Screen
    let designState = {
        1: { cBorder:'frame-1', mainTheme:'theme-1', pX:-40, pY:0, pVis:'show' },
        2: { subX:0, subY:0, subSize:4.0, subColor:'#d4af37' },
        3: { subX:0, subY:0, subSize:4.0, subColor:'#d4af37' },
        4: { subX:0, subY:0, subSize:4.0, subColor:'#d4af37' }
    };

    function checkPassword() {
        const pass = document.getElementById('passInput').value.trim();
        const today = new Date();
        const expiry = new Date(EXPIRY_DATE);
        expiry.setHours(23, 59, 59);

        document.getElementById('expiryMsg').innerText = "Valid until: " + EXPIRY_DATE;

        if (today > expiry) { alert("License Expired! Contact Vendor."); return; }

        if (pass === LICENSE_KEY) {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('mainApp').style.display = 'flex';
        } else {
            document.getElementById('loginError').style.display = 'block';
        }
    }

    // --- TARGET SYSTEM ---
    function setTarget(id) {
        activeTarget = id;
        // UI Updates
        document.querySelectorAll('.target-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btnT'+id).classList.add('active');
        document.getElementById('fileLabel').innerText = "Configuring: Screen " + id;
        
        // Show/Hide Specific Inputs
        document.getElementById('mainOnlyFiles').style.display = (id === 1) ? 'block' : 'none';
        document.getElementById('mainPreview').style.display = (id === 1) ? 'flex' : 'none';
        
        // Design Panel Update
        document.getElementById('designTargetLabel').innerText = "Screen " + id;
        document.getElementById('mainDesignCtrls').style.display = (id === 1) ? 'block' : 'none';
        document.getElementById('subDesignCtrls').style.display = (id !== 1) ? 'block' : 'none';

        // Refresh List
        refreshList();
    }

    function refreshList() {
        const sel = document.getElementById('stuList');
        sel.innerHTML = '';
        const data = screenData[activeTarget];
        if (data && data.length > 0) {
            data.forEach((item, i) => {
                let txt = (activeTarget === 1) ? item.nD : item.l1; // S1 uses Name, others use Line1
                let opt = document.createElement('option');
                opt.value = i;
                opt.text = (i+1) + ". " + txt;
                sel.add(opt);
            });
        }
    }

    // --- FILE LOADERS ---
    function loadTargetCsv(input) {
        const file = input.files[0];
        if(!file) return;
        const r = new FileReader();
        r.onload = e => {
            const lines = e.target.result.split('\n');
            let newData = [];
            lines.forEach(l => {
                const c = l.split(',');
                if(c[0]) {
                    if(activeTarget === 1) {
                        // Main Screen: nD, nE, cD, cE, fD, fE
                        newData.push({nD:c[0], nE:c[1], cD:c[2], cE:c[3], fD:c[4], fE:c[5]});
                    } else {
                        // Sub Screens: Line1, Line2, Line3...
                        newData.push({l1:c[0], l2:c[1]||'', l3:c[2]||'', l4:c[3]||''});
                    }
                }
            });
            screenData[activeTarget] = newData;
            refreshList();
            alert("Loaded " + newData.length + " items to Screen " + activeTarget);
        };
        r.readAsText(file);
    }

    function updateTargetBg(input) {
        const file = input.files[0];
        if(!file) return;
        const r = new FileReader();
        r.onload = e => {
            bgData[activeTarget] = { 
                d: e.target.result, 
                t: file.type.startsWith('video') ? 'video' : 'image' 
            };
            // Update live if open
            if(tvWindows[activeTarget] && !tvWindows[activeTarget].closed) {
                applyBg(activeTarget);
            }
        };
        r.readAsDataURL(file);
    }

    function loadPhotos(input) {
        for(let f of input.files) {
            let n = f.name.toLowerCase().split('.')[0];
            photoFiles[n] = f;
        }
        alert("Photos Loaded for Main Screen");
    }

    function loadLogo(input) {
        const r = new FileReader();
        r.onload = e => {
            logoData = e.target.result;
            if(tvWindows[1]) tvWindows[1].document.getElementById('logoImg').src = logoData;
            document.getElementById('logoPreview').src = logoData;
        };
        r.readAsDataURL(input.files[0]);
    }

    // --- EDITOR ---
    function loadContentToEditor() {
        const idx = document.getElementById('stuList').value;
        const data = screenData[activeTarget][idx];
        if(!data) return;

        if(activeTarget === 1) {
            document.getElementById('line1').value = data.nD;
            document.getElementById('line2').value = data.nE;
            document.getElementById('line3').value = data.fD;
            document.getElementById('line4').value = data.cD;
            
            // Photo Preview
            let pName = data.nD ? data.nD.trim().toLowerCase() : "";
            if(photoFiles[pName]) {
                const r = new FileReader();
                r.onload = e => { document.getElementById('previewImg').src = e.target.result; };
                r.readAsDataURL(photoFiles[pName]);
            } else {
                document.getElementById('previewImg').src = "https://via.placeholder.com/150";
            }
        } else {
            document.getElementById('line1').value = data.l1;
            document.getElementById('line2').value = data.l2;
            document.getElementById('line3').value = data.l3;
            document.getElementById('line4').value = data.l4;
        }
    }

    // --- LIVE UPDATES ---
    function openTV(id) {
        const win = window.open('', 'TV_'+id, 'width=1280,height=720,menubar=no,toolbar=no');
        tvWindows[id] = win;
        
        let css = `
            @font-face { font-family: 'Faruuma'; src: url('Fonts/faruuma.ttf') format('truetype'); }
            body { margin:0; overflow:hidden; background:#000; font-family:'Faruuma', serif; transition:0.3s; }
            #bgLayer { position:absolute; top:0; left:0; width:100%; height:100%; z-index:0; }
            #bgLayer video, #bgLayer img { width:100%; height:100%; object-fit:cover; }
            
            /* S1 Specific */
            .frame-1 { border:none; box-shadow:0 0 100px #000; }
            .frame-2 { border: 4px dashed #d4af37; box-shadow: 0 0 20px #d4af37; border-radius: 20px; }
            .frame-10 { background: #3e2723; border: 5px solid #5d4037; }
            .theme-1 { background: #001a12; } .theme-2 { background: #0d47a1; }
            
            #card { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:90vw; display:flex; align-items:center; z-index:20; opacity:0; transition:0.5s; }
            #card.active { opacity:1; }
            #logoWrap { position:absolute; top:40px; left:50%; transform:translateX(-50%); z-index:30; }
            #logoImg { height:120px; filter:drop-shadow(0 5px 5px rgba(0,0,0,0.5)); }
            
            /* S2,3,4 Specific */
            #subContent { position:absolute; width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:10; text-align:center; transition:0.3s; }
            #videoLayer { position:fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:5000; display:none; justify-content:center; align-items:center; }
            #videoLayer video, #videoLayer iframe { width:100%; height:100%; border:none; }
        `;

        let html = `<html><head><style>${css}</style></head><body>
            <div id="videoLayer"></div>
            <div id="bgLayer"></div>
            
            ${id === 1 ? `
            <div id="logoWrap"><img id="logoImg" src=""></div>
            <div id="card" class="frame-1">
                <div class="photo-col" style="flex:0 0 320px; text-align:center;"><img id="stuImg" style="width:260px; height:260px; object-fit:cover; border-radius:50%; border:5px solid #d4af37;"></div>
                <div class="text-col" style="flex:1; text-align:right; color:white; padding:20px;">
                    <h1 id="t1" style="font-size:5em; margin:0;"></h1>
                    <h2 id="t2" style="font-size:3em; color:#d4af37;"></h2>
                    <div id="t3" style="font-size:2em;"></div>
                    <div id="t4" style="font-size:2em;"></div>
                </div>
            </div>` : 
            /* S2, S3, S4 SUB */
            `<div id="subContent">
                <div id="s1" style="font-weight:bold;"></div>
                <div id="s2"></div>
                <div id="s3"></div>
                <div id="s4"></div>
            </div>`}
        </body></html>`;

        win.document.write(html);
        win.document.close();

        applyBg(id);
        if(id===1 && logoData) win.document.getElementById('logoImg').src = logoData;
        if(id!==1) liveUpdate('subSize', designState[id].subSize); // Apply default style
    }

    function applyBg(id) {
        const win = tvWindows[id];
        const data = bgData[id];
        if(win && !win.closed && data.d) {
            const bg = win.document.getElementById('bgLayer');
            if(data.t === 'video') bg.innerHTML = `<video src="${data.d}" autoplay loop muted></video>`;
            else bg.innerHTML = `<img src="${data.d}">`;
        }
    }

    function updateTargetScreen() {
        const win = tvWindows[activeTarget];
        if(!win || win.closed) return;
        const doc = win.document;

        const l1 = document.getElementById('line1').value;
        const l2 = document.getElementById('line2').value;
        const l3 = document.getElementById('line3').value;
        const l4 = document.getElementById('line4').value;

        if(activeTarget === 1) {
            doc.getElementById('t1').innerText = l1;
            doc.getElementById('t2').innerText = l2;
            doc.getElementById('t3').innerText = l3;
            doc.getElementById('t4').innerText = l4;
            
            // Photo Logic
            const idx = document.getElementById('stuList').value;
            const sData = screenData[1][idx];
            if(sData) {
                let pName = sData.nD ? sData.nD.trim().toLowerCase() : "";
                if(photoFiles[pName]) {
                    const r = new FileReader();
                    r.onload = e => { doc.getElementById('stuImg').src = e.target.result; };
                    r.readAsDataURL(photoFiles[pName]);
                } else {
                    doc.getElementById('stuImg').src = "";
                }
            }
            doc.getElementById('card').classList.add('active');
        } else {
            doc.getElementById('s1').innerText = l1;
            doc.getElementById('s2').innerText = l2;
            doc.getElementById('s3').innerText = l3;
            doc.getElementById('s4').innerText = l4;
        }
    }

    function clearTarget() {
        const win = tvWindows[activeTarget];
        if(win && !win.closed) {
            if(activeTarget === 1) win.document.getElementById('card').classList.remove('active');
            else {
                win.document.getElementById('s1').innerText = "";
                win.document.getElementById('s2').innerText = "";
            }
        }
    }

    // --- DESIGN LOGIC ---
    function liveUpdate(key, value) {
        // Save to state
        if(activeTarget === 1) {
            if(['cBorder','mainTheme','pX','pY'].includes(key)) designState[1][key] = value;
        } else {
            if(['subX','subY','subSize','subColor'].includes(key)) designState[activeTarget][key] = value;
        }

        const win = tvWindows[activeTarget];
        if(!win || win.closed) return;
        const doc = win.document;

        if(activeTarget === 1) {
            // S1 Logic
            if(key === 'cBorder') doc.getElementById('card').className = value + " active";
            if(key === 'mainTheme') doc.body.className = value;
            if(key === 'pX' || key === 'pY') {
                doc.querySelector('.photo-col').style.transform = `translate(${document.getElementById('in_pX').value}px, ${document.getElementById('in_pY').value}px)`;
            }
        } else {
            // Sub Logic
            const con = doc.getElementById('subContent');
            if(key === 'subX' || key === 'subY') {
                con.style.transform = `translate(${document.getElementById('in_subX').value}px, ${document.getElementById('in_subY').value}px)`;
            }
            if(key === 'subSize') {
                con.style.fontSize = value + 'em';
            }
            if(key === 'subColor') {
                con.style.color = value;
                // Update border color of S1 if strictly needed? No, separate.
            }
        }
    }

    function toggleDesignPanel() {
        const p = document.getElementById('designPanel');
        p.style.display = p.style.display === 'block' ? 'none' : 'block';
    }

    // --- VIDEO PLAYER (Main Screen Only for now) ---
    function playLocalVideo() {
        if(!tvWindows[1] || tvWindows[1].closed) return;
        const file = document.getElementById('videoLocal').files[0];
        if(!file) return;
        const url = URL.createObjectURL(file);
        const vl = tvWindows[1].document.getElementById('videoLayer');
        vl.innerHTML = `<video id="mainVid" src="${url}" autoplay controls style="width:100%;height:100%;"></video>`;
        vl.style.display = 'flex';
        tvWindows[1].document.getElementById('card').classList.remove('active');
    }

    function playYoutube() {
        if(!tvWindows[1] || tvWindows[1].closed) return;
        const url = document.getElementById('ytLink').value;
        const match = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/);
        const id = (match && match[2].length === 11) ? match[2] : null;
        if(id) {
            const vl = tvWindows[1].document.getElementById('videoLayer');
            vl.innerHTML = `<iframe src="https://www.youtube.com/embed/${id}?autoplay=1" style="width:100%;height:100%;border:none;"></iframe>`;
            vl.style.display = 'flex';
            tvWindows[1].document.getElementById('card').classList.remove('active');
        }
    }

    function stopVideo() {
        if(tvWindows[1] && !tvWindows[1].closed) {
            const vl = tvWindows[1].document.getElementById('videoLayer');
            vl.innerHTML = ''; vl.style.display = 'none';
        }
    }

    function move(d) {
        let l = document.getElementById('stuList');
        l.selectedIndex = Math.min(Math.max(l.selectedIndex+d, 0), l.options.length-1);
        loadContentToEditor();
    }
    
    function toggleControlFS() { 
        if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); 
    }
</script>
</body>
</html>
