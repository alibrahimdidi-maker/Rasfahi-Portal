<!DOCTYPE html>
<html lang="dv" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Presidential Suite v5 | Stable Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @font-face { font-family: 'Faruma'; src: local('Faruma'), local('MV Boli'); }
        
        :root {
            --royal-bg: #000c1a;
            --gold: #c5a059;
            --pure-white: #ffffff;
            --btn-hover: #e2c275;
        }

        body {
            font-family: 'Faruma', sans-serif;
            background-color: var(--royal-bg);
            color: var(--pure-white);
            margin: 0;
            padding: 0;
        }

        /* Royal Header */
        .executive-header {
            background: linear-gradient(180deg, #001f3f, #000c1a);
            padding: 40px 20px;
            border-bottom: 3px solid var(--gold);
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .title-main {
            font-size: 2.5rem;
            color: var(--gold);
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 3px;
        }

        /* Controls */
        .control-panel {
            background: rgba(255, 255, 255, 0.05);
            margin: 20px;
            padding: 25px;
            border-radius: 15px;
            border: 1px solid var(--gold);
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            align-items: center;
        }

        .royal-btn {
            background: var(--gold);
            color: #000;
            border: none;
            padding: 12px 25px;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            transition: 0.3s;
            font-family: 'Faruma';
        }

        .royal-btn:hover { background: var(--btn-hover); transform: translateY(-2px); }

        .search-input {
            padding: 12px;
            border-radius: 5px;
            border: none;
            width: 300px;
            font-size: 16px;
            font-family: 'Faruma';
        }

        /* Dashboard Charts */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            padding: 0 20px;
        }

        .chart-card {
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(197, 160, 89, 0.3);
            border-radius: 15px;
            padding: 20px;
            height: 300px;
        }

        /* Table Design */
        .table-wrapper {
            margin: 20px;
            background: #fff;
            border-radius: 10px;
            overflow: auto;
            max-height: 500px;
        }

        table { width: 100%; border-collapse: collapse; color: #333; }
        th { background: #001f3f; color: var(--gold); padding: 15px; position: sticky; top: 0; }
        td { padding: 12px; border-bottom: 1px solid #eee; text-align: center; }

        /* Mobile Optimization */
        @media (max-width: 768px) {
            table { display: none; }
            .voter-card {
                background: white; color: black; margin: 10px; padding: 15px;
                border-radius: 10px; border-right: 5px solid var(--gold);
            }
            .card-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 10px; }
            .search-input { width: 90%; }
        }

        .active-yes { background: #2e7d32 !important; color: white !important; }
        .active-no { background: #d32f2f !important; color: white !important; }
    </style>
</head>
<body onbeforeunload="return 'ﬁâﬁ¶ﬁ¢ﬁ™ﬁçﬁ´ﬁâﬁßﬁåﬁ™ ﬁêﬁ≠ﬁàﬁ∞ﬁÜﬁ™ﬁÉﬁ¨ﬁáﬁ∞ﬁàﬁ®ﬁÇﬁ∞ﬁåﬁØÿü'">

<div class="executive-header">
    <h1 class="title-main" id="app-title">PRESIDENTIAL ELECTION SUITE</h1>
    <div style="margin-top: 15px;">
        <button class="royal-btn" onclick="setLang('dv')">ﬁãﬁ®ﬁàﬁ¨ﬁÄﬁ®</button>
        <button class="royal-btn" onclick="setLang('en')">English</button>
    </div>
</div>

<div class="control-panel">
    <input type="text" id="searchInput" class="search-input" placeholder="ﬁÄﬁØﬁáﬁ∞ﬁãﬁ¶ﬁàﬁß (ﬁÇﬁ¶ﬁÇﬁ∞ ﬁÇﬁ™ﬁàﬁ¶ﬁåﬁ¶ ﬁáﬁ¶ﬁáﬁ®ﬁëﬁ©)..." oninput="renderData()">
    <input type="file" id="csvFile" accept=".csv" style="display:none" onchange="handleFile(this)">
    <button class="royal-btn" onclick="document.getElementById('csvFile').click()">CSV ﬁáﬁ®ﬁâﬁ∞ﬁïﬁØﬁìﬁ∞</button>
    <button class="royal-btn" onclick="downloadSample()">ﬁëﬁ¶ﬁâﬁ© ﬁäﬁ¶ﬁáﬁ®ﬁçﬁ∞ ﬁëﬁ¶ﬁáﬁ™ﬁÇﬁ∞ﬁçﬁØﬁëﬁ∞</button>
    <button class="royal-btn" onclick="window.print()">ﬁïﬁ∞ﬁÉﬁ®ﬁÇﬁ∞ﬁìﬁ∞ / PDF</button>
    <button class="royal-btn" onclick="clearAll()" style="background:#ff4444; color:white;">ﬁÄﬁ™ﬁêﬁ∞ﬁÜﬁ™ﬁÉﬁ≠</button>
</div>

<div class="dashboard">
    <div class="chart-card"><canvas id="supportChart"></canvas></div>
    <div class="chart-card"><canvas id="voteChart"></canvas></div>
</div>

<div id="displayArea"></div>

<script>
    let voters = JSON.parse(localStorage.getItem('voter_storage_v5')) || [];
    let sChart, vChart;

    // 1. Improved CSV Import Logic
    function handleFile(input) {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            const text = e.target.result;
            const rows = text.split(/\r?\n/);
            const newVoters = [];

            // Skip header, parse rows
            for (let i = 1; i < rows.length; i++) {
                if (!rows[i].trim()) continue;
                const cols = rows[i].split(',').map(c => c.trim().replace(/^"|"$/g, ''));
                
                // Mapping based on common order: No, Name, ID, Address, Station, P1, P2
                newVoters.push({
                    name: cols[1] || 'Unknown',
                    id: cols[2] || 'N/A',
                    addr: cols[3] || '',
                    station: cols[4] || '',
                    p1: cols[5] || '',
                    sup: 'none',
                    voted: false
                });
            }

            voters = newVoters;
            saveAndRefresh();
            alert(voters.length + " ﬁâﬁ©ﬁÄﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁçﬁ®ﬁêﬁ∞ﬁìﬁ™ ﬁáﬁ®ﬁâﬁ∞ﬁïﬁØﬁìﬁ∞ ﬁÜﬁ™ﬁÉﬁ¨ﬁàﬁ®ﬁáﬁ∞ﬁñﬁ¨!");
        };
        reader.readAsText(file);
    }

    // 2. Correct Dummy CSV Creator
    function downloadSample() {
        let csv = "No,Full Name,ID Card,Address,Station,Phone1,Phone2\n";
        for(let i=1; i<=10; i++) {
            csv += `${i},Voter Name ${i},A${100000+i},House ${i},Center ${i},777000${i},999000${i}\n`;
        }
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.setAttribute("download", "election_list_template.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function saveAndRefresh() {
        localStorage.setItem('voter_storage_v5', JSON.stringify(voters));
        renderData();
        updateCharts();
    }

    function updateV(idx, key, val) {
        if (key === 'sup' && voters[idx].sup === val) voters[idx].sup = 'none';
        else voters[idx][key] = val;
        saveAndRefresh();
    }

    function renderData() {
        const query = document.getElementById('searchInput').value.toLowerCase();
        const filtered = voters.filter(v => v.name.toLowerCase().includes(query) || v.id.toLowerCase().includes(query));
        const area = document.getElementById('displayArea');

        if (window.innerWidth < 768) {
            area.innerHTML = filtered.map((v, i) => `
                <div class="voter-card">
                    <strong>${v.name}</strong><br>
                    <small>${v.id} | ${v.station}</small>
                    <div class="card-grid">
                        <button class="royal-btn ${v.sup==='yes'?'active-yes':''}" onclick="updateV(${voters.indexOf(v)},'sup','yes')">üëç</button>
                        <button class="royal-btn ${v.sup==='no'?'active-no':''}" onclick="updateV(${voters.indexOf(v)},'sup','no')">üëé</button>
                        <button class="royal-btn ${v.voted?'active-yes':''}" style="grid-column: span 2;" onclick="updateV(${voters.indexOf(v)},'voted',!v.voted)">
                            ${v.voted ? 'ﬁàﬁØﬁìﬁ™ﬁçﬁ¶ﬁáﬁ®ﬁäﬁ®' : 'ﬁàﬁØﬁìﬁ™ ﬁÇﬁ™ﬁçﬁß'}
                        </button>
                    </div>
                </div>
            `).join('');
        } else {
            area.innerHTML = `
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>ﬁÇﬁ¶ﬁÇﬁ∞</th><th>ﬁáﬁ¶ﬁáﬁ®ﬁëﬁ©</th><th>ﬁâﬁ¶ﬁÉﬁ™ﬁÜﬁ¶ﬁíﬁ™</th><th>ﬁåﬁßﬁáﬁ©ﬁãﬁ™</th><th>ﬁàﬁØﬁìﬁ™</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filtered.map((v, i) => `
                                <tr>
                                    <td>${v.name}</td><td>${v.id}</td><td>${v.station}</td>
                                    <td>
                                        <button class="royal-btn ${v.sup==='yes'?'active-yes':''}" onclick="updateV(${voters.indexOf(v)},'sup','yes')">üëç</button>
                                        <button class="royal-btn ${v.sup==='no'?'active-no':''}" onclick="updateV(${voters.indexOf(v)},'sup','no')">üëé</button>
                                    </td>
                                    <td><button class="royal-btn ${v.voted?'active-yes':''}" onclick="updateV(${voters.indexOf(v)},'voted',!v.voted)">${v.voted ? '‚úÖ' : 'üó≥Ô∏è'}</button></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
    }

    function initCharts() {
        const ctxS = document.getElementById('supportChart').getContext('2d');
        const ctxV = document.getElementById('voteChart').getContext('2d');
        
        sChart = new Chart(ctxS, {
            type: 'bar',
            data: { labels: ['ﬁåﬁßﬁáﬁ©ﬁãﬁ™', 'ﬁÇﬁ™ﬁÜﬁ™ﬁÉﬁ≠', 'ﬁÇﬁ≠ﬁÇﬁéﬁ≠'], datasets: [{ label: 'Support', data: [0,0,0], backgroundColor: ['#c5a059', '#d32f2f', '#444'] }] },
            options: { maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { ticks: { color: '#fff' } } } }
        });

        vChart = new Chart(ctxV, {
            type: 'pie',
            data: { labels: ['ﬁàﬁØﬁìﬁ™ﬁçﬁ©', 'ﬁÇﬁ™ﬁçﬁß'], datasets: [{ data: [0,1], backgroundColor: ['#2e7d32', '#111'] }] },
            options: { maintainAspectRatio: false }
        });
        updateCharts();
    }

    function updateCharts() {
        const yes = voters.filter(v => v.sup === 'yes').length;
        const no = voters.filter(v => v.sup === 'no').length;
        const none = voters.filter(v => v.sup === 'none').length;
        const voted = voters.filter(v => v.voted).length;

        sChart.data.datasets[0].data = [yes, no, none];
        sChart.update();
        vChart.data.datasets[0].data = [voted, voters.length - voted];
        vChart.update();
    }

    function clearAll() { if(confirm("ﬁÜﬁ¶ﬁÅﬁ¶ﬁàﬁ¶ﬁÉﬁ™ﬁåﬁØÿü ﬁÄﬁ™ﬁÉﬁ®ﬁÄﬁß ﬁëﬁ≠ﬁìﬁßﬁáﬁ¨ﬁáﬁ∞ ﬁäﬁÆﬁÄﬁ¨ﬁàﬁ≠ﬁÇﬁ¨!")) { voters = []; saveAndRefresh(); } }

    window.onload = () => { initCharts(); renderData(); };
</script>

</body>
</html>
