<!DOCTYPE html>
<html lang="dv" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ultimate Quran CSV Generator (2000 Questions)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thaana:wght@400;700&display=swap');
        
        body { font-family: "Noto Sans Thaana", "Segoe UI", Tahoma, sans-serif; text-align: center; padding: 30px; background: #e0f2f1; }
        .container { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); max-width: 700px; margin: 0 auto; border-top: 5px solid #00695c; }
        
        h1 { color: #00695c; margin-bottom: 5px; }
        p { color: #555; font-size: 14px; margin-bottom: 25px; }

        .control-group { margin-bottom: 20px; text-align: right; direction: rtl; }
        label { font-weight: bold; display: block; margin-bottom: 8px; color: #333; }
        
        select { 
            width: 100%; padding: 12px; font-size: 16px; border: 2px solid #26a69a; border-radius: 6px; 
            font-family: "Noto Sans Thaana", sans-serif; background: #fff; cursor: pointer;
        }

        #btn { 
            padding: 15px 40px; font-size: 18px; background: #00897b; color: white; border: none; 
            border-radius: 6px; cursor: pointer; transition: 0.3s; width: 100%; font-weight: bold;
        }
        #btn:hover { background: #004d40; }
        #btn:disabled { background: #b0bec5; cursor: not-allowed; }

        .progress { width: 100%; background-color: #cfd8dc; margin-top: 20px; height: 25px; border-radius: 15px; overflow: hidden; }
        .bar { width: 0%; height: 100%; background-color: #00bcd4; text-align: center; line-height: 25px; color: #fff; font-size: 12px; transition: width 0.2s; font-weight: bold; }
        
        .log-box { 
            margin-top: 15px; font-size: 12px; color: #333; font-family: monospace; direction: ltr; 
            background: #f1f1f1; padding: 10px; border-radius: 5px; max-height: 100px; overflow-y: auto; text-align: left;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Ultimate Question Generator (2000 Qs)</h1>
    <p>Generates large random sets for Rasfahi V22</p>

    <div class="control-group">
        <label>ބޭނުންވާ ފޮޅުވަތުގެ މިންވަރު (Select Range):</label>
        <select id="rangeSelect">
            <option value="1-5">1 ފޮޅުވަތާއި 5 ފޮޅުވަތާ ދެމެދު</option>
            <option value="5-6">5 ފޮޅުވަތާއި 6 ފޮޅުވަތާ ދެމެދު</option>
            <option value="5-7">5 ފޮޅުވަތާއި 7 ފޮޅުވަތާ ދެމެދު</option>
            <option value="6-8">6 ފޮޅުވަތާއި 8 ފޮޅުވަތާ ދެމެދު</option>
            <option value="7-10">7 ފޮޅުވަތާއި 10 ފޮޅުވަތާ ދެމެދު</option>
            <option value="10-15">10 ފޮޅުވަތާއި 15 ފޮޅުވަތާ ދެމެދު (މުޅި ޞަފްޙާ)</option>
            <option value="15-20">15 ފޮޅުވަތާއި 20 ފޮޅުވަތާ ދެމެދު (1.5 ޞަފްޙާ)</option>
            <option value="20-30">20 ފޮޅުވަތާއި 30 ފޮޅުވަތާ ދެމެދު (2 ޞަފްޙާ)</option>
        </select>
    </div>

    <button id="btn" onclick="generateMassiveCSV()">Generate 2000 Questions</button>

    <div class="progress">
        <div id="bar" class="bar">0%</div>
    </div>
    <div id="status" class="log-box">Waiting to start...</div>
</div>

<script>
    // --- SETTINGS ---
    const TARGET_COUNT = 2000;
    
    // Average Text Length per Page (Approximate for Madani Script)
    // We use this to estimate line count without fetching every single page separately.
    // 1 Page ~ 800-900 chars (varies, but ratio works well)
    const AVG_PAGE_LEN = 850; 

    // Conversion: Lines -> Ratio of a Page
    // 15 lines = 1.0 (100%)
    const RANGES = {
        "1-5":   { min: 0.05, max: 0.33 },
        "5-6":   { min: 0.33, max: 0.40 },
        "5-7":   { min: 0.33, max: 0.46 },
        "6-8":   { min: 0.40, max: 0.53 },
        "7-10":  { min: 0.46, max: 0.66 },
        "10-15": { min: 0.66, max: 1.00 },
        "15-20": { min: 1.00, max: 1.35 },
        "20-30": { min: 1.35, max: 2.00 }
    };

    let allAyahsData = null;

    async function generateMassiveCSV() {
        const btn = document.getElementById('btn');
        const status = document.getElementById('status');
        const bar = document.getElementById('bar');
        const rangeKey = document.getElementById('rangeSelect').value;
        const config = RANGES[rangeKey];

        btn.disabled = true;
        status.innerHTML = "Initializing...";
        bar.style.width = "5%";

        try {
            // 1. Fetch WHOLE Quran (Once)
            if(!allAyahsData) {
                status.innerHTML = "Downloading Quran Data (This happens once)...";
                let response = await fetch('https://api.alquran.cloud/v1/quran/quran-uthmani');
                let json = await response.json();
                
                // Flatten data structure
                allAyahsData = [];
                json.data.surahs.forEach(surah => {
                    surah.ayahs.forEach(ayah => {
                        allAyahsData.push({
                            textLen: ayah.text.length,
                            juz: ayah.juz,
                            surahNum: surah.number,
                            surahName: surah.englishName,
                            ayahNum: ayah.numberInSurah,
                            page: ayah.page
                        });
                    });
                });
                status.innerHTML = `Quran Data Loaded! Total Ayahs: ${allAyahsData.length}`;
            }
            
            bar.style.width = "20%";

            // 2. Scan for candidates (Sliding Window)
            let candidates = [];
            let totalAyahs = allAyahsData.length;
            
            status.innerHTML += "<br>Scanning all ayahs for candidates...";
            
            // Loop through every ayah as a potential start point
            for(let i=0; i < totalAyahs; i++) {
                
                let currentTxtLen = 0;
                
                // Look ahead
                for(let j=i; j < totalAyahs; j++) {
                    currentTxtLen += allAyahsData[j].textLen;
                    
                    // Estimate ratio based on standard page length
                    let ratio = currentTxtLen / AVG_PAGE_LEN;
                    
                    // Optimization: If ratio exceeds max significantly, stop looking ahead for this start point
                    if(ratio > config.max + 0.1) break;

                    if(ratio >= config.min && ratio <= config.max) {
                        // Found a valid candidate!
                        candidates.push({
                            startIdx: i,
                            endIdx: j
                        });
                    }
                }
                
                // Update UI every 1000 ayahs
                if(i % 1000 === 0) {
                    let progress = 20 + Math.round((i / totalAyahs) * 60); // 20% to 80%
                    bar.style.width = progress + "%";
                    status.innerHTML = `Scanning... Found ${candidates.length} potential questions so far.`;
                    await new Promise(r => setTimeout(r, 1)); // Yield to UI
                }
            }

            status.innerHTML += `<br>Scan Complete. Total Candidates found: ${candidates.length}`;
            bar.style.width = "85%";

            // 3. Shuffle and Pick 2000
            shuffleArray(candidates);
            let finalSelection = candidates.slice(0, TARGET_COUNT);
            
            // Sort by Page/Ayah for cleaner CSV output (Optional, but looks nicer) or keep random?
            // User requested randomness to avoid repeats, but usually CSVs are better sorted for checking.
            // Let's keep them random (shuffled) as requested for the "set".
            
            // 4. Generate CSV String
            let csvContent = "ID,ImageName,Book,Surah,Page,StartAyah,EndAyah\n";
            let qID = 1;

            finalSelection.forEach(item => {
                let first = allAyahsData[item.startIdx];
                let last = allAyahsData[item.endIdx];

                // Formatting for V22
                let imgName = String(first.page).padStart(3, '0') + ".png";
                let juzStr = "Juz " + first.juz;
                let surahStr = `${first.surahNum}. ${first.surahName}`;

                let row = [
                    qID++,
                    imgName,
                    juzStr,
                    surahStr,
                    first.page,
                    first.ayahNum,
                    last.ayahNum
                ].join(",");
                csvContent += row + "\n";
            });

            // 5. Download
            bar.style.width = "100%";
            const blob = new Blob(["\uFEFF"+csvContent], {type: 'text/csv;charset=utf-8;'});
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `Quran_2000_Set_${rangeKey}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            status.innerHTML += `<br><strong style='color:green'>SUCCESS! Generated ${finalSelection.length} unique questions.</strong>`;
            btn.disabled = false;

        } catch (e) {
            console.error(e);
            status.innerHTML = `<span style='color:red'>Error: ${e.message}</span>`;
            btn.disabled = false;
        }
    }

    // Fisher-Yates Shuffle
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }
</script>

</body>
</html>
