<!DOCTYPE html>
<html lang="dv" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Rasfahi Judge System (Pro V4 - Ultimate)</title>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Noto+Sans+Thaana:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- GLOBAL THEME --- */
        :root {
            --gold: #D4AF37;
            --dark: #050505;
            --panel: #111;
            --border: #333;
            --text: #e0e0e0;
            --highlight: #002244;
            --green-dark: #004d00;
            --red-dark: #4d0000;
        }
        body { margin: 0; background: var(--dark); color: var(--text); font-family: 'Noto Sans Thaana', 'Segoe UI', sans-serif; height: 100vh; display: flex; overflow: hidden; }
        * { box-sizing: border-box; outline: none; user-select: none; }

        /* --- SIDEBAR --- */
        .sidebar { 
            width: 420px; background: var(--panel); border-left: 3px solid var(--gold); 
            display: flex; flex-direction: column; padding: 10px; overflow-y: auto; 
            box-shadow: 5px 0 15px rgba(0,0,0,0.5); z-index: 10;
        }
        .panel-box { background: rgba(255,255,255,0.03); border: 1px solid var(--border); padding: 12px; margin-bottom: 12px; border-radius: 6px; }
        
        h2 { color: var(--gold); font-size: 15px; margin: 0 0 10px 0; border-bottom: 1px dashed #444; padding-bottom: 5px; }
        label { display: block; color: #aaa; font-size: 11px; margin-top: 8px; margin-bottom: 2px; }
        
        input, select, button { width: 100%; padding: 8px; margin-bottom: 5px; background: #222; border: 1px solid #444; color: #fff; border-radius: 4px; font-size: 13px; }
        button { cursor: pointer; font-weight: bold; text-transform: uppercase; transition: 0.2s; }
        button:hover { border-color: var(--gold); background: #333; }
        
        .btn-green { background: var(--green-dark); border-color: #006400; }
        .btn-blue { background: #00264d; border-color: #004080; }
        .btn-red { background: var(--red-dark); border-color: #800000; }
        .btn-gold { background: linear-gradient(to bottom, #D4AF37, #8a6e15); color: #000; }

        /* --- MAIN VIEW --- */
        .main-view { flex: 1; display: flex; flex-direction: column; background: #000; position: relative; }
        .top-header { 
            height: 60px; background: #0b1016; border-bottom: 1px solid var(--gold); 
            display: flex; justify-content: space-between; align-items: center; padding: 0 20px;
        }
        .status-badge { background: #222; padding: 5px 15px; border: 1px solid var(--gold); color: var(--gold); border-radius: 20px; font-weight: bold; }

        /* GRID STYLES */
        #gridContainer { 
            display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; padding: 40px; 
            max-width: 900px; margin: 0 auto; width: 100%; overflow-y: auto;
        }
        .grid-box { 
            aspect-ratio: 1.2; background: #1a1a1a; border: 2px solid #333; 
            display: flex; justify-content: center; align-items: center; 
            font-size: 24px; font-weight: bold; cursor: pointer; color: #555;
            transition: all 0.2s; border-radius: 8px;
        }
        .grid-box:hover { border-color: var(--gold); color: #fff; background: #222; transform: scale(1.05); }
        .grid-box.taken { background: #220000; border-color: #500; color: #500; pointer-events: none; opacity: 0.5; }
        .grid-box.selected { background: var(--gold); color: #000; box-shadow: 0 0 15px var(--gold); }

        /* PREVIEW AREA */
        #previewArea { display: none; flex: 1; flex-direction: column; justify-content: center; align-items: center; padding: 20px; text-align: center; }
        #previewImg { max-height: 70vh; max-width: 90%; border: 5px solid #333; box-shadow: 0 0 30px #000; display:none; }
        #previewText { 
            display:none; color: #fff; font-family: 'Amiri', serif; font-size: 40px; line-height: 1.8; 
            max-width: 80%; padding: 20px; border: 2px solid var(--gold); background: rgba(0,0,0,0.5); 
            border-radius: 10px; text-shadow: 0 2px 4px #000; direction: rtl;
        }
        #qDetails { margin-top: 15px; font-size: 18px; color: #aaa; }

        /* TABS within Sidebar */
        .tab-content { display: none; padding: 10px; border: 1px solid #333; background: #1a1a1a; margin-top: 5px; }
        .tab-content.active { display: block; }
        .tab-btn { background: #333; color: #aaa; border: none; padding: 5px; width: auto; font-size: 11px; margin-right: 2px; }
        .tab-btn.active { background: var(--gold); color: #000; }
    </style>
</head>
<body>

<div class="sidebar">
    <div style="text-align:center; padding:10px; border-bottom:2px solid var(--gold); margin-bottom:10px;">
        <h1 style="color:var(--gold); margin:0; font-size:20px;">RASFAHI JUDGE PRO</h1>
        <small style="color:#aaa;">V4 Ultimate + Syllabus Engine</small>
    </div>

    <div class="panel-box">
        <h2>1. ﬁëﬁ≠ﬁìﬁßﬁÑﬁ≠ﬁêﬁ∞ (Database Setup)</h2>
        
        <label style="color:var(--gold);">‚òÖ Question Mode:</label>
        <select id="qMode" onchange="toggleMode()">
            <option value="image">Image Mode (ﬁäﬁÆﬁìﬁØ ﬁêﬁ™ﬁàﬁßﬁçﬁ™)</option>
            <option value="text">Text Mode (ﬁáﬁßﬁîﬁ¶ﬁåﬁ∞ ﬁêﬁ™ﬁàﬁßﬁçﬁ™)</option>
        </select>

        <hr style="border-color:#333; margin:8px 0;">

        <div id="imgInputs">
            <label>1. Questions CSV (For Images):</label>
            <input type="file" id="csvFileImg" accept=".csv" onchange="loadCSV(this, 'image')">
            <label>2. Images Folder:</label>
            <input type="file" id="imgFolder" webkitdirectory directory multiple onchange="loadImages(this)">
        </div>

        <div id="textInputs" style="display:none;">
            <div style="margin-bottom: 10px;">
                <button class="tab-btn active" onclick="switchTextTab('auto')">Auto-Gen (Quran File)</button>
                <button class="tab-btn" onclick="switchTextTab('manual')">Manual CSV</button>
            </div>

            <div id="tab-auto" class="tab-content active">
                <label style="color:#81c784;">1. Quran Text File (quran-uthmani.txt):</label>
                <input type="file" id="quranRawFile" accept=".txt">
                
                <div style="display:flex; gap:5px;">
                    <div style="flex:1">
                        <label>Min Verses:</label>
                        <input type="number" id="genMin" value="5">
                    </div>
                    <div style="flex:1">
                        <label>Max Verses:</label>
                        <input type="number" id="genMax" value="8">
                    </div>
                </div>
                <label>Total Questions to Generate:</label>
                <input type="number" id="genTotal" value="2500">
                
                <button class="btn-gold" onclick="processQuranRawFile()">‚ö° Generate & Load</button>
            </div>

            <div id="tab-manual" class="tab-content">
                <label>Upload Pre-made CSV:</label>
                <input type="file" id="csvFileText" accept=".csv" onchange="loadCSV(this, 'text')">
                <small style="color:#888;">Format: ID, ArabicText, Surah, Ayah, Branch, Group</small>
            </div>
        </div>

        <div id="dbStatus" style="font-size:11px; color:#00e676; margin-top:5px;">System Idle.</div>
    </div>

    <div class="panel-box">
        <h2>2. ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ & ﬁêﬁ®ﬁçﬁ¶ﬁÑﬁ¶ﬁêﬁ∞ (Selection)</h2>
        
        <label>Student Name (ﬁÇﬁ¶ﬁÇﬁ∞):</label>
        <input type="text" id="stdName" placeholder="ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁéﬁ¨ ﬁÇﬁ¶ﬁÇﬁ∞">
        
        <div style="display:flex; gap:5px;">
            <div style="flex:1">
                <label>Branch (ﬁéﬁÆﬁäﬁ®):</label>
                <select id="stdBranch" onchange="filterQuestions()">
                    <option value="All">All Branches</option>
                    <option value="Balaiygen">ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ®ﬁéﬁ¨ﬁÇﬁ∞</option>
                    <option value="Nubalai">ﬁÇﬁ™ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ®</option>
                    <option value="Hifz">ﬁôﬁ®ﬁäﬁ∞ﬁ°ﬁ™</option>
                </select>
            </div>
            <div style="flex:1">
                <label>Age (ﬁ¢ﬁ™ﬁâﬁ™ﬁÉﬁ™):</label>
                <select id="stdGroup" onchange="filterQuestions()">
                    <option value="All">All Ages</option>
                    <option value="Under 6">6 ﬁáﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁãﬁ¶ﬁÅﬁ∞</option>
                    <option value="Under 9">9 ﬁáﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁãﬁ¶ﬁÅﬁ∞</option>
                    <option value="Under 11">11 ﬁáﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁãﬁ¶ﬁÅﬁ∞</option>
                    <option value="Under 13">13 ﬁáﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁãﬁ¶ﬁÅﬁ∞</option>
                    <option value="Under 16">16 ﬁáﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁãﬁ¶ﬁÅﬁ∞</option>
                    <option value="Under 19">19 ﬁáﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁãﬁ¶ﬁÅﬁ∞</option>
                    <option value="General">ﬁ¢ﬁßﬁáﬁ∞ﬁâﬁ™ (General)</option>
                </select>
            </div>
        </div>

        <div style="background:#000; padding:8px; border:1px dashed var(--gold); margin-top:10px; border-radius:5px;">
            <label style="color:var(--gold); font-weight:bold;">‚òÖ Syllabus Scope (Range):</label>
            
            <label>From Surah (ﬁäﬁ¨ﬁÅﬁ≠ ﬁêﬁ´ﬁÉﬁ¶ﬁåﬁ∞):</label>
            <select id="startSurah" onchange="filterQuestions()"></select>
            
            <label>To Surah (ﬁÇﬁ®ﬁâﬁ≠ ﬁêﬁ´ﬁÉﬁ¶ﬁåﬁ∞):</label>
            <select id="endSurah" onchange="filterQuestions()"></select>
            
            <small style="color:#666; font-size:10px;">Select range to filter database.</small>
        </div>

        <button class="btn-blue" style="margin-top:10px;" onclick="startNewStudent()">üë§ Start New Student</button>
    </div>

    <div class="panel-box">
        <h2>3. ﬁéﬁ∞ﬁÉﬁ®ﬁëﬁ∞ ﬁÜﬁÆﬁÇﬁ∞ﬁìﬁ∞ﬁÉﬁØﬁçﬁ∞ (Grid)</h2>
        <div style="display:flex; justify-content:space-between; color:#aaa; font-size:11px; margin-bottom:5px;">
            <span id="poolCount">Pool: 0</span>
            <span id="activeQCount">Selected: 0</span>
        </div>
        <button class="btn-green" onclick="shuffleGrid()">üîÑ Shuffle Grid (Apply Filters)</button>
        <button class="btn-blue" onclick="sendToScreen()">‚ñ∂ Send to Screens</button>
    </div>

    <div class="panel-box">
        <h2>4. ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁ©ﬁÇﬁ∞ﬁåﬁ¶ﬁáﬁ∞ (Windows)</h2>
        <div style="display:flex; gap:5px;">
            <button onclick="openStudentWindow()">üéì Student View</button>
            <button onclick="openJudgeWindow()">‚öñÔ∏è Judge View</button>
        </div>
        <button class="btn-red" onclick="resetAll()">‚ö†Ô∏è Reset System</button>
    </div>

    <div class="panel-box">
        <h2>5. ﬁÇﬁ¶ﬁåﬁ©ﬁñﬁß (Results)</h2>
        <div id="judgeStatus" style="background:#000; padding:5px; font-size:12px; color:#aaa; border:1px solid #333; margin-bottom:5px;">
            Waiting for scores...
        </div>
        <button class="btn-green" onclick="saveFinalScore()">üíæ Save Result</button>
        <button class="btn-blue" onclick="exportResults()">üì• Export CSV</button>
    </div>
</div>

<div class="main-view">
    <div class="top-header">
        <div style="font-weight:bold; color:#fff;">LIVE MONITOR</div>
        <div id="sessionInfo" style="color:#aaa; font-size:14px;">No Active Session</div>
        <div class="status-badge" id="appStatus">IDLE</div>
    </div>

    <div id="gridContainer"></div>

    <div id="previewArea">
        <h1 id="qDetails">Question Preview</h1>
        <img id="previewImg" src="">
        <div id="previewText"></div>

        <button onclick="nextQuestion()" style="width:200px; margin-top:20px; font-size:18px;" class="btn-green">Next Question ‚è©</button>
    </div>
</div>

<script>
    // --- APP STATE ---
    const state = {
        mode: 'image', // 'image' or 'text'
        imagePool: [],    
        textPool: [],     
        filteredPool: [], 
        images: {},       
        
        // Session
        gridMapping: {},    
        takenBoxes: [],     
        selectedQIDs: [],   
        activeQIndex: -1,   
        
        // Student
        student: { name: "", id: "", branch: "", group: "" },
        
        // Windows
        winStudent: null,
        winJudges: [],
        
        // Results
        liveScores: {},
        savedResults: []
    };

    // --- SURAH DATA FOR DROPDOWNS ---
    const suraNames = [
        "Al-Fatiha", "Al-Baqarah", "Ali 'Imran", "An-Nisa", "Al-Ma'idah", "Al-An'am", "Al-A'raf", "Al-Anfal", "At-Tawbah", "Yunus",
        "Hud", "Yusuf", "Ar-Ra'd", "Ibrahim", "Al-Hijr", "An-Nahl", "Al-Isra", "Al-Kahf", "Maryam", "Ta-Ha",
        "Al-Anbiya", "Al-Hajj", "Al-Mu'minun", "An-Nur", "Al-Furqan", "Ash-Shu'ara", "An-Naml", "Al-Qasas", "Al-Ankabut", "Ar-Rum",
        "Luqman", "As-Sajdah", "Al-Ahzab", "Saba", "Fatir", "Ya-Sin", "As-Saffat", "Sad", "Az-Zumar", "Ghafir",
        "Fussilat", "Ash-Shura", "Az-Zukhruf", "Ad-Dukhan", "Al-Jathiyah", "Al-Ahqaf", "Muhammad", "Al-Fath", "Al-Hujurat", "Qaf",
        "Adh-Dhariyat", "At-Tur", "An-Najm", "Al-Qamar", "Ar-Rahman", "Al-Waqi'ah", "Al-Hadid", "Al-Mujadila", "Al-Hashr", "Al-Mumtahanah",
        "As-Saff", "Al-Jumu'ah", "Al-Munafiqun", "At-Taghabun", "At-Talaq", "At-Tahrim", "Al-Mulk", "Al-Qalam", "Al-Haqqah", "Al-Ma'arij",
        "Nuh", "Al-Jinn", "Al-Muzzammil", "Al-Muddaththir", "Al-Qiyamah", "Al-Insan", "Al-Mursalat", "An-Naba", "An-Nazi'at", "Abasa",
        "At-Takwir", "Al-Infitar", "Al-Mutaffifin", "Al-Inshiqaq", "Al-Buruj", "At-Tariq", "Al-A'la", "Al-Ghashiyah", "Al-Fajr", "Al-Balad",
        "Ash-Shams", "Al-Layl", "Ad-Duhaa", "Ash-Sharh", "At-Tin", "Al-Alaq", "Al-Qadr", "Al-Bayyinah", "Az-Zalzalah", "Al-Adiyat",
        "Al-Qari'ah", "At-Takathur", "Al-Asr", "Al-Humazah", "Al-Fil", "Quraysh", "Al-Ma'un", "Al-Kawthar", "Al-Kafirun", "An-Nasr",
        "Al-Masad", "Al-Ikhlas", "Al-Falaq", "An-Nas"
    ];

    // --- INITIALIZATION ---
    window.onload = function() {
        populateSurahDropdowns();
    };

    function populateSurahDropdowns() {
        const startSel = document.getElementById('startSurah');
        const endSel = document.getElementById('endSurah');
        
        // Add "All" option
        const allOpt = document.createElement('option'); allOpt.value = 0; allOpt.text = "Start (All)";
        startSel.add(allOpt);
        
        const allOpt2 = document.createElement('option'); allOpt2.value = 115; allOpt2.text = "End (All)";
        endSel.add(allOpt2);

        suraNames.forEach((name, idx) => {
            let opt1 = document.createElement('option');
            opt1.value = idx + 1;
            opt1.text = `${idx + 1}. ${name}`;
            startSel.add(opt1);

            let opt2 = document.createElement('option');
            opt2.value = idx + 1;
            opt2.text = `${idx + 1}. ${name}`;
            endSel.add(opt2);
        });

        // Set defaults
        startSel.value = 0; 
        endSel.value = 115;
    }

    // --- 1. SETUP & MODE ---
    function toggleMode() {
        state.mode = document.getElementById('qMode').value;
        const isImg = state.mode === 'image';
        
        document.getElementById('imgInputs').style.display = isImg ? 'block' : 'none';
        document.getElementById('textInputs').style.display = isImg ? 'none' : 'block';
        
        document.getElementById('dbStatus').innerText = `Switched to ${state.mode.toUpperCase()} Mode.`;
        filterQuestions(); 
    }

    function switchTextTab(tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        if (tab === 'auto') {
            document.querySelector('#textInputs button:nth-child(1)').classList.add('active');
            document.getElementById('tab-auto').classList.add('active');
        } else {
            document.querySelector('#textInputs button:nth-child(2)').classList.add('active');
            document.getElementById('tab-manual').classList.add('active');
        }
    }

    // --- CSV LOADER ---
    function loadCSV(input, type) {
        const r = new FileReader();
        r.onload = e => {
            const rows = e.target.result.split('\n');
            const tempPool = [];
            
            rows.slice(1).forEach(row => {
                const c = row.split(',');
                if(c.length > 1) {
                    // Try to extract Surah ID if possible from manual CSV, else default to 0
                    const sId = parseInt(c[2]) || 0; // Assuming Col 3 is Surah ID or name
                    const obj = {
                        id: c[0].trim(),
                        type: type,
                        content: c[1].trim(), 
                        surah: c[2] ? c[2].trim() : "",
                        ayah: c[3] ? c[3].trim() : "",
                        branch: c[4] ? c[4].trim() : "All",
                        group: c[5] ? c[5].trim() : "All",
                        surahIdx: sId // Important for filter
                    };
                    tempPool.push(obj);
                }
            });

            if(type === 'image') state.imagePool = tempPool;
            else state.textPool = tempPool;

            document.getElementById('dbStatus').innerText = `${type.toUpperCase()} Data Loaded: ${tempPool.length} records.`;
            filterQuestions();
        };
        r.readAsText(input.files[0]);
    }

    // --- QURAN GENERATOR ---
    function processQuranRawFile() {
        const fileInput = document.getElementById('quranRawFile');
        if (!fileInput.files.length) {
            alert("Please select the 'quran-uthmani.txt' file first!");
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            generateQuestionsFromRaw(e.target.result);
        };
        reader.readAsText(fileInput.files[0]);
    }

    function generateQuestionsFromRaw(text) {
        const lines = text.split('\n');
        const quranData = [];
        
        lines.forEach(line => {
            const parts = line.split('|');
            if (parts.length >= 3) {
                quranData.push({
                    sura: parseInt(parts[0]),
                    ayah: parseInt(parts[1]),
                    text: parts.slice(2).join('|').trim()
                });
            }
        });

        if (quranData.length === 0) return alert("Invalid File Format.");

        const minV = parseInt(document.getElementById('genMin').value);
        const maxV = parseInt(document.getElementById('genMax').value);
        const targetCount = parseInt(document.getElementById('genTotal').value);
        
        const newPool = [];
        const totalVerses = quranData.length;

        for (let i = 0; i < targetCount; i++) {
            const qLength = Math.floor(Math.random() * (maxV - minV + 1)) + minV;
            const startIndex = Math.floor(Math.random() * (totalVerses - qLength));
            
            let passageArr = [];
            let startVerseObj = quranData[startIndex];
            let endVerseObj = quranData[startIndex + qLength - 1];

            for (let j = 0; j < qLength; j++) {
                passageArr.push(quranData[startIndex + j].text + " (" + quranData[startIndex + j].ayah + ")");
            }
            
            newPool.push({
                id: (i + 1).toString(),
                type: 'text',
                content: passageArr.join(" "),
                surah: suraNames[startVerseObj.sura - 1],
                ayah: startVerseObj.ayah + " - " + endVerseObj.ayah,
                branch: "All",
                group: "All",
                surahIdx: startVerseObj.sura // Critical for range filtering
            });
        }

        state.textPool = newPool;
        document.getElementById('dbStatus').innerText = `Generated ${newPool.length} Questions from Quran!`;
        filterQuestions();
    }

    function loadImages(input) {
        let c = 0;
        for(let f of input.files) {
            state.images[f.name.toLowerCase()] = URL.createObjectURL(f);
            c++;
        }
        document.getElementById('dbStatus').innerText += ` | Images: ${c}`;
    }

    // --- 2. FILTER & GRID LOGIC ---
    function filterQuestions() {
        const branch = document.getElementById('stdBranch').value;
        const group = document.getElementById('stdGroup').value;
        
        // Get Surah Range
        const startS = parseInt(document.getElementById('startSurah').value) || 0;
        const endS = parseInt(document.getElementById('endSurah').value) || 115;

        const source = state.mode === 'image' ? state.imagePool : state.textPool;

        state.filteredPool = source.filter(q => {
            // 1. Branch/Age Match
            const bMatch = (branch === "All") || (q.branch === branch) || (q.branch === "All");
            const gMatch = (group === "All") || (q.group === group) || (q.group === "All");
            
            // 2. Surah Range Match
            // Note: If data doesn't have surahIdx (e.g., random images), we assume it matches unless strictly mapped.
            // For Auto-Gen text, surahIdx is set.
            let rangeMatch = true;
            if(q.surahIdx) {
                rangeMatch = (q.surahIdx >= startS && q.surahIdx <= endS);
            }

            return bMatch && gMatch && rangeMatch;
        });

        document.getElementById('poolCount').innerText = `Pool: ${state.filteredPool.length}`;
        shuffleGrid(); 
    }

    function shuffleGrid() {
        if(state.filteredPool.length === 0) {
            document.getElementById('gridContainer').innerHTML = "<h3 style='color:red; text-align:center;'>No questions found for this range!</h3>";
            return;
        }

        state.gridMapping = {};
        state.takenBoxes = [];
        let poolCopy = [...state.filteredPool];

        for(let i=1; i<=20; i++) {
            if(poolCopy.length === 0) poolCopy = [...state.filteredPool]; 
            const r = Math.floor(Math.random() * poolCopy.length);
            state.gridMapping[i] = poolCopy[r];
            poolCopy.splice(r, 1);
        }

        renderGrid();
        syncWindows();
    }

    function renderGrid() {
        const c = document.getElementById('gridContainer');
        c.innerHTML = '';
        document.getElementById('gridContainer').style.display = 'grid';
        document.getElementById('previewArea').style.display = 'none';
        document.getElementById('appStatus').innerText = "SELECTION";

        for(let i=1; i<=20; i++) {
            const d = document.createElement('div');
            d.className = `grid-box ${state.takenBoxes.includes(i) ? 'taken' : ''}`;
            if(state.selectedQIDs.includes(state.gridMapping[i])) d.classList.add('selected');
            
            d.innerText = i;
            d.onclick = () => selectBox(i);
            c.appendChild(d);
        }
    }

    function selectBox(num) {
        if(state.takenBoxes.includes(num)) return;
        
        const q = state.gridMapping[num];
        state.takenBoxes.push(num);
        state.selectedQIDs.push(q);
        
        document.getElementById('activeQCount').innerText = `Selected: ${state.selectedQIDs.length}`;
        renderGrid();
        syncWindows();
    }

    // --- 3. SESSION MANAGEMENT ---
    function startNewStudent() {
        state.student = {
            name: document.getElementById('stdName').value,
            branch: document.getElementById('stdBranch').value,
            group: document.getElementById('stdGroup').value
        };
        
        if(!state.student.name) return alert("Enter Student Name!");

        state.selectedQIDs = [];
        state.activeQIndex = -1;
        state.liveScores = {};
        state.takenBoxes = [];
        
        document.getElementById('sessionInfo').innerText = `${state.student.name} | ${state.mode.toUpperCase()}`;
        document.getElementById('judgeStatus').innerText = "Waiting for scores...";
        
        filterQuestions();
        syncWindows();
    }

    function sendToScreen() {
        if(state.selectedQIDs.length === 0) return alert("No questions selected!");
        state.activeQIndex = 0;
        updateView();
        syncWindows();
    }

    function nextQuestion() {
        if(state.activeQIndex < state.selectedQIDs.length - 1) {
            state.activeQIndex++;
            updateView();
            syncWindows();
        } else {
            alert("All questions finished!");
            document.getElementById('appStatus').innerText = "FINISHED";
            syncWindows();
        }
    }

    function updateView() {
        document.getElementById('gridContainer').style.display = 'none';
        document.getElementById('previewArea').style.display = 'flex';
        document.getElementById('appStatus').innerText = "READING";

        const q = state.selectedQIDs[state.activeQIndex];
        const pImg = document.getElementById('previewImg');
        const pTxt = document.getElementById('previewText');

        if(q.type === 'image') {
            pImg.style.display = 'block';
            pTxt.style.display = 'none';
            pImg.src = state.images[q.content.toLowerCase()] || "";
        } else {
            pImg.style.display = 'none';
            pTxt.style.display = 'block';
            pTxt.innerHTML = q.content;
        }
        
        document.getElementById('qDetails').innerText = `Surah: ${q.surah} | Ayah: ${q.ayah}`;
    }

    // --- 4. JUDGING LOGIC ---
    window.submitJudgeScore = function(jID, score) {
        state.liveScores[jID] = score;
        updateScoreBoard();
    }

    function updateScoreBoard() {
        let txt = "";
        let total = 0, c = 0;
        for(let j in state.liveScores) {
            txt += `${j}: ${state.liveScores[j]} | `;
            total += parseFloat(state.liveScores[j]);
            c++;
        }
        const avg = c > 0 ? (total/c).toFixed(2) : 0;
        document.getElementById('judgeStatus').innerHTML = `<span style="color:#00e676; font-size:14px;">${txt} AVG: ${avg}</span>`;
    }

    function saveFinalScore() {
        let total = 0, c = 0;
        for(let j in state.liveScores) { total += parseFloat(state.liveScores[j]); c++; }
        const avg = c > 0 ? (total/c).toFixed(2) : 0;

        state.savedResults.push({
            ...state.student,
            final: avg,
            mode: state.mode
        });
        alert(`Saved! Score: ${avg}`);
    }

    function exportResults() {
        let csv = "Name,Branch,Group,Mode,FinalScore\n";
        state.savedResults.forEach(r => {
            csv += `"${r.name}","${r.branch}","${r.group}","${r.mode}","${r.final}"\n`;
        });
        const blob = new Blob([csv], {type:'text/csv'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "Rasfahi_Results.csv";
        a.click();
    }
    
    function resetAll() {
        if(confirm("Reset System?")) location.reload();
    }

    // --- 5. SYNCING ---
    function syncWindows() {
        const q = (state.activeQIndex > -1) ? state.selectedQIDs[state.activeQIndex] : null;
        let displayContent = null;
        
        if(q) {
            if(q.type === 'image') displayContent = state.images[q.content.toLowerCase()];
            else displayContent = q.content;
        }

        const packet = {
            student: state.student,
            phase: document.getElementById('appStatus').innerText, 
            boxes: state.takenBoxes,
            activeQ: q,
            contentType: q ? q.type : null,
            content: displayContent
        };

        if(state.winStudent && !state.winStudent.closed) state.winStudent.update(packet);
        state.winJudges.forEach(w => { if(w && !w.closed) w.update(packet); });
    }

    // --- TEMPLATES ---
    
    // 1. STUDENT SCREEN (Active Grid)
    function openStudentWindow() {
        const w = window.open("", "Student", "width=1280,height=720");
        w.document.write(`
            <!DOCTYPE html>
            <html dir="rtl">
            <head>
            <title>Student Screen</title>
            <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@700&display=swap" rel="stylesheet">
            <style>
                body { background:#000; display:flex; justify-content:center; align-items:center; height:100vh; overflow:hidden; margin:0; font-family:'Segoe UI'; }
                
                /* Active Grid Styles */
                .grid { display:grid; grid-template-columns:repeat(5,1fr); gap:20px; width:80%; height:80%; }
                .box { 
                    background:#1a1a1a; border:3px solid #333; color:#555; 
                    display:flex; justify-content:center; align-items:center; 
                    font-size:60px; border-radius:15px; font-weight:bold;
                    transition: all 0.5s;
                }
                /* When a box is taken, it glows slightly then dims */
                .box.taken { background: #330000; color: #600; border-color:#500; opacity:0.6; transform:scale(0.95); }
                
                #qImage { max-height:95vh; max-width:95vw; border:5px solid #D4AF37; display:none; box-shadow:0 0 50px #000; }
                #qText { 
                    display:none; color:#fff; font-family:'Amiri', serif; font-size:70px; 
                    line-height:2.2; text-align:center; max-width:90%; 
                    text-shadow: 0 0 10px rgba(255,255,255,0.3); direction:rtl; 
                }
            </style>
            </head>
            <body>
                <div id="grid" class="grid"></div>
                <img id="qImage">
                <div id="qText"></div>

                <script>
                    const g = document.getElementById('grid');
                    // Create Grid
                    for(let i=1; i<=20; i++) {
                        let b = document.createElement('div'); b.className='box'; b.id='b'+i; b.innerText=i; g.appendChild(b);
                    }

                    window.update = function(d) {
                        const imgEl = document.getElementById('qImage');
                        const txtEl = document.getElementById('qText');
                        const gridEl = document.getElementById('grid');

                        if(d.phase === 'SELECTION' || d.phase === 'IDLE') {
                            imgEl.style.display = 'none';
                            txtEl.style.display = 'none';
                            gridEl.style.display = 'grid';
                            
                            // Update Grid State Live
                            for(let i=1; i<=20; i++) {
                                let b = document.getElementById('b'+i);
                                if(d.boxes.includes(i)) {
                                    b.classList.add('taken');
                                } else {
                                    b.classList.remove('taken');
                                }
                            }
                        } else if(d.phase === 'READING' && d.content) {
                            gridEl.style.display = 'none';
                            if(d.contentType === 'image') {
                                imgEl.src = d.content;
                                imgEl.style.display = 'block';
                                txtEl.style.display = 'none';
                            } else {
                                txtEl.innerHTML = d.content;
                                txtEl.style.display = 'block';
                                imgEl.style.display = 'none';
                            }
                        }
                    }
                <\/script>
            </body>
            </html>
        `);
        state.winStudent = w;
    }

    // 2. JUDGE SCREEN (Split View + 15 Cats + Columnar Deductions)
    function openJudgeWindow() {
        const id = "Judge_" + (state.winJudges.length + 1);
        const w = window.open("", id, "width=1000,height=900");
        w.document.write(`
            <!DOCTYPE html>
            <html dir="rtl">
            <head>
            <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Noto+Sans+Thaana:wght@400;700&display=swap" rel="stylesheet">
            <style>
                body { margin:0; display:flex; flex-direction:column; height:100vh; font-family:'Noto Sans Thaana'; background:#eee; }
                
                /* TOP: VIEW AREA */
                #viewArea { height: 35%; background: #000; display:flex; justify-content:center; align-items:center; border-bottom:5px solid #D4AF37; overflow:hidden; position:relative; }
                #jImg { max-height:100%; max-width:90%; display:none; }
                #jTxt { color:#fff; font-family:'Amiri'; font-size:28px; text-align:center; display:none; padding:20px; line-height:1.6; }
                #waiting { color:#666; font-size:20px; }

                /* BOTTOM: SCORING AREA */
                #scoreArea { flex: 1; padding: 10px; overflow-y:auto; background:#f4f4f4; }
                
                table { width:100%; border-collapse:collapse; background:#fff; font-size:12px; box-shadow:0 0 10px rgba(0,0,0,0.1); }
                th { background:#222; color:#D4AF37; padding:5px; position:sticky; top:0; z-index:10; }
                td { border:1px solid #ccc; padding:2px 5px; text-align:center; vertical-align:middle; }
                
                .cat-name { text-align:right; padding-right:10px; font-weight:bold; width:200px; font-size:13px; }
                
                /* BUTTONS */
                .deduct-btn { 
                    width: 45px; height: 35px; margin: 1px; border:1px solid #999; 
                    background: #fff; cursor:pointer; font-weight:bold; border-radius:3px;
                    transition: 0.1s; color: #c00;
                }
                .deduct-btn:hover { background:#ffe6e6; }
                .deduct-btn:active { background:#ff0000; color:#fff; }
                
                .reset-btn { background:#eee; border:1px solid #ccc; width:30px; }

                .score-display { font-size:16px; font-weight:bold; color:#004d00; width:50px; }
                
                #footer { 
                    height: 60px; background: #222; color:#fff; display:flex; 
                    justify-content:space-between; align-items:center; padding:0 20px; 
                    border-top:2px solid #D4AF37;
                }
                .submit-btn { background: #006400; color:#fff; border:none; padding:10px 30px; font-size:18px; cursor:pointer; font-weight:bold; border-radius:5px; }
                .submit-btn:disabled { background:#555; }
            </style>
            </head>
            <body>
                <div id="viewArea">
                    <div id="waiting">Waiting for question...</div>
                    <img id="jImg">
                    <div id="jTxt"></div>
                </div>

                <div id="scoreArea">
                    <table id="rubricTable">
                        <thead>
                            <tr>
                                <th>Category (15)</th>
                                <th>0.25</th>
                                <th>0.50</th>
                                <th>0.75</th>
                                <th>1.00</th>
                                <th>2.00</th>
                                <th>Reset</th>
                                <th>Deducted</th>
                            </tr>
                        </thead>
                        <tbody id="tbody"></tbody>
                    </table>
                </div>

                <div id="footer">
                    <div id="studentInfo">Student: -</div>
                    <div style="font-size:24px;">Total Score: <span id="finalScore" style="color:#D4AF37;">100.00</span></div>
                    <button class="submit-btn" onclick="submitScore()">SUBMIT</button>
                </div>

                <script>
                    // Config
                    const categories = [
                        "Hifz - Memory 1", "Hifz - Memory 2", "Hifz - Memory 3", "Hifz - Fluency", "Hifz - Hesitation",
                        "Tajweed - Ghunna", "Tajweed - Madd", "Tajweed - Makharij", "Tajweed - Sifaat", "Tajweed - Qalqala",
                        "Performance - Voice", "Performance - Breath", "Stop/Start", "Adab/Etiquette", "General"
                    ];
                    
                    // State
                    let deductions = new Array(15).fill(0);
                    const START_SCORE = 100;

                    // Init Table
                    const tbody = document.getElementById('tbody');
                    categories.forEach((cat, i) => {
                        let tr = document.createElement('tr');
                        
                        // Category Name
                        tr.innerHTML = \`<td class="cat-name">\${i+1}. \${cat}</td>\`;
                        
                        // Buttons (0.25, 0.5, 0.75, 1, 2)
                        const vals = [0.25, 0.5, 0.75, 1, 2];
                        vals.forEach(v => {
                            tr.innerHTML += \`<td><button class="deduct-btn" onclick="addDeduct(\${i}, \${v})">-\${v}</button></td>\`;
                        });
                        
                        // Reset & Display
                        tr.innerHTML += \`
                            <td><button class="deduct-btn reset-btn" onclick="resetRow(\${i})">‚Ü∫</button></td>
                            <td class="score-display" id="d_\${i}">0</td>
                        \`;
                        tbody.appendChild(tr);
                    });

                    // Logic
                    function addDeduct(idx, val) {
                        deductions[idx] += val;
                        updateUI(idx);
                    }
                    
                    function resetRow(idx) {
                        deductions[idx] = 0;
                        updateUI(idx);
                    }

                    function updateUI(idx) {
                        // Update individual row display
                        document.getElementById('d_'+idx).innerText = deductions[idx].toFixed(2);
                        document.getElementById('d_'+idx).style.color = deductions[idx] > 0 ? 'red' : 'green';
                        
                        // Update Total
                        let totalDeduct = deductions.reduce((a, b) => a + b, 0);
                        let final = Math.max(0, START_SCORE - totalDeduct);
                        document.getElementById('finalScore').innerText = final.toFixed(2);
                    }

                    function submitScore() {
                        let score = document.getElementById('finalScore').innerText;
                        window.opener.submitJudgeScore("${id}", score);
                        document.querySelector('.submit-btn').innerText = "SENT ‚úî";
                        document.querySelector('.submit-btn').disabled = true;
                    }

                    // Sync with Main
                    window.update = function(d) {
                        document.getElementById('studentInfo').innerText = d.student.name ? d.student.name : "Waiting...";
                        
                        // Handle Question Display
                        const jImg = document.getElementById('jImg');
                        const jTxt = document.getElementById('jTxt');
                        const wait = document.getElementById('waiting');

                        if(d.phase === 'READING' && d.content) {
                            wait.style.display = 'none';
                            if(d.contentType === 'image') {
                                jImg.src = d.content; jImg.style.display = 'block'; jTxt.style.display = 'none';
                            } else {
                                jTxt.innerHTML = d.content; jTxt.style.display = 'block'; jImg.style.display = 'none';
                            }
                        } else {
                            // Reset view if not reading
                            jImg.style.display = 'none'; jTxt.style.display = 'none'; wait.style.display = 'block';
                            wait.innerText = d.phase === 'SELECTION' ? "Selection in progress..." : "Waiting...";
                        }
                    }
                <\/script>
            </body>
            </html>
        `);
        state.winJudges.push(w);
    }
</script>
</body>
</html>
